<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>订单合约</title>
	<link href="../../../css/font-awesome.min.css" rel="stylesheet">
	<script src="../../../js/jquery.js" type="text/javascript"></script>
	<!-- DevExtreme themes -->
	<link rel="stylesheet" href="../../../devexpresslibrary/css/dx.common.css">
	<link rel="stylesheet" href="../../../devexpresslibrary/css/dx.light.css">
	<link rel="stylesheet" type="text/css" href="../../../css/same.css" />
	<link rel="stylesheet" type="text/css" href="../../../css/comboselect.css" />
	<link rel="stylesheet" type="text/css" href="../../../css/demo.css" />
	<link rel="stylesheet" href="../../../plugins/layui/css/layui.css">
</head>
<style type="text/css">
	table thead td {
		padding: 0;
		border-left: 1px solid #CAD3DA;
		background: #DFEBFB;
	}

	.dx-datagrid-text-content {
		color: grey;
	}

	.clearfix:after {
		content: '.';
		height: 0;
		display: block;
		clear: both;
	}

	tbody tr:not(:last-child):hover {
		background-color: rgba(137, 207, 240, .6) !important;
	}

	.dx-datagrid-rowsview .dx-selection.dx-row>td {
		background-color: yellow !important;
	}

	colgroup>col:first-child {
		width: 45px !important;
	}

	.dx-col-fixed:nth-child(1) {
		width: 45px !important;
	}

	.M-box2 {
		display: inline-block;
		padding: 0 15px;
		height: 28px;
		color: #333;
		font-size: 12px;
		margin-top: 6px;
	}

	.M-box2 a {
		margin-left: 15px;
		padding: 0 15px;
		text-decoration: none;
		background-color: #ffffff;
		color: #000000;
	}

	.M-box2 .active {
		margin-left: 5px;
		padding: 0 15px;
		color: #ffffff;
		width: 100%;
		height: 100%;
		background-color: #2D89DD;
		border: 1px solid #e2e2e2;
	}

	.jump-ipt {
		float: none;
		margin-left: 5px;
		margin-left: 11px;
		width: 60px;
		border: 1px solid #e6e6e6;
		height: 20px !important;
	}

	.dx-data-row,
	.dx-column-lines:not(:first-child)>td:nth-child(2) {
		cursor: pointer;
	}

	.dx-widget {
		font-size: 9pt !important;
		line-height: 17px;
	}

	.option>.dx-selectbox {
		display: inline-block;
		vertical-align: middle;
	}

	.layui-input {
		color: #000000;
	}

	.producecount {
		background-color: rgb(211, 236, 198) !important;
	}

	.referprice {
		background-color: rgb(254, 233, 208) !important;
	}

	.realcost {
		background-color: rgb(225, 213, 194) !important;
	}

	.subtotal {
		background-color: rgb(255, 200, 200) !important;
	}

	.dx-data-row,
	.dx-column-lines>td:nth-child(2) {
		cursor: pointer;
	}

	.totalInfo {
		width: 100px;
		height: 20px;
		float: left;
		margin-top: 12px;
	}

	.fl {
		float: left;
	}

	.fr {
		float: right;
	}

	/* input, */
	section,
	button,
	select {
		border-radius: 2px;
	}

	.addOrder {
		font-family: "PingFang SC" !important;
		font-size: 9pt !important;
		color: #232323 !important;
		margin: 0 20px;
		margin-top: 30px;

	}

	.layui-input-block,
	.layui-input-block input,
	.layui-input-block label,
	.layui-input-block select {
		line-height: 28px !important;
		height: 28px !important;
		min-height: 28px !important;
	}

	.layui-form-label {
		line-height: 28px !important;
	}



	.layui-input-block select {
		cursor: pointer;
	}

	.layui-input-block option {
		cursor: pointer;
	}

	.addOrder .layui-table td,
	.layui-table th {
		font-size: 9pt !important;
	}

	.btns {
		margin-bottom: 12px;
		position: absolute;
		right: 20px;
		top: 114px;
	}


	.btns button {
		cursor: pointer;
		border: none;
		width: 90px;
		height: 28px;
		line-height: 28px;
		border-radius: 2px;
		background-color: #2D89DD;
		color: #FFFFFF;
	}



	.layui-input-block {
		min-height: 22px;
	}

	.two_inputs {
		padding-top: 12px;
		background-color: #EFF5FF;
		margin-top: 50px;
		padding-bottom: 5px;
	}

	.moreAction {
		width: 90px !important;
	}

	.action {
		width: 88px !important;
		right: 0;
		background-color: #fff !important;
	}

	.show,
	.hide {
		padding: 1px 10px;
		background-color: #1E9FFF;
		text-align: center;
		position: absolute;
		top: 138px;
		right: 50%;
		cursor: pointer;
	}

	.hide {
		display: none;
	}

	.title {
		margin-top: 12px;
	}


	div.cs_result_area div.pagination li {
		margin: 0 5px !important;
	}

	.cs_container,
	.cs_container_open .cs_input,
	.cs_result_area {
		width: 250px !important;
	}

	.cs_result_area.shadowDown {
		width: 262px !important;
	}

	.header2 input {
		margin-left: 0px !important;
		font-size: 9pt;

	}

	.fixStyle ul {
		border: 1px solid #ccc;
	}

	.fixStyle ul li {
		float: left;
		padding-left: 6px;
	}

	.layui-inline.selectKung {
		width: 332px !important;
	}

	.hehe {
		margin-top: 10px;
	}

	.dx-button {
		border-color: white !important;
	}

	div#duiyingHeTongId {
		margin-top: 10px;
	}

	.layui-input-inline {
		margin-top: 10px;
	}
    
	.dx-button-content {
		width: 87px !important;
		height: 23px;

	}

	.fixStyle ul li {
		float: left;
		padding-left: 6px;
	}

	.yewuyuan {
		padding-left: 10px;
	}

	#gridContainer {
		margin-top: 10px;
	}


	button#examine {

		padding-left: 20px;
		line-height: 4px;

	}

	.layui-inline {
		margin-top: -7px;
	}

	.zhidanren {
		padding-left: 20px;
	}

	.dx-revert-button.dx-button.dx-button-normal.dx-widget.dx-button-has-icon {
		padding-top: 10px !important;
	}

	.dx-datagrid-revert-tooltip .dx-revert-button .dx-icon {

		position: absolute;
		left: 35px;
		top: 6px;
	}

	#del:hover a>.dx-button-content {
		background-color: #ACD7FF;
	}

	.dx-datagrid-header-panel {
		display: none;
	}
	
	
</style>

<body id="idnum">
	<div class="addOrder">
		<div class="layui-tab">
			<div class="header1">
				<p style="color: #232323 !important;font-size: 24px !important;margin-top: 0px;">
					<span class="orderLeiXing">订货合约</span><img class="dsh" src="../../../image/dsh.png" alt="" /><img class="yzf" src="../../../image/yzf.png"
					 alt="" /> <img class="ysh" src="../../../image/ysh.png" alt="" /></p>
				<ul>
					<li>
						<label class="layui-form-label">记账日期</label>
						<div class="layui-input-block">
							<input name="title" lay-verify="title" placeholder="" autocomplete="off" id="operationdate" class="layui-input operationdate"
							 type="text">
						</div>
					</li>
					<li>
						<label class="layui-form-label">订货日期</label>
						<div class="layui-input-block">
							<input name="title" lay-verify="title" placeholder="" autocomplete="off" id="addOrderDate" class="layui-input oderDate"
							 type="text">
						</div>
					</li>
					<li>
						<label class="layui-form-label">订货单号</label>
						<div class="layui-input-block">
							<input name="title" lay-verify="title" autocomplete="off" placeholder="" class="layui-input orderNum" type="text"
							 readonly="readonly">
						</div>
					</li>
					<li>
						<label class="layui-form-label">自定义单号</label>
						<div class="layui-input-block">
							<input name="title" lay-verify="title" autocomplete="off" class="layui-input orderMynum" type="text" id="orderMynumId">
						</div>
					</li>
				</ul>
			</div>
			<div class="header2">
				<div class="btns">
					<button class="layui-btn addProductInfo">自动匹配</button>
					<button class="layui-btn addProduct">添加产品</button>
					<button class="layui-btn addDianJiEvent preserve" data-type="preserve" lay-event='preserve'>保存</button>
					<button class="layui-btn addDianJiEvent examine" data-type="examine" lay-event='examine' id="examine" style="display: none;">审核</button>
					<button class="layui-btn noExamine" data-type="noExamine" lay-event='noExamine' id="noExamine" style="display: none;">反审核</button>
					<button class="layui-btn moreAction">更多操作</button>
					<ul class="action">
						<li id="del">
							<a class="addDianJiEvent del" data-type="del" lay-event='del' id="gridDeleteSelected">删除产品</a>
						</li>
						<li id="modelDownId">
							<a class="modelDown" data-type="modelDown" lay-event='modelDown'>模板下载</a>
						</li>
						<li id="modelImportId">
							<a class="modelup">
								<button type="button" class="layui-btn" id="bjdUpload" style="width: 90px;margin-left:0px;background-color: transparent;height: 25px;line-height: 25px;color: #232323;">导入明细</button></a>
						</li>
						<li id="yijianbijiaId">
							<a class="addDianJiEvent yijianbijia" data-type="yijianbijia" lay-event='yijianbijia'>引入价格</a>
						</li>
						<li id="print" style="display: none;">
							<a class="print" data-type="printData" lay-event='printData'>打印单据</a>
						</li>
						<li id="printSetting" style="display: none;">
							<a class="printSetting" data-type="printData" lay-event='printData'>打印设置</a>
						</li>
						<li id="abolish" style="display: none;">
							<a class="abolish" data-type="abolish" lay-event='abolish'>作废单据</a>
						</li>
						<li id="xiugainotes" style="display: none;">
							<a class="xiugainotes" data-type="xiugainotes" lay-event='xiugainotes'>修改备注</a>
						</li>
					</ul>
				</div>

				<div class="two_inputs">
					<div style="width: 100%;height: auto;">
						<div class="layui-inline selectKung ">
							<label class="layui-form-label">往来单位</label>
							<div id="unitId" class="hehe">
								<input name="title" data-id='' lay-verify="title" value="" autocomplete="off" id="unit" class="layui-input unit"
								 type="text" style="width: 250px;height: 28px;line-height: 28px;">
							</div>
						</div>

						<div class="layui-inline selectKung" class="hehe">
							<label class="layui-form-label">对应合同</label>
							<div id="duiyingHeTongId">
								<input name="title" data-id='' lay-verify="title" value="" autocomplete="off" id="contract_id" class="layui-input contract_id"
								 type="text" style="width: 250px;height: 28px;line-height: 28px;">
							</div>
						</div>

						<div class="layui-inline selectKung hehe" style="display: none;" id="discountId">
							<label class="layui-form-label">折　　扣</label>
							<div style="display: inline-block;">
								<input name="title" data-id='' lay-verify="title" value="" autocomplete="off" id="discount" class="layui-input discount"
								 type="text" style="width: 150px !important;height: 28px;line-height: 28px;">
							</div>
							<div style="display: inline-block;">
								%
							</div>
						</div>

					</div>

					<div style="width: 100%;height: auto;" class="customstyle">
						<div class="layui-inline selectKung yewuyuan">
							<label class="layui-form-label">业务员</label>
							<div style="margin-top: 10px;">
								<input id="salesman" lay-verify="title" value="" autocomplete="off" class="layui-input salesman" type="text"
								 style="width: 250px;height: 26px;line-height: 26px;">
							</div>
						</div>

						<div class="layui-inline selectKung">
							<label class="layui-form-label zhidanren">制单人</label>
							<div class="layui-input-inline">
								<input name="title" lay-verify="title" autocomplete="off" class="layui-input orderMaker" type="text" readonly="readonly"
								 style="width: 250px !important;">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label">备　　注</label>
							<div class="layui-input-inline">
								<input name="title" lay-verify="title" autocomplete="off" class="layui-input ordeNotes" type="text" style="width: 345px;margin-left: 0px;">
							</div>
						</div>

					</div>
				</div>
			</div>
			<p class="title">订货详情</p>
			<table id="addOrder" lay-filter="demo">
				<div class="demo-container">
					<div id="gridContainer"></div>
				</div>
			</table>
			<div class="footer .clearfix">
				<div class="totalInfo fl"></div>
				<div class="M-box2 fl"></div>
			</div>
		</div>

		<iframe src="" frameborder="0" id="pdfContainer" name="pdfContainer" style="display: none;"></iframe>

</body>
<!-- DevExtreme library -->
<script  async src="../../../devexpresslibrary/js/dx.all.js"></script>

<!-- 分页插件 -->
<script src="../../../devexpresslibrary/js/pagination/jquery.pagination.js"></script>
<script src="../../../devexpresslibrary/js/pagination/highlight.min.js"></script>

<!-- layui插件 -->
<script src="../../../plugins/layui/layui.js"></script>
<script type="text/javascript" src="../../../js/comboselect.js"></script>
<script type="text/javascript" src="../../../js/b.comboselect.js"></script>

<!-- 本页面功能 -->
<script src="../../../js/public.js"></script>
<script>
	var currentPage = 1;
	var totalInfo = '';
	var limit = 50;
	var count;
	var ordernum;
	var groupcompanyid = localStorage.groupcompanyid;
	var oldData = [];

	layui.use(['table', 'jquery', 'upload', 'laydate'], function () {
		var table = layui.table;
		var $ = layui.jquery;
		var laydate = layui.laydate;
		var upload = layui.upload;
		$('.moreAction').hover(function () {
			$(".action").show();
		}, function () {
			$(".action").hide();
		});
		$('.action').hover(function () {
			$(".action").show();
		}, function () {
			$(".action").hide();
		});

		$(".show").click(function () {
			$(".show").hide();
			$(".hide").show();
			$(".two_inputs").hide();
			$(".title").css("margin-top", "54px");
		});
		$(".hide").click(function () {
			$(".hide").hide();
			$(".show").show();
			$(".two_inputs").show();
			$(".title").css("margin-top", "12px");
		});


		laydate.render({
			elem: "#addOrderDate",
			value: new Date(),
			done: function (value, date, endDate) {
				eventFlag = true;
			}
		})

		laydate.render({
			elem: "#operationdate",
			value: new Date(),
			done: function (value, date, endDate) {
				eventFlag = true;
			}
		})



		ordernum = $(".layui-show", parent.document).attr("lay-item-id");

		if (ordernum.indexOf("xindan")) {

			var jiazaiIndex;
			parent.layer.open({
				type: 3,
				zIndex: parent.layer.zIndex, //重点1
				success: function (layero, index) {
					jiazaiIndex = index;
				}
			});



			ordernum = ordernum.substring(6, ordernum.length);
			initData(ordernum);
		} else {


			$(".orderMaker").val(localStorage.employeeName);
			$(".orderMaker").attr('data-id', localStorage.userId);

		}


		var eventFlag = false;

		//事件监听
		$("input").change(function () {
			eventFlag = true;
		});
		$("select").change(function () {
			eventFlag = true;
		});

		table.on('edit(demo)', function (obj) { //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
			eventFlag = true;
		});







		$("body").delegate("#unitId .cs_over", "mousedown", function () {


			var hetongstr = '<input name="title" data-id="" lay-verify="title" value="" autocomplete="off" id="contract_id" class="layui-input contract_id" type="text" style="width: 250px;height: 28px;line-height: 28px;">';

			$("#duiyingHeTongId").empty();
			$("#duiyingHeTongId").append(hetongstr);
			
			getduiyingHeTong($(this).attr("pkey"), 1);



		})



		function staffList() {
			$.ajax({
				type: "get",
				url: localStorage.serIp + "/WebGetEmployeeDropDownList?jsoncallback=?",
				async: true,
				dataType: 'jsonp',
				data: {
					"userId": localStorage.userId,
					"userPw": localStorage.userPw,
					'database': localStorage.database,
					'groupCompanyId': localStorage.groupcompanyid
				},
				success: function (res) {
					var data = JSON.parse(res);
					$('#salesman').bComboSelect({
						showField: 'employeename',
						keyField: 'employeesid',
						data: data
					});
				}
			});
		}

		stockList();
		staffList();
		var GetProduceflag = true;
		//初始化页面数据
		function initData(currentPage, limit, totalInfo) {
			$.ajax({
				type: "get",
				url: localStorage.serIp + "/WebGetOrderMasterInfoByOrderNum?jsoncallback=?",
				dataType: "jsonp",
				async: true,
				data: {
					'userId': localStorage.userId,
					'userPw': localStorage.userPw,
					'groupCompanyId': localStorage.groupcompanyid,
					'database': localStorage.database,
					'orderNum': ordernum
				},
				success: function (res) {
					var data = JSON.parse(res);
					$("#addOrderDate").val(data[0].ordertime);
					$(".orderNum").val(data[0].ordernum);
					$(".orderMynum").val(data[0].mynum);
					$(".unit").val(data[0].companyname);
					$(".unit").attr('data-id', data[0].companyid);
					$(".salesman").val(data[0].agentname);
					$(".salesman").attr('data-id', data[0].agent);
					if (typeof (data[0].operationdate) !== "undefined") {
						$("#operationdate").val(data[0].operationdate);
					}
					$(".contract_id").val(data[0].contract_name);
					$(".contract_id").attr('data-id', data[0].contractid);

					getduiyingHeTong(data[0].companyid, 1);
					$(".orderMaker").val(data[0].operatorname);
					$(".orderMaker").attr('data-id', data[0].operatorsid);
       
					$(".ordeNotes").val(data[0].nomo);


					oprateStatus(data[0].checkstate)


					orderData(ordernum);


				}
			});

		}



		getunit(311);


		/**
		 * 状态判断
		 * @param {Object} states
		 */
		function oprateStatus(states) {
			eventFlag = false;
			switch (states) {
				case 0: //待审核
					$(".dsh").css("display", 'inline-block');
					$(".ysh").css("display", 'none');
					$(".yzf").css("display", 'none');
					$("input").removeAttr('disabled');
					$(".addProduct,#yijianbijiaId").css("display", "inline-block");
					$(".preserve").css("display", "inline-block");
					$(".scanCode,#modelDownId,#modelImportId").css("display", "inline-block");

					$("#print").css("display", "none");
					$("#noExamine").css("display", "none");
					$("#abolish").css("display", "inline-block");
					$("#examine").css("display", "inline-block");
					$("#del").css("display", "inline-block");
					$('.addProductInfo').css('display', 'inline-block');
					$("#xiugainotes").hide();
					break;
				case 1:		//已审核						
					$(".ysh").css("display", 'inline-block');
					$(".dsh").css("display", "none");
					$(".yzf").css("display", 'none');

					$("#salesman").attr('disabled', 'disabled');
					$(".orderMaker").attr('disabled', 'disabled');
					$(".ordeNotes").attr('disabled', 'disabled');
					$("#unit").attr('disabled', 'disabled');
					$("#contract_id").attr('disabled', 'disabled');
					$(".salesman").attr('disabled', 'disabled');

					$("#xiugainotes").show();


					$(".addProduct,#yijianbijiaId").css("display", "none");
					$(".preserve").css("display", "none");
					$(".scanCode,#modelDownId,#modelImportId").css("display", "none");
					$("#print").css("display", "inline-block");
					$("#printSetting").css("display", "inline-block");
					$("#noExamine").css("display", "inline-block");
					$("#abolish").css("display", "none");
					$("#examine").css("display", "none");
					$("#del").css("display", "none");
					$('.addProductInfo').css('display', 'none');
					break;
				case 2:  //已作废
					$(".ysh").css("display", 'none');
					$(".dsh").css("display", "none");
					$(".yzf").css("display", 'inline-block');

					$("input").attr('disabled', 'disabled');

					$(".addProduct,#yijianbijiaId").css("display", "none");
					$(".preserve").css("display", "none");
					$(".scanCode,#modelDownId,#modelImportId").css("display", "none");

					$(".moreAction").css("display", "none");
					$("#xiugainotes").hide();

					break;
			}
		}

		function orderData(currentPage, limit, totalInfo) {
			$.ajax({
				type: "get",
				url: localStorage.serIp + "/WebGetOrderSlaveInfoByOrderNum?jsoncallback=?",
				dataType: "jsonp",
				async: true,
				data: {
					'userId': localStorage.userId,
					'userPw': localStorage.userPw,
					'database': localStorage.database,
					'orderNum': ordernum
				},
				success: function (res) {
					parent.layer.close(jiazaiIndex);
					var orderData = JSON.parse(res);
				
					oldData = orderData;
					orderDetail(oldData, limit);

				},
				error: function (res) {
					parent.layer.close(jiazaiIndex);

					parent.layer.open({
						title: "提示",
						content: '服务器异常!',
						zIndex: parent.layer.zIndex //重点1

					});


				}
			});

		}
		//失去焦点事件
		$("#gridContainer").on('blur', '.dx-column-lines', function () {
			$('.dx-icon-edit-button-save').click();
		});





















		// 自动匹配字段
		$('.addProductInfo').click(function () {
			if (!checkPermissionStatus("订货合约-保存1")) {
				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return;
			};
			parent.layer.open({
				type: 2 //此处以iframe举例
				,
				title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">自动匹配</span>',
				area: ['65%', '50%'],
				content: 'views/purchasingManagement/orderContract/choicesProductPublicList2.html',

				zIndex: layer.zIndex //重点1
				,
				success: function (layero, index) {
				},
				end: function () {

				},


			}
			)
		})

		window.addEventListener("storage", function onStorageChange(event) {

			// 获取到数据直接添加

			if (event.storageArea.GetProduceInfo) {

				if (event.storageArea.GetProduceInfo.length > 0 && event.storageArea.GetProduceInfo != "[]") {
					var productDatas = JSON.parse(sessionStorage.GetProduceInfo);

					// 先去重
					oldData = productDatas.concat(oldData);

					oldData = Duplicate(oldData, "producenum", "producecount", "produceid");

					orderDetail(oldData);
					
					sessionStorage.removeItem("GetProduceInfo");
				}
			}
		});





		var realCostCheck;
		function orderDetail(data) { //展示已知数据
			var employeesStore = new DevExpress.data.ArrayStore({
				data: data
			});
			var deleteButton = $("#gridDeleteSelected").dxButton({
				text: "删除产品",
				onClick: function () {
					if (!checkPermissionStatus("订货合约-保存1")) {
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function (layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return;
					}

					saveStatus = 0;
					$.each(dataGrid.getSelectedRowKeys(), function () {
						employeesStore.remove(this);
					});
					dataGrid.refresh();
				}
			}).dxButton("instance");
			var dataGrid = $("#gridContainer").dxDataGrid({
				dataSource: data,
				allowColumnReordering: true,
				key: "producenum",
				showBorders: true,
				hint:'ctrl + v 粘贴数据',
				editing: {
					mode:'cell',
					allowUpdating: true,
				},
				cellHintEnabled: true,
				columnChooser: {
					enabled: false,
					mode: "dragAndDrop",
				},
				focusStateEnabled: true,
				headerFilter: {
					visible: false
				},
				sorting: {
					mode: "multiple"
				},
				filterRow: {
					visible: false,
				},
				paging: {
					pageSize: 100000,
				},
				selection: {
					mode: "multiple",
				},
				allowColumnResizing: true,
				columnFixing: {
					enabled: false
				},
				grouping: {
					contextMenuEnabled: false,
					expandMode: "rowClick"
				},
				groupPanel: {
					visible: false
				},
				columns: [{
					dataField: "producename",
					caption: "产品名称",
					width: 160,
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}
				}
				,
				{
					dataField: "danwei",
					width: 160,
					caption: "规格",
					allowEditing: false,
				
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}
				},
				{
					dataField: "producemodel",
					width: 120,
					caption: "型号",
					allowEditing: false,
		
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}
				}
				,
				{
					dataField: "producenum",
					width: 100,
					caption: "编号",
					allowEditing: false,
					isEditing: true,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}
				}, {
					dataField: "producecode",
					width: 180,
					caption: "主条码",
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}
				},
				{
					dataField: "produceunit",
					width: 50,
					caption: "单位",
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}
				}, {
					dataField: "package",
					width: 100,
					caption: "包装",
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}
				}, {
					dataField: "producepropertyname",
					width: 100,
					caption: "产品种类",
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}
				},
				{
					dataField: "produceseries",
					width: 100,
					caption: "系列",
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}
				}
				, {
					dataField: "produceusename",
					width: 100,
					caption: "通俗名称",
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.text + "</div>"))
							.appendTo(container);
					}
				}
					, {
					dataField: "producematerial",
					width: 90,
					caption: "材质",
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.text + "</div>"))
							.appendTo(container);
					}
				}, {
					dataField: "producettypename",
					width: 70,
					caption: "产品属性",
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}
				}, {
					dataField: "manufacturer",
					width: 70,
					caption: "品牌",
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}

				}, {
					dataField: "manufacturename",
					width: 160,
					caption: "厂家",
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
					}
				}, {
					dataField: "productcertificate",
					width: 150,
					caption: "产品生产许可证编号",
					allowEditing: false,
					cellTemplate:function(container,options){
						if(options.value == null || options.value == ''){
							$("<div>")
							.append($("<div></div>"))
							.appendTo(container);
						}else{
							$("<div>")
							.append($("<div> " + options.value + "</div>"))
							.appendTo(container);
						}
						
					}
				}, {
					dataField: "producecount",
					width: 60,
					caption: "数量",
					fixed: true,
					allowEditing: true,
					noDataText: '0',
					value: '0',
					editorOptions: {
						format: "#"
					},
					cssClass:'producecount',
					dataType: "number",
					fixedPosition: 'right',
					cellTemplate: function (container, options) {
						if (options.value == null || options.value == "" || options.value == "0" || options.value == 0 || options.value < 0) {
							options.value = 1;
							options.text = '1';
							options.displayValue = 1;
							options.data.producecount = 1;
							$("<div>")
								.append($("<div>" + options.value +"</div>"))
								.appendTo(container);
						} 
						else {
							$("<div>")
								.append($("<div>" + options.value + "</div>"))
								.appendTo(container);
						}
					}

				}, {
					dataField: "referprice",
					width: 80,
					caption: "合同价格",
					cssClass:'referprice',
					fixed: true,
					fixedPosition: 'right',
					allowEditing: false,
					cellTemplate: function (container, options) {
						if (options.value == null || options.value == "") {
							$("<div>")
								.append($("<div>0</div>"))
								.appendTo(container);
						} else {
							$("<div>")
								.append($("<div>" + options.value + "</div>"))
								.appendTo(container);
						}
					}


				}, {
					dataField: "realcost",
					width: 80,
					caption: "采购价格",
					dataType: "number",
					cssClass:'realcost',
					format: {
						type: "fixedPoint",
						precision: 3
					},
					fixed: true,
					fixedPosition: 'right',
					allowEditing: true,
					validationRules: [{
						type: "pattern",
						pattern: /^[+]{0,1}(\d+)$|^[+]{0,1}(\d+\.\d+)$/,
						message: "数量必须为正"
					}],
					cellTemplate: function (container, options) {
						if (options.value == null || options.value == "") {
							$("<div>")
								.append($("<div>0</div>"))
								.appendTo(container);
						} else {
							$("<div>")
								.append($("<div>" + options.value + "</div>"))
								.appendTo(container);
						}
					}
				}, {
					dataField: "subtotal",
					width: 100,
					caption: "小计",
					cssClass:'subtotal',
					alignment: "right",
					fixed: true,
					fixedPosition: 'right',
					format: {
						type: "fixedPoint",
						precision: 2
					},
					customizeText: function (arg) {
						return arg.valueText;
					},
					cellTemplate: function (container, options) {
					    var mutiple = options.data.producecount * options.data.realcost;
						if (mutiple == null || mutiple == "") {
							$("<div>")
								.append($("<div>0</div>"))
								.appendTo(container);
						} else {
							$("<div>")
								.append($("<div>" + mutiple + "</div>"))
								.appendTo(container);
						}
					},
					allowEditing: false,
				},
				]
				,
				summary: {
					totalItems: [{
						column: "subtotal",
						summaryType: "sum",
						customizeText: function (data) {
							var sum = 0;
							$.each(oldData,function(v,i,arr){
                                 sum += i.producecount * i.realcost;
							});
							data = sum.toFixed(2);
							return data;
						}
					}, {
						column: "producecount",
						summaryType: "sum",
						customizeText: function (data) {
							var data = data.value;
							return data;
						}
					}
					]
				},
			
				onRowUpdated: function (e) {
					// 判断有没有按下保存键,如果按下存1,没有存0
					saveStatus = 0;
                    
				},
				onCellClick:function(e){

				},
				onRowInserting: function (e) {
					var manufacturer = e.data.manufacturer;
					var producenum = e.data.producenum;
					getProductInfoByProducenumAndBrand(producenum, manufacturer);
				},

				onSelectionChanged: function () {
					// 按delete键删除勾选
					$(document).keydown(function (event) {
						if (event.keyCode == 46) {
							$('#gridDeleteSelected').click();
						}
					});
				},
				onContentReady: function (e) {

					//  获取打印数据
					var printData = e.component.getVisibleColumns(1);
					var jsonObject = {};
					$.each(printData, function (i, v, arr) {
						if (i > 0) {
							var jsonObject = {
								"property": v.dataField,
								"name": v.caption,
								"width": 100,
								'checkbox': 0
							}
							printArray.push(jsonObject);

						}

					})
					var updatedData = e.component.getDataSource()._items;
					realCostCheck = updatedData.some(function (v, i, arr) {
						return v.realcost == 0;
					})

				},


			}).dxDataGrid('instance');
		}


		var printArray = [];
		// 删除单据
		$('.del').on('click', function () {
			var ordernumList = '';
			var arrForOderNum = [];
			var danhao = ' ';
			var danhao = $('.dx-selection');
			var newarr = [];
			danhao.get().forEach(function (currentValue, index, arr) {
				danhao = "\'" + currentValue.childNodes[1].innerText + "\'";
				newarr = arrForOderNum.push(danhao);
				ordernumList = arrForOderNum.join(",");
			});
			if (ordernumList.length == 0) {
				parent.layer.open({
					title: "提示",
					zIndex: parent.layer.zIndex, //重点1,
					content: '请选择要删除的产品!'
				});
				return;
			}
		})

         $('td').on('focus',function(){
         
			$(this).select()
		})
		//新增产品
		$(".addProduct").click(function () {

			if (!checkPermissionStatus("订货合约-保存1")) {
				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return

			}

			eventFlag = true;

			if (sessionStorage.newData || sessionStorage.newData != "[]") {
				sessionStorage.removeItem('newData');
			}

			if (sessionStorage.saveProductData || sessionStorage.saveProductData != "[]") {
				sessionStorage.removeItem('saveProductData');
			}

			var contract_id = $("#contract_id").val() ? $("#contract_id").val() : $(".contract_id").attr('data-id');
			sessionStorage.contract_id = contract_id;

			sessionStorage.saveProductData = JSON.stringify(oldData);
			parent.layer.open({
				type: 2 //此处以iframe举例
				,
				title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">产品列表</span>',
				area: ['85%', '90%'],
				offset: "rb",
				content: 'views/public/product/choicesProductPublicList.html',
				zIndex: layer.zIndex //重点1
				,
				success: function (layero) {
					parent.layer.setTop(layero); //重点2
					var body = layer.getChildFrame('body', 'index');

					paentIfarame = layero.find("iframe")[0].contentWindow.document;

				},

				end: function () {
					if (sessionStorage.newData) {
						if (sessionStorage.newData.length > 0 && sessionStorage.newData != "[]") {

							var productData = JSON.parse(sessionStorage.newData);

							oldData = [];
							for (var j = 0; j < productData.length; j++) {
								if (typeof (productData[j].realcost) == "undefined" || productData[j].realcost == null || productData[j].realcost == "") {
									productData[j].realcost = "0.00";

									productData[j].subtotal = "0.00";
								}

								if (typeof (productData[j].referprice) == "undefined" || productData[j].referprice == "" || productData[j].referprice == null) {
									productData[j].referprice = "0.00";
								}

								var flag = false;
								var currIndex = 0;
								for (var i = 0; i < oldData.length; i++) {
									if (productData[j].produceid == oldData[i].produceid) {
										flag = true;
										currIndex = i;
										break;
									}
								}
								if (flag) {

									var currentProductCount = Number(oldData[currIndex].producecount) + Number(productData[j].producecount);
									oldData[currIndex].producecount = currentProductCount;
									oldData[currIndex].subtotal = oldData[j].realcost * currentProductCount;
									oldData[currIndex].realcost = oldData[j].realcost;


								} else {
									var subtotal = eval(productData[j].realcost * productData[j].producecount);
									subtotal = subtotal.toFixed(2);

									productData[j].subtotal = subtotal;

									productData[j].produceid = productData[j].id;
									oldData.push(productData[j]);

								}




							}


							oldData = uniqueArray(oldData, "produceid");

							orderDetail(oldData);
						} else {
							layer.closeAll();
						}
					}

					if (sessionStorage.saveProductData || sessionStorage.saveProductData != "[]") {
						sessionStorage.removeItem('saveProductData');
					}

					if (sessionStorage.contract_id) {
						sessionStorage.removeItem('contract_id');
					}

				}
			});


		});



		$('.addDianJiEvent').on('click', function () {
			var type = $(this).data('type');
			active[type] ? active[type].call(this) : '';
		});



		//作废
		$(".abolish").click(function () {

			if (!checkPermissionStatus("订货合约-保存1") || !checkPermissionStatus("订货合约-审核1")) {

				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return

			}


			parent.layer.confirm('确认作废单据吗?', {
				icon: 3,
				title: '提示'
			}, function (index) {



				$.ajax({
					type: "get",
					url: localStorage.serIp + "/WebCancelOrderInStock?jsoncallback=?",
					dataType: "json",
					contentType: 'application/json; charset=utf-8',
					crossDomain: true,
					async: true,
					data: {
						'userId': localStorage.userId,
						'userPw': localStorage.userPw,
						'database': localStorage.database,
						'orderNum': $(".orderNum").val()
					},
					success: function (res) {
						var data = JSON.parse(res);
						if (data == 1) {
							parent.layer.open({
								title: "提示",
								content: '作废成功',
								zIndex: layer.zIndex //重点1
								,
								success: function (layero) {
									parent.layer.setTop(layero); //重点2
								}
							});
							oprateStatus(2);
						} else {
							parent.layer.open({
								title: "提示",
								content: '作废失败',
								zIndex: layer.zIndex //重点1
								,
								success: function (layero) {
									parent.layer.setTop(layero); //重点2
								}
							});
						}
					}
				});
			}
			);





		});


		// 修改备注
		$('.xiugainotes').click(function () {
			
			if (!checkPermissionStatus("订货合约-保存1")) {
				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return;

			}
			var xiugainotes= $('.ordeNotes').val();
			sessionStorage.xiugainotes = JSON.stringify(xiugainotes);
					parent.layer.open({
				type: 2 //此处以iframe举例
				,
				title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">修改备注</span>',
				area: ['450px', '300px'],
				content: 'views/public/editcomment.html',
				zIndex: parent.layer.zIndex, //重点1
				success: function (layero, index11) {
					parent.layer.setTop(layero); //重点2
					var body = layer.getChildFrame('body', 'index');
					paentIfarame = layero.find("iframe")[0].contentWindow.document;

					$(".bohui", paentIfarame).click(function () {

						var rejectnomo = $(".rejectnomo", paentIfarame).val();
                       

						parent.layer.confirm('确认修改吗？', {
							icon: 3, zIndex: parent.layer.zIndex, //重点1
							title: '提示'
						}, function (index) {

					



							var jiazaiIndex;
							parent.layer.open({
								type: 3,
								zIndex: parent.layer.zIndex, //重点1
								success: function (layero, index) {
									jiazaiIndex = index;
								}
							});


							$.ajax({
								type: "get",
								url: localStorage.serIp + "/WebUpdateMasterNomo	",
								crossDomain: true,
								contentType: 'application/json; charset=utf-8',
								data:{
									'userId': localStorage.userId,
									'userPw': localStorage.userPw,
									'database': localStorage.database,
									'ordernum': $(".orderNum").val() + '',
									'nomo': rejectnomo + '',
									'type': "11",

								},
								success: function (res) {

									parent.layer.close(jiazaiIndex);

									var data = JSON.parse(res);
									if (data.ResultValue == "1") {

										parent.layer.open({
											title: "提示",
											content: "修改成功!",
											zIndex: parent.layer.zIndex,//重点1,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(index11); //再执行关闭   
											},
											end: function(){
												location.reload();
											}
										});

									
									} else {

										parent.layer.open({
											title: "提示",
											content: data.ResultValue,
											zIndex: parent.layer.zIndex,//重点1,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2

											}
										});

									}


								}

								,
								error: function (res) {
									parent.layer.close(jiazaiIndex);

									parent.layer.open({
										title: "提示",
										content: '服务器异常!',
										zIndex: parent.layer.zIndex //重点1

									});


								},
								
							});

						}

						);




					})
				},
				end:function(){
					if (sessionStorage.xiugainotes || sessionStorage.xiugainotes != "[]") {
				sessionStorage.removeItem('xiugainotes');
			}
				}
				

			});
		})

		//反审核
		$(".noExamine").click(function () {

			if (!checkPermissionStatus("订货合约-审核1")) {
				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return

			}


			parent.layer.confirm('警告：反审核是高级别操作，确定进行反审核操作？', {
				icon: 3,
				title: '提示'
			}, function (index) {
				var jiazaiIndex;
				parent.layer.open({
					type: 3,
					zIndex: parent.layer.zIndex, //重点1
					success: function (layero, index) {
						jiazaiIndex = index;
					}
				});


				$.ajax({
					type: "get",
					url: localStorage.serIp + "/WebCheckReturnSaveState?jsoncallback=?",
					dataType: "jsonp",
					async: true,
					data: {
						'userId': localStorage.userId,
						'userPw': localStorage.userPw,
						'database': localStorage.database,
						'orderNum': $(".orderNum").val()
					},
					success: function (res) {
						parent.layer.close(jiazaiIndex);

						var data = JSON.parse(res);
						switch (data.type) {
							case 1:
								if (!checkPermissionStatus("订货合约-审核1")) {
									parent.layer.open({
										title: "提示",
										content: localStorage.jurisdictionTips,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function (layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return

								}
								parent.layer.open({
									title: "提示",
									content: '反审核成功',
									zIndex: layer.zIndex, //重点1
									success: function (layero) {
										parent.layer.setTop(layero); //重点2
										oprateStatus(0);
									}
								});
								break;
							case 0:
								parent.layer.open({
									title: "提示",
									content: data.data,
									zIndex: layer.zIndex, //重点1
									success: function (layero) {
										parent.layer.setTop(layero); //重点2
									}
								});
								break;
							case 2:
								var infoData = JSON.parse(data.data);
								sessionStorage.shengheErrorData = JSON.stringify(infoData);

								parent.layer.open({
									type: 2
									,
									title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">信息</span>',
									area: ['60%', '60%'],

									content: 'views/public/breakCounterror.html',

									zIndex: parent.layer.zIndex //重点1
									,
									success: function (layero, index) {
										parent.layer.setTop(layero); //重点2
										var body = layer.getChildFrame('body', 'index');
										paentIfarame = layero.find("iframe")[0].contentWindow.document;




									},
									end: function (layero, index) {
										if (sessionStorage.shengheErrorData) {
											sessionStorage.removeItem("shengheErrorData");
										}


									}
								});
								break;
						}
						parent.layer.close(index);
						return;

					}
					,
					error: function (res) {
						parent.layer.close(jiazaiIndex);

						parent.layer.open({
							title: "提示",
							content: '服务器异常!',
							zIndex: parent.layer.zIndex //重点1
						});
					}

				});

			});
		});
		var saveStatus = 1;

		var active = {
			//保存
			preserve: function () { //获取选中数据


				if (!checkPermissionStatus("订货合约-保存1")) {

					parent.layer.open({
						title: "提示",
						content: localStorage.jurisdictionTips,
						zIndex: parent.layer.zIndex //重点1
						,
						success: function (layero) {
							parent.layer.setTop(layero); //重点2
						}
					});
					return

				};


				examineData(0, 0);



			},

			//审核
			examine: function () { //获取选中数据
				if (!checkPermissionStatus("订货合约-审核1")) {

					parent.layer.open({
						title: "提示",
						content: localStorage.jurisdictionTips,
						zIndex: parent.layer.zIndex //重点1
						,
						success: function (layero) {
							parent.layer.setTop(layero); //重点2
						}
					});
					return

				};


				if (saveStatus == 0) {

					parent.layer.open({
						title: "提示",
						content: '内容发生变化，请保存后再审核',
						zIndex: layer.zIndex //重点1
						,
						success: function (layero) {
							parent.layer.setTop(layero); //重点2

						}
					});

					return;
				}
				if (realCostCheck) {
					parent.layer.open({
						title: "提示",
						content: '采购价格不能为0',
						zIndex: layer.zIndex //重点1
						,
						success: function (layero) {
							parent.layer.setTop(layero); //重点2

						}
					});

					return;
				}
				examineData(1, 0);


			},

		};


		function examineData(check, mark) {
			saveStatus = 1;

			var companyID = $("#unit").val() != "" ? $("#unit").val() : $(".unit").attr('data-id');

			if (companyID === undefined || companyID == "") {
				parent.layer.open({
					title: "提示",
					content: '请选择往来单位!',
					zIndex: layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});

				return;
			}


			var contract_id = $("#contract_id").val() ? $("#contract_id").val() : $(".contract_id").attr('data-id');

			var agent = $("#salesman").val() ? $("#salesman").val() : $(".salesman").attr('data-id');

			if (agent === undefined || agent == "") {
				parent.layer.open({
					title: "提示",
					content: '请选择业务员!',
					zIndex: layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});

				return;
			}


			data = oldData;

			if (data.length == 0) {
				parent.layer.open({
					title: "提示",
					content: '请选择产品',
					zIndex: layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});

				return;
			}

			var slave = [];

			//保存选中产品信息
			for (var i = 0; i < data.length; i++) {

				slave.push({
					"produceID": '' + data[i].produceid + '',
					"produceCount": '' + data[i].producecount + '',
					'referprice': '' + data[i].referprice + '',
					'realcost': '' + data[i].realcost + ''  //成本价 （传0）
				});
			}


			var operatorSID = $(".orderMaker").attr('data-id');
			var nomo = $('.ordeNotes').val();

			var ordernum = $(".orderNum").val();
			var mynum = $(".orderMynum").val();
			var instoragedate = $('#addOrderDate').val();
			var operationdate = $('#operationdate').val();
			var master = {
				'ordernum': '' + ordernum + '',
				'mynum': '' + mynum + '',
				'ordertime': '' + instoragedate + '',
				'companyID': '' + companyID + '',
				'agent': '' + agent + '',
				'operatorSID': '' + operatorSID + '',
				'nomo': '' + nomo + '',
				'contract_id': '' + contract_id + '',
				'operationdate': operationdate,
				'isorder': 0
			}

			saveAndExamine(master, slave, check, mark);

		}



		/*
		 * 审核和保存公用方法
		 * @param: master 基本数据
		 * @param: slave 产品数据
		 * @param: check 0保存或更新，1审核
		 * @param: mark 首次保存传0，继续保存1
		 */
		function saveAndExamine(master, slave, check, mark) {
			var jiazaiIndex;
			parent.layer.open({
				type: 3,
				zIndex: parent.layer.zIndex, //重点1
				success: function (layero, index) {
					jiazaiIndex = index;
				}
			});
			$.ajax({
				type: "post",
				url: localStorage.serIp + "/WebOperateOrderMasterTable",
				async: true,
				dataType: 'json',
				contentType: 'application/json; charset=utf-8',
				crossDomain: true,
				data: JSON.stringify({
					"userId": localStorage.userId,
					"userPw": localStorage.userPw,
					'database': localStorage.database,
					'groupCompanyId': localStorage.groupcompanyid,
					'master': JSON.stringify(master),
					'slave': JSON.stringify(slave),
					'check': check,// 0保存或更新，1审核
					"mark": mark //首次保存传0，继续保存1
				}),
				success: function (res) {
					
					parent.layer.close(jiazaiIndex);

					var data = JSON.parse(res);

					switch (data.SaveState.state) {
						case 0:
							parent.layer.open({
								title: "提示",
								content: data.SaveState.result,
								zIndex: layer.zIndex,//重点1,
								success: function (layero) {
									parent.layer.setTop(layero); //重点2
								}
							});

							return;
							break;
						case 1:
							if (data.CheckState.state == 2) {  //保存
								eventFlag = false;

								if (!checkPermissionStatus("订货合约-保存1")) {

									parent.layer.open({
										title: "提示",
										content: localStorage.jurisdictionTips,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function (layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return;
								}

								parent.layer.open({
									title: "提示",
									content: '保存成功',
									zIndex: layer.zIndex //重点1
									,
									success: function (layero) {
										parent.layer.setTop(layero); //重点2
										$(".layui-show", parent.document).attr("lay-item-id", "DHHYXQ" + data.SaveState.result);
									}
								});
								oprateStatus(0);

								$(".orderNum").val(data.SaveState.result);
								return;
							}

							if (data.CheckState.state == 1) {
								parent.layer.open({
									title: "提示",
									content: '审核成功',
									zIndex: layer.zIndex //重点1
									,
									success: function (layero) {
										parent.layer.setTop(layero); //重点2


									}
								});

								oprateStatus(1);
								return;
							}

							if (data.CheckState.state == 0) {
								parent.layer.open({
									title: "提示",
									content: '审核失败',
									zIndex: layer.zIndex //重点1
									,
									success: function (layero) {
										parent.layer.setTop(layero); //重点2
									}
								});
								return;
							}



							if (data.CheckState.state == 3) {

								if (sessionStorage.shengheErrorData) {
									if (sessionStorage.shengheErrorData.length > 0 && sessionStorage.shengheErrorData != "[]") {
										sessionStorage.removeItem("shengheErrorData")
									}
								}



								sessionStorage.shengheErrorData = data.CheckState.result;

								parent.layer.open({
									type: 2,
									title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">信息</span>',
									area: ['60%', '65%'],
									content: 'views/public/shengheerror.html',
									zIndex: layer.zIndex,
									success: function (layero, index) {
										parent.layer.setTop(layero); //重点2
										var body = layer.getChildFrame('body', 'index');
										paentIfarame = layero.find("iframe")[0].contentWindow.document;

									}
								});


								return;



							}

							break;
						case 9:

							if (sessionStorage.shouyingzizhiData) {
								if (sessionStorage.shouyingzizhiData.length > 0 && sessionStorage.shouyingzizhiData != "[]") {
									sessionStorage.removeItem("shouyingzizhiData")
								}
							}

							sessionStorage.shouyingzizhiData = data.SaveState.result;

							parent.layer.open({
								type: 2
								,
								title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">首营资质</span>',
								area: ['60%', '65%'],

								content: 'views/public/shouYingZiZhi.html',

								zIndex: layer.zIndex //重点1
								,
								success: function (layero, index) {
									parent.layer.setTop(layero); //重点2
									var body = layer.getChildFrame('body', 'index');
									paentIfarame = layero.find("iframe")[0].contentWindow.document;



									$(".save", paentIfarame).click(function () {
										parent.layer.close(index); //再执行关闭     
										saveAndExamine(master, slave, check, 1);

									})

								}
							});
							break;
						case 10:

							parent.layer.open({
								title: "提示",
								content: data.SaveState.result,
								zIndex: parent.layer.zIndex //重点1

							});
							break;
					}

				}
				, error: function (res) {
					parent.layer.close(jiazaiIndex);

					parent.layer.open({
						title: "提示",
						content: '服务器异常!',
						zIndex: parent.layer.zIndex //重点1

					});

				}

			});

		}




		//一键比价
		$(".yijianbijia").click(function () {

			if (!checkPermissionStatus("订货合约-保存1")) {

				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return

			}


			var contractID = $("#contract_id").val() ? $("#contract_id").val() : $(".contract_id").attr('data-id');
			if (typeof (contractID) == "undefined" || contractID == "") {
				parent.layer.open({
					title: "提示",
					content: '无合同信息不能比价!'
				});
				return false;
			}



			parent.layer.confirm('确定要一键比价吗！', {
				icon: 3,
				title: '提示'
			}, function (index) {


				var get_tax = $('.tax').val(); //税率

				$.ajax({
					type: "get",
					url: localStorage.serIp + "/WebGetProductPriceByProduceIDAndContractID?jsoncallback=?",
					dataType: 'jsonp',
					async: true,
					data: {
						'userId': localStorage.userId,
						'userPw': localStorage.userPw,
						'database': localStorage.database,
						"contractID": contractID

					},
					success: function (res) {
						var desData = JSON.parse(res);

						for (var i = 0; i < oldData.length; i++) {

							for (var j = 0; j < desData.length; j++) {
								if (oldData[i].produceid == desData[j].contractprice_productid) {
									var subtotal = 0;

									oldData[i].referprice = desData[j].contractprice_product_price.toFixed(2);
									oldData[i].realcost = desData[j].contractprice_product_price.toFixed(2);

									subtotal = desData[j].contractprice_product_price * oldData[i].producecount;
									oldData[i].subtotal = subtotal.toFixed(2);



								}


							}



						}

						orderDetail(oldData);
					}
				});

				parent.layer.close(index);

				return;
			},
				function (index) {

					parent.layer.close(index);


					return;
				}
			);



		})










		//模板下载
		$(document).on("click", ".modelDown", function () {
			if (!checkPermissionStatus("订货合约-保存1")) {
				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return

			}

			window.location.href = encodeURI("/QNCloud/templetDown/订货合约导入表格.xlsx");
		})


		var contract_id = "";
		$(".modelup").mousedown(function () {
			contract_id = $("#contract_id").val() ? $("#contract_id").val() : $(".contract_id").attr('data-id');


		})

		//上传Excel
		upload.render({
			elem: '#bjdUpload',
			accept: 'file', //允许上传的文件类型
			url: localStorage.serIp + '/WebImportOrderMasterInfo?database=' + localStorage.database,
			multiple: true,
			//可选项。额外的参数，如：{id: 123, abc: 'xxx'}
			before: function (obj) {

				if (!checkPermissionStatus("订货合约-保存1")) {

					parent.layer.open({
						title: "提示",
						content: localStorage.jurisdictionTips,
						zIndex: parent.layer.zIndex //重点1
						,
						success: function (layero) {
							parent.layer.setTop(layero); //重点2
						}
					});
					return

				}

				this.data = {
					'contract_id': $("#contract_id").val()
				}


				//弹出层转圈圈的那个
				parent.layer.open({
					type: 3,
					zIndex: parent.layer.zIndex, //重点1
					success: function (layero, index) {
						jiazaiIndex = index;
					}
				});
				obj.preview(function (index, file, result) {

				});
			},
			done: function (res) {
				parent.layer.close(jiazaiIndex);

				parent.layer.open({
					zIndex: parent.layer.zIndex, //重点1
					content: '上传成功',
					zIndex: parent.layer.zIndex //重点1
				});

				var chanpin_datas = res;
				change = true
				for (var j = 0; j < chanpin_datas.length; j++) {
					var flag = false;
					var currIndex = 0;
					for (var i = 0; i < oldData.length; i++) {
						if (chanpin_datas[j].produceid == oldData[i].produceid && chanpin_datas[j].producenum == oldData[i].producenum) {
							flag = true;
							currIndex = i;
							break;
						}
					}

					if (flag) {

						var currentProductCount = Number(oldData[currIndex].producecount) + Number(chanpin_datas[j].producecount);
						oldData[currIndex].producecount = currentProductCount;
						oldData[currIndex].subtotal = (chanpin_datas[j].realcost * currentProductCount).toFixed(2);

					} else {

						chanpin_datas[j].referprice = 0;
						oldData.push(chanpin_datas[j]);

					}
				}


				orderDetail(oldData);

			}, error: function (index, upload, obj) {
				//请求异常回调
				parent.layer.close(jiazaiIndex);
			}
		})

	//适配
		var viewHeight = $(window).height();

		$('#gridContainer').css('height', viewHeight * 0.625 + 'px');



		//黏贴功能
		$('#gridContainer')[0].addEventListener("paste", function (e) {
			if (!checkPermissionStatus("订货合约-保存1")) {
				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return;
			};
			var pasteDataarr = [];
			var pasteDatalist;
			var eData = e.clipboardData;
			
			var pasteData = eData.getData("text");
			
			pasteData = pasteData.split(/[\s\n]/);
         
			pasteData.forEach(function (currentValue, index, arr) {
				if (currentValue != "") {
					danhao = "\'" + currentValue + "\'";
					pasteDataarr.push(danhao);
					pasteDatalist = pasteDataarr.join(",");
				}
				
			});



			$.ajax({
				type: "get",
				url: localStorage.serIp + "/WebGetProduceInfoByNumList?jsoncallback=?",
				dataType: 'jsonp',
				async: true,
				data: {
					'userId': localStorage.userId,
					'userPw': localStorage.userPw,
					'database': localStorage.database,
					"producenumlist": pasteDatalist,
					'orderNum': ordernum
				},
				success: function (res) {
					var res = JSON.parse(res);
					if (res.length == 0){
						parent.layer.open({
							title: "提示",
							content: '找不到产品,粘贴时请确认产品编号',
							zIndex: layer.zIndex //重点1
							,
							success: function (layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return;
					}
					if (res[0].Info) {
						parent.layer.open({
							title: "提示",
							content: '请确认粘贴数据',
							zIndex: layer.zIndex //重点1
							,
							success: function (layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return;
					}

					var dataCollectionFromPaste = oldData.concat(res);

					oldData = Duplicate(dataCollectionFromPaste, "producenum", "producecount", "produceid");

					orderDetail(oldData);


				}

			});
		})




		//打印单据
		$(".print").click(function () {
			if (!checkPermissionStatus("订货合约-打印1")) {

				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return;

			}

			var ordertype = 17;  //订货合约
			checkPrintIsSetting("DHHY", $('.orderNum').val(), ordertype);
		})

		//打印设置
		$(".printSetting").click(function () {

			sessionStorage.ordertype = 17;  //订货合约


			sessionStorage.orderLeiXing = $(".orderLeiXing").text();
			var jsonArray = printArray;

			sessionStorage.headjsonArrayData = JSON.stringify(jsonArray);



			parent.layer.open({
				type: 2 //此处以iframe举例
				,
				title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">打印设置</span>',
				area: ['600px', '90%'],
				offset: "rb",
				content: 'views/public/PrintTemplate/PrintTemplate.html',
				zIndex: parent.layer.zIndex, //重点1
				success: function (layero) {
					parent.layer.setTop(layero); //重点2
				},
				end: function () {
					if (sessionStorage.ordertype) {
						sessionStorage.removeItem("ordertype")
					}
					if (sessionStorage.headjsonArrayData) {
						sessionStorage.removeItem("headjsonArrayData")
					}
					if (sessionStorage.orderLeiXing) {
						sessionStorage.removeItem("orderLeiXing")
					}

				}
			});
		});


	});

	//数组去重值并+1
	function Duplicate(arr, key, date, id) {
		var newArr = []
		for (var i = 0; i < arr.length; i++) {
			var flag = true
			for (var j = 0; j < newArr.length; j++) {
				if (arr[i][key] == newArr[j][key] && arr[i][id] == newArr[j][id]) {
					newArr[j][date]++
					flag = false
				}
			}
			if (flag) {
				newArr.push(arr[i])
			}
		}
		return newArr
	};

</script>

</html>