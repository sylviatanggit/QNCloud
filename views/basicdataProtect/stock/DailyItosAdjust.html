<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>盘点</title>
		<link rel="stylesheet" href="../../../plugins/layui/css/layui.css">
		<!--<link href="../../../css/font-awesome.min.css" rel="stylesheet">-->

		<link rel="stylesheet" type="text/css" href="../../../css/qk/custom_style.css">

	</head>
		<style type="text/css">
			
			.leftStock .layui-laypage{
				margin: 0px;
				position: absolute;
				bottom: 5px !important;
				left: 25px;
			}
			
	
			
		.layui-table-fixed .layui-table-body tbody .layui-table-cell {
			    height: auto;
			}
			.panel-content .layui-table-cell{
				padding: 0 0px !important;
			}
			
			.startUpload {
				    padding: 0;
				    cursor: pointer;
				    border: none;
				    width: 85px;
				    height: 28px;
				    text-align: center;
				    line-height: 28px;
				    border-radius: 2px;
				    background-color: #2D89DD;
				    color: #FFFFFF;
				    margin-left: 8px;
				}
				
				.layui-table-click{
					background-color: yellow !important;
				}
	
		</style>
	

	<body>
		<div class="panel-content">
			<div class="layui-tab">
				
				<div class="panel_header">
					
					<div class="inputs">
						
						<!--<div  class="layui-inline" style="margin-right: 15px;width: 310px;height: 28px;">
							<label class="layui-form-label" style="margin-right: 10px;padding-left: 0px;">货架</label>
							<div style="height: 28px;" id="goodsshelvesId">
								<input value="" data-id="" autocomplete="off" id="duiyinggoodsshelvesId" class="layui-input goodsshelves" type="text" style="width: 250px;height: 26px !important;line-height: 26px !important;">
							</div>
						</div>
					
					
						<div class="layui-inline" style="margin-right: 0px;">
								<label class="layui-form-label" style="margin-left: 0px;padding: 0px;margin-right: 5px;">产品种类</label>
								<div class="layui-input-inline">
									<select name="" class="layui-input produceproperty" style="width: 80px;">
										<option value="-1" >全部</option>
										<option value="0" >创伤</option>	
										<option value="1" >关节</option>
										<option value="2" >脊柱</option>
										<option value="3" >运动医学</option>
										<option value="4" >儿童骨科</option>
										<option value="5" >设备</option>
										<option value="6" >其他 </option>					
									</select>
								</div>
						</div>
					-->
						
						<div class="layui-inline">
							<!--<button class="layui-btn find" style="margin-left: 5px;"></button>-->
						</div>
						
						<div class="btns">
							<!--<button class="layui-btn scanCode">扫码盘点</button>-->
							<button class="layui-btn moreAction">更多操作</button>
							<ul class="action" style="right: 0;">
								
								<li id="PandianFanWeiId">
									<a class="jianjishijian" data-type="PandianFanWei">盘点范围</a>
								</li>
								
								
								
								<li  style="display: none;"  id="startPandianId">
									<a class="jianjishijian" data-type="startPandian">开始盘点</a>
								</li>
								
<!--								
								<li style="display: none;" id="stockExportId">
									<a class="jianjishijian stockExport" data-type="stockExport" >库存导出</a>
								</li>
							
								
								
								<li style="display: none;" id="shipanImportId">
									
									<button type="button" class="jianjishijian layui-btn" id="shipanImport" style="width: 88px;margin-left:0px;background-color: #fff;height: 25px;line-height: 25px;color: #232323">实盘导入</button>

								</li>-->
								
									
								<!--<li style="display: none;" id="scanCodeId">
									<a class="jianjishijian scanCode" data-type="stockExport" >扫码盘点</a>
								</li>-->
								
					
								
								<!--<li style="display: none;" id="duibiDataId">
									<a class="jianjishijian" data-type="duibiData">结束盘点</a>
								</li>-->
								
											
								<li id="fangqiId" style="display: none;" >
									<a class="jianjishijian fangqi" data-type="fangqi" >放弃盘点</a>
								</li>
								
							</ul>
						</div>
						
					</div>

				</div>
				
				
				<div style="width: 100%;height: 100%;">
					<div  class="leftStock">
						<table id="leftStockId" lay-filter="leftStock"></table>
					</div>
					
				
				</div>
				
				
				<div style="position: absolute; text-align: center;right:1.5% ;vertical-align: middle;bottom: 3px;height: 30px;">
						<!--<div style="position: relative;right: 100px;display: inline-block;vertical-align: middle;text-align: center;font-size: 14pt;">
								<span id="shipanCountId" style="width: auto;height: auto;cursor: pointer;display: inline-block;font-size: 14pt;" class="jianjishijian" data-type="shiPanCount">0</span>/<span id= "totalCountId" style="font-size: 14pt;">0</span>
					    </div>-->
					    
					        <div style="position: relative;right: 0px;display: inline-block;">
								<button class="startUpload jianjishijian" data-type="startUpload">上传</button>
					    </div>
					    
					    <div style="position: relative;right: 0px;display: inline-block;">
								<button class="startUpload jianjishijian" data-type="del">删除产品</button>
					    </div>
				</div>
				
			</div>
		</div>
		<input type="hidden" value="" class="orderNumid"/>
	
	</body>
	<script src="../../../plugins/layui/layui.js"></script>
	<script src="../../../js/public.js"></script>

	<script>
		
		function keyDown(obj){
	var _row = obj.parentNode;

	currentCol = _row.cellIndex;
	currentLine = _row.parentNode.rowIndex;
	 e=window.event||e;
	  switch(e.keyCode){
	    case 37: //左键
	      currentCol--;
	      changeItem();
	      break;
	    case 38: //向上键
	      currentLine--;
	      changeItem();
	      break;
	    case 39: //右键
	      currentCol++;
	      changeItem();
	      break;
	    case 40: //向下键
	      currentLine++;
	      changeItem();
	      break;
	    default:
	      break;
	  }
}

	//方向键调用
//	function changeItem(){
//		
//		var it;
//	  if(document.all)
//	     it=document.getElementsByTagName("table").children[0];
//	  else
//	     it=document.getElementsByTagName("table");
//	  
//		it = it[3];
//	  if(currentLine<0){
//	    currentLine=it.rows.length-1;
//	  }
//	  if(currentLine==it.rows.length){
//	  currentLine=0;
//	  }
//	  var objtab=document.all.specificationsTable;
//	  var objrow=objtab.rows[currentLine].getElementsByTagName("INPUT");
//	  if(currentCol<0){
//	    currentCol=objrow.length-1;
//	  }else if(currentCol==objrow.length){
//	    currentCol=0;
//	  }
//	  objrow[currentCol].select();
//	 
//	}
	
	
		var  jiazaiIndex;
//		var targetstockid = "";
		var orderNum = "";
		var getrightStockData;		
		var scanCodeInStore;
		
		var leftData = [];

		layui.use(['table', 'jquery', 'laydate', 'laypage','upload'], function() {
			var table = layui.table;
			var $ = layui.jquery;upload = layui.upload;
			var laypage = layui.laypage;

			$("#shipanImport").mouseover(function(){
			  $(this).css("background-color","#ACD7FF");
			});
			
			$("#shipanImport").mouseout(function(){
			  $(this).css("background-color","#fff");
			});
			
				
			
			
			
			$('.moreAction').hover(function() {
				$(".action").show();
			}, function() {
				$(".action").hide();
			});
			
			
			$('.action').hover(function() {
				$(".action").show();
			}, function() {
				$(".action").hide();
			});
			
			var limit1 = 100000;
			var curpage1 = 1;
			var count1 = 0;
			
			
			function initData(){
	
				
				$.ajax({
					type: "get",
					url:  localStorage.serIp  +"/WebGetInventoryInfoByArea?jsoncallback=?",
					async: true,
					dataType: 'jsonp',
					data: {
						"userId": localStorage.userId,
						"userPw": localStorage.userPw,
						'database': localStorage.database,
						'groupCompanyId': localStorage.groupcompanyid,
						'stockarea':  sessionStorage.areaid

					},
					success: function(res) {
						parent.layer.close(jiazaiIndex);
		
						var data = JSON.parse(res);
						
						
						if(data.length > 0){
							
							orderNum = data[0].inventorymaster_ordernum;
							
							var inventorymaster_lasttype = data[0].inventorymaster_lasttype;
							
//							sessionStorage.pandiangoodsshelves_id = data[0].goodsshelves_id;
							sessionStorage.inventorymaster_lasttype = data[0].inventorymaster_lasttype;
////							sessionStorage.produceproperty = produceproperty;
////							sessionStorage.producename = producename;
////							sessionStorage.danwei = danwei;
////							sessionStorage.producemodel = producemodel;
////							sessionStorage.manufacturer = manufacturer;
							sessionStorage.pandianWay = data[0].inventorymaster_method;
//									
									
							$(".orderNumid").val(orderNum);
							
							leftStock(true);
							
//							$("#duibiDataId").css("display","block");
							$("#fangqiId").css("display","block");
							
							$("#startPandianId").css("display","none");
							$("#PandianFanWeiId").css("display","none");
							if(inventorymaster_lasttype == 1){
								
								$("#scanCodeId").css("display","block");
								
							}else{
								
								var inventorymaster_method  = data[0].inventorymaster_method;
								
								if(inventorymaster_method == "2"){
										$("#scanCodeId").css("display","block");
								}else{
									
										$("#stockExportId").css("display","block");
										$("#shipanImportId").css("display","block");
									
								}
								
							}
							
						}
						
	

									
					},
					error: function(res) {
							parent.layer.close(jiazaiIndex);
							
							parent.layer.open({
								title: "提示",
								content: '服务器异常!',
									zIndex: parent.layer.zIndex //重点1
					
							});
					}
				});
			}
			
			initData();


			leftStockData(null)
			function leftStock(jumpFlag) {
				var seachContent = $(".seachContent").val();
				$.ajax({
					type: "get",
					url: localStorage.serIp+"/WebGetInventorySlave?jsoncallback=?",
					dataType: 'json',
					data: {
						'userId': localStorage.userId,
						'userPw': localStorage.userPw,
						'num': limit1,
						'page': 1,
						'orderNum':orderNum,
						'database': localStorage.database,
						'type' : 0,//0 获取库存信息 //1获取已盘信息
						'txtCondition': seachContent

					},
					success: function(res) {
						var desData = JSON.parse(res);
//						count1 = desData.count;
						var data = JSON.parse(desData.data)
						
						leftData = data;
						leftStockData(data);
						
//						$("#shipanCountId").text(desData.realCount);
//						$("#totalCountId").text(desData.realStockCount);
					

					}
				});

			}
			
			
		

			function leftStockData(data) {
				//展示已知数据
				table.render({
					elem: '#leftStockId',
					data: data ,id: 'orderTest',
					height: "full-105",
					cols: [
						[ //标题栏
   {type:'numbers'},
							{
								checkbox: true,
								LAY_CHECKED: false,
								align: "center",
								width: 40,
							},{
								field: 'producename',
								title: '产品名称',	align: "center",
								width: 80

							},
//
							{
								field: 'danwei',
								title: '规格',
								align: "center",
								width: 80

							}, {
								field: 'producemodel',
								title: '型号',	align: "center",
								width: 80

							}, {
								field: 'producecode',
								title: '主条码',
								align: "center",
								width: 120

							}, {
								field: 'producesubbarcode',
								title: '副条码-错误',
								align: "center",
								minWidth: 100,style: "color:red",

							}, {
								field: 'iots',
								title: '批号-错误',
								align: "center",
								width: 100,style: "color:red",

							}, {
								field: 'productiondate',
								title: '生产日期-错误',
								align: "center",
								width: 110,style: "color:red",

							}, {
								field: 'indate',
								title: '有效期-错误',
								width: 100,style: "color:red",

							},
							 {
								field: 'manufacturer',
								title: '厂家',	align: "center",
								width: 100

							},							
							{
								field: 'producenum',
								title: '产品编号',	align: "center",
								width: 100

							}, {
								field: 'warehousename',
								title: '所在仓库',	align: "center",
								width: 100

							}, {
								field: 'areaname',
								title: '货区',	align: "center",
								width: 100

							}, {
								field: 'goodsshelves_name',
								title: '货架',	align: "center",
								width: 100

							}, {
								field: 'producesubbarcode1',
								title: '副条码',
								align: "center",
								width: 150,fixed: 'right',
								templet: function(d){
							        return '<input type="text" class="producesubbarcodeScancode" onkeydown="keyDown(this);">'
							      }
							    

							}, {
								field: 'iots1',
								title: '批号',
								align: "center",
								width: 130,fixed: 'right',
								templet: function(d){
							        return '<input type="text" >'
							      }

							}, {
								field: 'productiondate1',
								title: '生产日期',
								align: "center",
								width: 130,fixed: 'right',templet: function(d){
							        return '<input type="date">'
							      }

							}, {
								field: 'indate1',
								title: '有效期',	align: "center",
								width: 130,
								fixed: 'right',templet: function(d){
							        return '<input type="date">'
							      }

							}, {
								field: 'realstockcount',
								title: '数量',
								minWidth: 80,	align: "center",
								fixed: 'right',

							}
						]
					],
					skin: 'row' //表格风格
						,
					even: true
						,page: false //是否显示分页
						,
					limit: limit1 //每页默认显示的数量
				});
				
//				$(".leftStock [data-field=realstockcount]").css("background-color","#ffc8c8");

				
			}
			

	
var currentLine= 0;
var currentCol=0;



			$(document).delegate(".producesubbarcodeScancode","keydown",function(e){
				
				if($(this).val() == ""){
					return;
				}
				var index = $(this).parent().parent().parent().attr("data-index");
				
				var producecode = $(".layui-table-body table tbody [data-index="+index+"] [data-field=producecode] div").html();


			  	var  getValue  = getSaoMaData($(this).val(),producecode);
			  	var iots = getValue.iots;
			  	
			  	if(iots == ""){
			  		$(".layui-table-fixed .layui-table-body table tbody [data-index="+index+"] [data-field=iots1] div input").val("");
					$(".layui-table-fixed .layui-table-body table tbody [data-index="+index+"] [data-field=indate1] div input").val("");
					$(".layui-table-fixed .layui-table-body table tbody [data-index="+index+"] [data-field=productiondate1] div input").val("");
	
			  		layer.tips('副条码有误!',$(this));
			  		$(this).val("");
			  	}
			  	var indate = getValue.indate;
			  	var productionDate = getValue.productionDate;
			  	
			  	$(".layui-table-fixed .layui-table-body table tbody [data-index="+index+"] [data-field=iots1] div input").val(iots);
				$(".layui-table-fixed .layui-table-body table tbody [data-index="+index+"] [data-field=indate1] div input").val(indate);
				$(".layui-table-fixed .layui-table-body table tbody [data-index="+index+"] [data-field=productiondate1] div input").val(productionDate);
	
				leftData[index].producesubbarcode1 = $(this).val();
		  		leftData[index].iots1 = iots;
				leftData[index].indate1 = indate;
				leftData[index].productiondate1 = productionDate;
			  	
//			  	 $(".layui-table-body table tbody [data-index="+(Number(index) + 1)+"] [data-field=producesubbarcode1] div input").focus();	
				
			});
				
	
			var $ = layui.$,
				active = {
					duibiData: function() { //数据对比							
				
					if(sessionStorage.pandianDanHanid){
						sessionStorage.removeItem("pandianDanHanid")
					}
						
		
					
					sessionStorage.pandianDanHanid = orderNum;
						parent.layer.open({
							type: 2 //此处以iframe举例
								,
							title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">盘盈盘亏</span>',
							area: ['85%', '90%'],
							offset: "rb",
							content: 'views/basicdataProtect/stock/inventoryProfitAndLoss.html',
							zIndex: parent.layer.zIndex //重点1
								,
							success: function(layero,index) {
								parent.layer.setTop(layero); //重点2
								var body = layer.getChildFrame('body', 'index');
								paentIfarame = layero.find("iframe")[0].contentWindow.document;

							
							},
								cancel: function() {
							},
							end: function() {
									if(sessionStorage.pandianDanHanid){
										sessionStorage.removeItem("pandianDanHanid")
									}
									
									var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
									parent.layer.close(index); //再执行关闭   
							}
						});
				
					}
					,
					startUpload:function(){
					
							if(orderNum == ""){
								parent.layer.open({
									title: "提示",
									content: "请先确认开始盘点!",
									zIndex: parent.layer.zIndex //重点1
									
								});
								
								return;
							}
							
							parent.layer.confirm("上传时请先确认数据是否正确?", {
									icon: 3,
									title: '提示',zIndex: parent.layer.zIndex //重点1
							
							}, function(index) {
								
							var getdata = layui.table.cache.orderTest;
							
							
							getdata.forEach(function(item, i){
								  	
							 	var iots1 =	$(".layui-table-fixed .layui-table-body table tbody [data-index="+i+"] [data-field=iots1] div input").val();
								var indate1 = $(".layui-table-fixed .layui-table-body table tbody [data-index="+i+"] [data-field=indate1] div input").val();
								var productiondate1 = $(".layui-table-fixed .layui-table-body table tbody [data-index="+i+"] [data-field=productiondate1] div input").val();
								var producesubbarcode1 = $(".layui-table-fixed .layui-table-body table tbody [data-index="+i+"] [data-field=producesubbarcode1] div input").val();

								
								
								item.producecount = item.realstockcount;
								item.producesubbarcode1 = producesubbarcode1;
								item.iots1 = iots1;
								item.indate1 = indate1
								item.productiondate1 = productiondate1;
								item.producesubbarcode1 = producesubbarcode1;
							})
					

						
							var URL = "/WebInventoryForIotsChanges";
			
					
										
							var jiazaiIndex;
								parent.layer.open({
								  type: 3, 
								  zIndex: parent.layer.zIndex, //重点1
								  success: function(layero, index){
								  		jiazaiIndex = index;
						  			}
								});
							
							
							
							$.ajax({
								type: "post",
								url:  localStorage.serIp  +URL,
								async: true,
								contentType:'application/json; charset=utf-8',
								crossDomain:true,
								dataType: 'json',
								data: JSON.stringify({
									"userId": localStorage.userId,
									"userPw": localStorage.userPw,
									'database': localStorage.database,
									'groupCompanyId': localStorage.groupcompanyid,
									'orderNum':  orderNum,
									'dtSlave': JSON.stringify(getdata)
								}),
								success: function(res) {
									parent.layer.close(jiazaiIndex);
					
									var data = JSON.parse(res);
									
									if(data.ResultValue == "1"){
										result = "上传成功，已生成盘盈盘亏单据";
										parent.layer.open({
											title: "提示",
											content: result,
											zIndex: parent.layer.zIndex ,//重点1,
											success: function(layero) {
												parent.layer.setTop(layero); //重点2
											
													
											}
										});
											orderNum = "";
											leftData = [];
											leftStockData(leftData);
											$("#PandianFanWeiId").css("display","block");
											
											$("#startPandianId").css("display","none");
											
											$("#fangqiId").css("display","none");
									
									}
									
									if(data.ResultValue == "0")
									{
											result = "服务器异常！";
											parent.layer.open({
												title: "提示",
												content: result,
												zIndex: parent.layer.zIndex ,//重点1,
												success: function(layero) {
													parent.layer.setTop(layero); //重点2
												
												}
											});
									}
										
									if(data.ResultValue == "2")
									{
												parent.layer.open({
												title: "提示",
												content: data[0].ResultItem,
												zIndex: parent.layer.zIndex //重点1
												
											});
									}	
													
									},
									error: function(res) {
										parent.layer.close(jiazaiIndex);
										
										parent.layer.open({
											title: "提示",
											content: '服务器异常!',
												zIndex: parent.layer.zIndex //重点1
								
										});
									}
							});
							},
							 function(index) {
								parent.layer.close(index);
						
							
			
								return;
							});
							
							
						
												
					}
				
					,		
					//删除
					del : function(){
						
					if (orderNum !=""){
							parent.layer.open({
								title: "提示",
								content: '已经开始盘点,不能再删除产品!',
								zIndex: parent.layer.zIndex //重点1
								,
								success: function(layero) {
									parent.layer.setTop(layero); //重点2
								}
							});
						
							return;
						}
								
								
						var checkStatus = table.checkStatus('orderTest'),
						data = checkStatus.data;
						
						if (data.length ==0){
							parent.layer.open({
								title: "提示",
								content: '请选择产品!',
								zIndex: parent.layer.zIndex //重点1
								,
								success: function(layero) {
									parent.layer.setTop(layero); //重点2
								}
							});
						
							return;
						}
						
				
						leftData =  deleteStockUniqueArray(leftData,data);
						leftStockData(leftData);	
			
	
					},
					
					fangqi:function(){
						
							parent.layer.confirm('放弃盘点将置空所有盘点数据，确定放弃盘点吗？', {
								icon: 3,
								title: '提示', zIndex: parent.layer.zIndex, //重点1
							}, function(index) {
								
								var jiazaiIndex;
								parent.layer.open({
								  type: 3, 
								  zIndex: parent.layer.zIndex, //重点1
								  success: function(layero, index){
								  		jiazaiIndex = index;
						  			}
								});
							
							
							
							$.ajax({
								type: "get",
								url:  localStorage.serIp  +"/WebCancelInventory?jsoncallback=?",
								async: true,
								crossDomain:true,
								dataType: 'json',
								data: {
									"userId": localStorage.userId,
									"userPw": localStorage.userPw,
									'database': localStorage.database,
									'groupCompanyId': localStorage.groupcompanyid,
									'orderNum':  orderNum
								},
								success: function(res) {
									parent.layer.close(jiazaiIndex);
					
									var data = JSON.parse(res);
									
									if(data[0].ResultValue == "1"){
										result = "已放弃盘点";
										parent.layer.open({
											title: "提示",
											content: result,
											zIndex: parent.layer.zIndex ,//重点1,
											success: function(layero) {
												parent.layer.setTop(layero); //重点2
												
												orderNum ="";
												leftData = [];
												leftStockData(leftData)
													
											}
										});
										
										$("#PandianFanWeiId").css("display","block");
										$("#fangqiId,#scanCodeId,#shipanImportId,#stockExportId,#startPandianId").css("display","none");
									
//										$("#totalCountId").text("0");
									}
									
									if(data[0].ResultValue == "0")
									{
											result = "服务器异常！";
											parent.layer.open({
												title: "提示",
												content: result,
												zIndex: parent.layer.zIndex ,//重点1,
												success: function(layero) {
													parent.layer.setTop(layero); //重点2
												
												}
											});
									}
										
									if(data[0].ResultValue == "2")
									{
												parent.layer.open({
												title: "提示",
												content: data[0].ResultItem,
												zIndex: parent.layer.zIndex //重点1
												
											});
									}	
													
									},
									error: function(res) {
										parent.layer.close(jiazaiIndex);
										
										parent.layer.open({
											title: "提示",
											content: '服务器异常!',
												zIndex: parent.layer.zIndex //重点1
								
										});
									}
									});

								parent.layer.close(index);
							});
					
												
						
					}
					,
					shoujipandian:function(){
					
						if(sessionStorage.pandianDanHanid){
							sessionStorage.removeItem("pandianDanHanid")
						}
						
		
					
						sessionStorage.pandianDanHanid = orderNum;
					
						parent.layer.open({
							type: 2 //此处以iframe举例
								,
							title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">手机盘点</span>',
							area: ['400px', '400px'],
							offset: "auto",
							content: 'views/basicdataProtect/stock/qrcode.html',
							zIndex: parent.layer.zIndex //重点1
								,
							success: function(layero,index) {
								parent.layer.setTop(layero); //重点2
									var body = layer.getChildFrame('body', 'index');

							
							},
								cancel: function() {
							},
							end: function() {
									if(sessionStorage.pandianDanHanid){
										sessionStorage.removeItem("pandianDanHanid")
									}
							}
						});
				}
					,
					shiPanCount:function(){
							if(sessionStorage.pandianDanHanid){
								sessionStorage.removeItem("pandianDanHanid")
							}
						
		
					
						sessionStorage.pandianDanHanid = orderNum;
						parent.layer.open({
							type: 2 //此处以iframe举例
								,
							title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">实盘信息</span>',
							area: ['85%', '90%'],
							offset: "rb",
							content: 'views/basicdataProtect/stock/yipanshow.html',
							zIndex: parent.layer.zIndex //重点1
								,
							success: function(layero,index) {
								parent.layer.setTop(layero); //重点2
										var body = layer.getChildFrame('body', 'index');

							
							},
								cancel: function() {
							},
							end: function() {
									if(sessionStorage.pandianDanHanid){
										sessionStorage.removeItem("pandianDanHanid")
									}
							}
						});
					}
				
					,startPandian:function(){
					
							parent.layer.confirm("盘点前请仔细确认盘点范围，确认开始盘点吗?", {
									icon: 3,
									title: '提示',zIndex: parent.layer.zIndex //重点1
							
							}, function(index) {
								
									var  jiazaiIndex;
									parent.layer.open({
									  type: 3, zIndex: parent.layer.zIndex ,	//重点1
									  success: function(layero, index){
									  	jiazaiIndex = index;
							  			}
									});
									
									
									var master = {
										 "inventorymaster_ordernum" : "",
										 'inventorymaster_nomo' : "",
										 "targetstockid" : sessionStorage.houseId,
										 "stockarea" : sessionStorage.areaid,
										 "goodsshelves_id" : sessionStorage.pandiangoodsshelves_id,
										 "inventorymaster_method" :sessionStorage.pandianWay,
										 "inventorymaster_lasttype" :sessionStorage.inventorymaster_lasttype
									};
									
									$.ajax({
										type: "POST",
										url: localStorage.serIp + "/WebDailyAddInventory",
										async: true,
										dataType: 'json',
										crossDomain: true,
										contentType:'application/json; charset=utf-8',
										data:JSON.stringify({
											"userId": localStorage.userId,
											"userPw": localStorage.userPw,
											'database': localStorage.database,
											'groupCompanyId': localStorage.groupcompanyid,
											'master': JSON.stringify(master),
											'dtSlave': JSON.stringify(leftData),
										}),
										success: function(res) {
									    	parent.layer.close(jiazaiIndex);
					
											var data = JSON.parse(res);
											
											
												if(data[0].ResultValue == "1"){
						
													orderNum = data[0].ResultItem;
//													leftStock(orderNum);
													$(".orderNumid").val(orderNum);
													
																			
													$("#duibiDataId").css("display","block");
													$("#fangqiId").css("display","block");
													
													$("#startPandianId").css("display","none");
													$("#PandianFanWeiId").css("display","none");
							
														if(sessionStorage.inventorymaster_lasttype == "1"){
															
															$("#scanCodeId").css("display","block");
															
														}else{
															
															
															if(sessionStorage.pandianWay == "2"){
																	$("#scanCodeId").css("display","block");
															}else{
																
																	$("#stockExportId").css("display","block");
																	$("#shipanImportId").css("display","block");
																
															}
															
														}
																parent.layer.open({
																	title: "提示",
																	content: '操作成功，开始盘点!',
																	zIndex: parent.layer.zIndex //重点1
																	,
																	success: function(layero) {
																		parent.layer.setTop(layero); //重点2
																	}
																});
								
														parent.layer.close(index);
													
												}
												
												if(data[0].ResultValue == "0")
												{
												
													parent.layer.open({
														title: "提示",
														content: "生成盘点单号失败",
														zIndex: parent.layer.zIndex ,//重点1,
														success: function(layero) {
															parent.layer.setTop(layero); //重点2
														
														}
													});
												}
											
											
											
										}
										,error: function(res) {
											parent.layer.close(jiazaiIndex);
											
											parent.layer.open({
												title: "提示",
												content: '服务器异常!',
													zIndex: parent.layer.zIndex //重点1
									
											});
						
										}
									});
					
								return;
							},
							 function(index) {
								parent.layer.close(index);
						
							
			
								return;
							});
					}
					
					,
					PandianFanWei:function(){
						
						parent.layer.open({
							type: 2 //此处以iframe举例
								,
							title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">盘点范围</span>',
							area: ['400px', '450px'],
							offset: "auto",
							content: 'views/basicdataProtect/stock/DailyPandianSelectWay.html',
							zIndex: parent.layer.zIndex //重点1
								,
							success: function(layero,index22) {
								parent.layer.setTop(layero); //重点2
								var body = layer.getChildFrame('body', 'index');
								paentIfarame = layero.find("iframe")[0].contentWindow.document;
								
								$(".producename",paentIfarame).val(sessionStorage.producename);
								$(".danwei",paentIfarame).val(sessionStorage.danwei);
								$(".producemodel",paentIfarame).val(sessionStorage.producemodel);
								$(".manufacturer",paentIfarame).val(sessionStorage.manufacturer);
								$(".produceproperty",paentIfarame).val(sessionStorage.produceproperty);
								
								

								$(".configInfo",paentIfarame).click(function() {
									var  jiazaiIndex;
									parent.layer.open({
									  type: 3, zIndex: parent.layer.zIndex ,	//重点1
									  success: function(layero, index){
									  	jiazaiIndex = index;
							  			}
									});
									
									
									var goodsshelves_id = $("#duiyinggoodsshelvesId",paentIfarame).val();
									var inventorymaster_lasttype = $(".inventorymaster_lasttype",paentIfarame).val();
									var produceproperty = $(".produceproperty",paentIfarame).val();
									
									var producename = $(".producename",paentIfarame).val();
									var danwei = $(".danwei",paentIfarame).val();
									var producemodel = $(".producemodel",paentIfarame).val();
									var manufacturer = $(".manufacturer",paentIfarame).val();
									var pandianWay = $(".pandianWay",paentIfarame).val();
									
									
									sessionStorage.pandiangoodsshelves_id = goodsshelves_id;
									sessionStorage.inventorymaster_lasttype = inventorymaster_lasttype;
									sessionStorage.produceproperty = produceproperty;
									sessionStorage.producename = producename;
									sessionStorage.danwei = danwei;
									sessionStorage.producemodel = producemodel;
									sessionStorage.manufacturer = manufacturer;
									sessionStorage.pandianWay = pandianWay;
									
									
									$.ajax({
										type: "get",
										url: localStorage.serIp+"/WebGetStockInfoByInventory?jsoncallback=?",
										async: true,
										dataType: 'jsonp',
										data: {
											"userId": localStorage.userId,
											"userPw": localStorage.userPw,
											'database': localStorage.database,
											'stockarea': sessionStorage.areaid,
//											'inventorymaster_method' :pandianWay,
											'targetstockId' : "",
											'brand' :manufacturer,
											'producemodel' :producemodel,
											'danwei' :danwei,
											'producename' :producename,
											'produceproperty' :produceproperty,
											'inventorymaster_lasttype' :inventorymaster_lasttype,
											'goodsshelves_id' :goodsshelves_id,
										},
										success: function(res) {
											var getData = JSON.parse(res);
											parent.layer.close(jiazaiIndex); 
											leftData = getData;
											leftStockData(getData);
											
											if(getData.length > 0){
												$("#startPandianId").css("display","block");
												
											}
									
											parent.layer.close(index22); 
											
										}
									});
								})
							
							},
							cancel: function() {
							},
							end: function() {
							
							}
						});
					}
				};


			$('.jianjishijian').on('click', function() {
				var type = $(this).data('type');
				active[type] ? active[type].call(this) : '';
			});
			
			


		 //监听行单击事件（单击事件为：rowDouble）
//		  table.on('row(leftStock)', function(obj){
//		    var data = obj.data;
//		    
//			 $(".layui-icon").trigger("click");
//		    
//		    //标注选中样式
//		    obj.tr.addClass('layui-table-click').siblings().removeClass('layui-table-click');
//		    
//		  });
		

			
	
	});
	</script>


<!--<script src="../../../js/jquery.js" type="text/javascript"></script>
<script type="text/javascript" src="../../../js/comboselect.js"></script>
<script type="text/javascript" src="../../../js/b.comboselect.js"></script>-->
</html>
