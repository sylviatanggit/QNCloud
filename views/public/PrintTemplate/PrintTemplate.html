<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>打印模板设置</title>
		<link rel="stylesheet" href="../../../plugins/layui/css/layui.css">
		<script src="../../../js/jquery.js" type="text/javascript"></script>
	  <script src="../../../Sortable/jquery-ui.min.js"></script>
	  <style>
	  #sortable { list-style-type: none; margin: 0; padding: 0; width: 100%; font-size: 9pt !important;}
	  #sortable li { margin: 0 3px 3px 3px; padding: 0.4em; padding-left: 1.5em; font-size: 1.4em; height: 18px;cursor: pointer; }
	  #sortable li span { position: absolute; margin-left: -1.3em; display: inline-block;}
	  #sortable li div { display: inline-block;}
	  #sortable li .widthInput {width: 80px;height: 25px;padding-left: 2px;border:1px solid silver;border-radius:5px;font-size: 9pt !important;margin-right: 5px;}
	  #sortable li .lieName {width: 230px;margin-left: 15px;font-size: 9pt !important;}
	  #sortable li .widthName {width: 200px;margin-left: 10px;font-size: 9pt !important;}
	  #sortable li .selectBox input{ display: inline-block;width: 15px;height: 15px;}
	  #sortable li .nameInput {width: 220px;height: 25px;padding-left: 2px;border:1px solid silver;border-radius:5px;font-size: 9pt !important;}
 
	  #tableHeadLie { list-style-type: none; margin: 0; padding: 0; width: 100%; }
	  #tableHeadLie li { margin: 0 3px 3px 3px; padding: 0.4em; padding-left: 1.5em; font-size: 1.4em; height: 18px; }
	  #tableHeadLie li span { position: absolute; margin-left: -1.3em; display: inline-block;}
	  #tableHeadLie li div { display: inline-block;}
	  #tableHeadLie li .selectBox input{ display: inline-block;width: 15px;height: 15px;}
	  #tableHeadLie li .lieName {width: 230px;margin-left: 15px;font-size: 9pt !important;}
	  #tableHeadLie li .widthName {width: 130px;margin-left: 15px;font-size: 9pt !important;}
	  
	  
	  .danjuTypeInput {width: 230px;height: 25px;padding-left: 2px;border:1px solid silver;border-radius:5px;font-size: 9pt !important;margin-right: 5px;}
	  </style>

	</head>
	<style type="text/css">
		#addRecord {
			/*width: calc(100vw+17px);*/
			font-size: 9pt;
		}
		
		#addRecord legend {
			font-family: "PingFang" !important;
			font-size: 14px !important;
			color: #2D89DD !important;
			font-weight: 800 !important;
		}
		
		#addRecord label {
			width: 94px !important;
			font-size: 9pt !important;
			color: #232323 !important;
			padding: 0;
		}
		
		#addRecord .layui-input {
			font-size: 9pt !important;
			width: 200px !important;
			height: 28px !important;
		}
		
		.layui-input-block {
			min-height: 28px;
		}
		
		#addRecord select {
			font-size: 9pt !important;
			width: 200px !important;
			height: 28px !important;
		}
		
		#addRecord textarea {
			font-size: 9pt !important;
			width: 200px !important;
			height: 80px;
			border: 1px solid #ddd !important;
		}
		
		#addRecord .layui-form-title {
			width: 100%;
			right: 15px;
			padding-top: 5px;
			margin-bottom: -20px;
			position: fixed;
			z-index: 100;
			background-color: #FFFFFF !important;
			line-height: 32px;
			top: 0px;
		}
		
		#addRecord button {
			margin-left: 8px;
			text-align: center;
			width: 76px;
			height: 28px;
			line-height: 28px;
			float: right;
			font-family: "PingFang" !important;
			font-size: 14px !important;
			color: #FFFFFF !important;
			background-color: #2D89DD !important;
		}
		
		.current {
			background-color: #357BEA;
		}
		
		#addRecord {
			margin-bottom: 120px;
		}
		
		#addRecord .layui-table {
			border: none;
		}
		
		#addRecord .layui-table tr {
			margin-bottom: 15px !important;
			line-height: 28px !important;
		}
		
		#addRecord .layui-table td {
			border: none;
			padding: 0 !important;
			padding-bottom: 15px !important;
			line-height: 28px !important;
		}
		
		#addRecord .layui-table tbody tr td:nth-child(1) {
			text-align: right;
			width: 100px;
		}
		
		#addRecord .layui-table tbody tr td input {
			cursor: pointer;
		}
		
		#addRecord .layui-table tbody tr td:nth-child(2) {
			padding-left: 30px !important;
			width: 60px;
		}
		
		#addRecord .layui-table tbody tr td:nth-child(3) {
			width: 94px;
		}
		
		#addRecord .layui-table tbody tr td:nth-child(4) {
			width: 80px;
		}
		
		#addRecord .layui-table tbody tr td:nth-child(5) {
			width: 50px;
		}
		
		#addRecord .layui-table tbody tr td:nth-child(6) {
			width: 60px;
		}
		
		#addRecord .layui-table tbody tr td:nth-child(7) input {
			line-height: 24px !important;
		}
		
		.layui-table td {
			color: #232323 !important;
			font-size: 9pt !important;
		}
		
		.layui-table tr:nth-child(odd) {
			background-color: #FFFFFF !important;
		}
		
		.layui-table tbody tr:nth-child(even) {
			background-color: #FFFFFF !important;
		}
		
		.layui-table tbody tr:nth-child(odd) {
			background-color: #FFFFFF !important;
		}
	</style>
<script>
  $(function() {
   
					
    
    function initData(){
    	
				$.ajax({
								type: "get",
								url: localStorage.serIp + "/WebGetPrintpropertyInfo?jsoncallback=?",
								async: true,
								dataType: "jsonp",
								data: {
									"userId": localStorage.userId,
									"userPw": localStorage.userPw,
									'database': localStorage.database,
									'ordertype' : sessionStorage.ordertype
								},
								success: function(res) {
									var data = JSON.parse(res);
								
									
									var testData;
									if(data.length > 0){
										
										  testData = JSON.parse(data[0].columns);
										  $(".orderType").val(data[0].typename);
										  
									}else{
										testData = JSON.parse(sessionStorage.headjsonArrayData);
										
										$(".orderType").val(sessionStorage.orderLeiXing);
									}
									
									
								    var str = "";
									testData.forEach(function (currentValue, index, arr) {
									
											var property=currentValue.property ;
										  	var name=currentValue.name ;
										  	var width=currentValue.width != "" ? currentValue.width : "100";
										  	var checkbox = currentValue.checkbox != "" ? currentValue.checkbox : 0;
											if(checkbox ==1){
													str += '<li class="checkSelected">';
													str += '<div class="selectBox"><input type="checkbox" class="selected" checked></div>';
											}else{
													str += '<li class="checkSelect">';
													str += '<div class="selectBox"><input type="checkbox" class="selected"></div>';
											}
										
											str += '<div class="lieName" hiddenproperty="'+property+'"><input type="text" class="nameInput" value="'+name+'"></div>';
											str += '<div class="widthName"><input type="number" class="widthInput" value='+width+'>px</div>';
											str += '<div ><img src="../../../image/move.png"/></div>';

											str += "</li>"
											
											
									 });
								
									$("#sortable").append(str);
 
									$("#sortable").sortable();
									$("#sortable").disableSelection();
								
								}
										,
								error: function(res) {
									parent.layer.close(jiazaiIndex);
										
										parent.layer.open({
											title: "提示",
											content: '服务器异常!',
												zIndex: parent.layer.zIndex //重点1
								
										});
									
							
								}
							});
    }
    
    
     initData();
    $("#allSelectId").click(function(){
    	if($("#allSelectId").hasClass("allSelect")){
    		
				$("#allSelectId").attr("class","allSelected"); //是否全选
				$("#sortable li").attr("class","checkSelected");//单独li
				
			 $(".selected").prop("checked",true);
				
			}else{
				
			  $(".selected").prop("checked",false);
				  
				$("#allSelectId").attr("class","allSelect");
				$("#sortable li").attr("class","checkSelect");
			}
	
	
		});

			
					$("#sortable li").mouseover(function(){
					  $(this).css("cursor","pointer");
					});											
					$("#sortable li").mouseout(function(){
					  $(this).css("cursor","none");
					});
					
					
					
				$("#sortable li").click(function(e){
					
					  if($(this).hasClass("checkSelect")){
    						$(this).find(".selected").prop("checked",true);			
    						
    						$(this).attr("class","checkSelected");
							
						}else{
							
								$(this).find(".selected").prop("checked",false);						  
								$(this).attr("class","checkSelect");
						}
					
					});
					
  });
  </script>
	<body>
		<div id="addRecord">
			<div class="layui-form-item layui-form-title" >
				<button class="layui-btn addRecord_submit" style="font-size: 9pt !important">提交</button>
				<button class="layui-btn chongzhi" style="font-size: 9pt !important">重置</button>
			</div>
			
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 40px;">
				<legend>表头信息</legend>
			</fieldset>
			
			<div  style="padding-left: 2em;">		
				订单类型<input type="text" class="danjuTypeInput orderType" style="margin-left: 12px;">
			</div>
			
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 40px;">
				<legend>列名信息</legend>
			</fieldset>
			<ul id="tableHeadLie">
				<li><div  class="selectBox"><input type="checkbox" id="allSelectId" class="allSelect"></div><div class="lieName demx1">列名</div><div  class="widthName">宽度</div></li>

			</ul>

			<ul id="sortable">
				
			 
			</ul>

	<div style="padding-left: 2em;margin-top: 10px;">
	<p>提示：</p>
				<ul>
					<li>1：当设定宽度超过纸张宽度后,系统会自动按照设置宽度进行百分比换算得到最后列宽</li>
					<li>2：拖动行可以自定义列打印顺序</li>
					<li>3：通过修改列名,可以自定义打印列名</li>
					<li>4：通过修改订单类型,可以自定义打印订单表头</li>
				</ul>
	</div>
		</div>
	</body>
	<script src="../../../plugins/layui/layui.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		layui.use(['jquery', 'layer', "laydate"], function() {
			var $ = layui.$, //重点处
			layer = layui.layer;
		
		
			$(".chongzhi").click(function(){
				parent.layer.confirm('确认重置打印设置吗？', {
						icon: 3,	zIndex: parent.layer.zIndex, //重点1
						title: '提示'
					}, function(index) {
					
					$.ajax({
					type: "POST",
					url: localStorage.serIp + "/WebUpdatePrintpropertyInfo",  //字段不传重置
					async: true,
					dataType: 'json',
					crossDomain: true,
					contentType:'application/json; charset=utf-8',
					data:JSON.stringify({
						"userId": localStorage.userId,
						"userPw": localStorage.userPw,
						'database': localStorage.database,
//						'columns': JSON.stringify(jsonArray),
						'ordertype': sessionStorage.ordertype,
//						'typename' : typename
					}),
					success: function(res) {
						var data = JSON.parse(res);
						if(data.ResultValue == 1) {
							parent.layer.close(index);
							$("#sortable").empty();
							
							var	testData = JSON.parse(sessionStorage.headjsonArrayData);
									
							$(".orderType").val(sessionStorage.orderLeiXing);
					
							
							
						    var str = "";
							testData.forEach(function (currentValue, index, arr) {
							
									var property=currentValue.property ;
								  	var name=currentValue.name ;
								  	var width=currentValue.width != "" ? currentValue.width : "100";
								  	var checkbox = currentValue.checkbox != "" ? currentValue.checkbox : 0;
									if(checkbox ==1){
											str += '<li class="checkSelected">';
											str += '<div class="selectBox"><input type="checkbox" class="selected" checked></div>';
									}else{
											str += '<li class="checkSelect">';
											str += '<div class="selectBox"><input type="checkbox" class="selected"></div>';
									}
								
									str += '<div class="lieName" hiddenproperty="'+property+'"><input type="text" class="nameInput" value="'+name+'"></div>';
									str += '<div class="widthName"><input type="number" class="widthInput" value='+width+'>px</div>';
									str += '<div ><img src="../../../image/move.png" height="25px" width="15px"/></div>';
	
									str += "</li>"
									
									
							 });
						
							$("#sortable").append(str);
	 
							$("#sortable").sortable();
							$("#sortable").disableSelection();
							
						} else {
							parent.layer.open({
								title: "提示",
								zIndex: parent.layer.zIndex, //重点1
								content: '提交失败'
							});
						}
					}
				});
					
									
				});
	
			})
		
		
		
		
			$(".addRecord_submit").click(function() {
				
				var typename = $(".orderType").val();
				if(typename == "" || typename == null){
					parent.layer.open({
						title: "提示",
						zIndex: parent.layer.zIndex, //重点1
						content: '订单类型不能为空！'
					});
					return
				}
	
				
				//弹出层转圈圈的那个
				parent.layer.open({
				  type: 3, 
				  zIndex: parent.layer.zIndex, //重点1
				  success: function(layero, index){
				  		jiazaiIndex = index;
						}
				});
			
			
				var jsonArray =[];
				
				var flag = true;
				$("#sortable li").each(function(){
				  	
				  	var property="";
				  	var name="";
				  	var width="";
				  	var checkboxStatus = 0;
				  	
				  	property = $(this).find(".lieName").attr("hiddenproperty");
				  	name = $(this).find(".lieName").find(".nameInput").val();
					width= $(this).find(".widthInput").val();
					if( $(this).find("input[type='checkbox']").prop('checked')){
    					flag = false;
						checkboxStatus = 1;	
					}
					
					
					if(property == "qs"){
						property = "qsname"
					}
				
					
				  	var jsonObject = {
				  		"property" : property,
				  		"name" :  name,
				  		"width" : width,
				  		"checkbox" : checkboxStatus
				  	}
				  	jsonArray.push(jsonObject);
				  	
				  	
				  });
				  
				  
				  if(flag){
				  	parent.layer.open({
						title: "提示",
						zIndex: parent.layer.zIndex, //重点1
						content: '至少选择一个打印列！'
					});
					
					parent.layer.close(jiazaiIndex);
					return
				  }
				  
			  			  
			
				$.ajax({
					type: "POST",
					url: localStorage.serIp + "/WebUpdatePrintpropertyInfo",
					async: true,
					dataType: 'json',
					crossDomain: true,
					contentType:'application/json; charset=utf-8',
					data:JSON.stringify({
						"userId": localStorage.userId,
						"userPw": localStorage.userPw,
						'database': localStorage.database,
						'columns': JSON.stringify(jsonArray),
						'ordertype': sessionStorage.ordertype,
						'typename' : typename
					}),
					success: function(res) {
						parent.layer.close(jiazaiIndex);
						var data = JSON.parse(res);
						if(data.ResultValue == 1) {
							parent.layer.open({
								title: "提示",
								content: '提交成功',
								zIndex: parent.layer.zIndex, //重点1
								success: function(layero) {
									parent.layer.setTop(layero); //重点2
								},
								end: function(){  
									var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
									parent.layer.close(index); //再执行关闭     
								}
							});
						} else {
							parent.layer.open({
								title: "提示",
								zIndex: parent.layer.zIndex, //重点1
								content: '提交失败'
							});
						}
					}
				});

			})
		});
	</script>

</html>