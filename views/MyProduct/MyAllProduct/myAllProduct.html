<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>我的所有产品</title>
	<link rel="stylesheet" href="../../../plugins/layui/css/layui.css">
	<link rel="stylesheet" type="text/css" href="../../../css/comboselect.css" />
	<link rel="stylesheet" type="text/css" href="../../../css/demo.css" />
	<link rel="stylesheet" href="../../../plugins/layui/css/layui.css">
	<link href="../../../css/font-awesome.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="../../../css/same.css" />
	<!-- DevExtreme themes -->
	<link rel="stylesheet" href="../../../devexpresslibrary/css/dx.common.css">
	<link rel="stylesheet" href="../../../devexpresslibrary/css/iconStyle.css">
</head>
<style type="text/css">
	table {
		-o-text-overflow: ellipsis;
		-ms-text-overflow: ellipsis;
		text-overflow: ellipsis;
	}

	.dx-datagrid-content .dx-datagrid-table .dx-row>td,
	.dx-datagrid-content .dx-datagrid-table .dx-row>tr>td {
		padding-left: 0;
	}


	.dx-datagrid-content>img {
		margin-top: 5px;
	}

	colgroup>col:first-child {

		width: 60px !important;
	}

	.dx-col-fixed:nth-child(1) {

		width: 60px !important;
	}

	table {
		border: none;
		padding: 0 !important;
	}

	.index_content_chanpin {
		font-family: "PingFang SC" !important;
		font-size: 9pt !important;
		color: #232323 !important;
		margin: 0 20px;
		margin-top: 10px;
	}

	.layui-laypage {
		margin: 0;
		position: absolute;
		bottom: 0px;
		left: 25px;
	}

	.btns button,
	.find {
		margin-left: 10px;
		cursor: pointer;
		border: none;
		width: 76px;
		height: 28px;
		line-height: 28px;
		border-radius: 2px;
		background-color: #2D89DD;
		color: #FFFFFF;
		font-size: 9pt;
	}

	.btns {
		float: right;
	}

	.btns button {
		width: 90px;
	}

	.change {
		margin-left: 0px !important;
	}

	.inputs {
		margin-bottom: 8px;
	}

	.layui-table-cell {
		line-height: auto !important;
		height: auto !important;
	}

	.help {
		height: 1px;
	}

	.yinghangzhanghu,
	.lianxi,
	.zhengjian {
		float: left;
		width: 100px;
		display: inline-block;
		text-align: center;
	}


	.fr {
		float: right;
		margin-top: 28px;

	}

	.gsjc {
		margin-left: 12px;
	}

	.gsjc_input {
		font-size: 9pt !important;
		width: 400px !important;
		height: 28px !important;
		background: #EFF5FF;
	}


	.gsqc {
		margin-top: 20px;
	}

	.gsqc_div {
		margin-left: 20px;
		margin-top: 5px;
	}

	.gsqc1 {
		margin-top: 2px;
	}

	.nomo {
		width: 880px !important;
	}

	.tab_layui {
		box-shadow: none;
	}

	.tab_ul {
		width: 188px;
	}

	hr {
		margin-top: 44px;
	}

	.shuju_div {
		border: 1px solid #ddd;
	}

	.add {
		margin-top: 12px;
	}

	.tab_qk {
		margin-top: 18px;
		height: 29px;
		border: 1px solid #ddd;
		border-bottom: none;
		width: 350px;
		cursor: pointer;
	}

	.qyzj {
		background: #ACD8FF;
	}

	.tab_qk div {
		padding: 5px 8px;

	}

	.layui-table,
	.layui-table-view {
		margin: 0px 0px !important;
		padding-top: 0px;
	}

	.layui-table-header {
		border-width: 0px !important;
	}

	.layui-form-label {
		padding: 0px !important
	}

	.layui-inline {
		margin-top: 10px;
	}

	.cs_container_open .cs_input,
	.cs_result_area {
		width: 260px !important;
	}

	div.cs_result_area div.pagination li {
		margin: 0 5px !important;
	}

	.layui-table td,
	.layui-table th,
	.layui-table-fixed-r,
	.layui-table-header,
	.layui-table-page,
	.layui-table-tips-main,
	.layui-table-tool,
	.layui-table-view,
	.layui-table[lay-skin=row],
	.layui-table[lay-skin=line] {
		border-width: 0px !important;
		border-color: #ddd;

	}

	.laytable-cell-2-referencenum span {
		margin-left: 45px;
	}

	.zigongsi {
		pointer-events: none;
		cursor: none;
		color: none;
	}


	#referencenumStyle {
		margin-left: 45px;
	}

	tbody tr:not(:last-child):hover {
		background-color: rgba(137, 207, 240, .6) !important;
	}

	.dx-datagrid-rowsview .dx-selection.dx-row>td {
		background-color: yellow !important;
	}

	.dx-data-row,
	.dx-column-lines:not(:first-child)>td:nth-child(2) {
		cursor: pointer;
	}

	.dx-widget {
		font-size: 9pt !important;
	}

	.option>.dx-selectbox {
		display: inline-block;
		vertical-align: middle;
	}

	.layui-input {
		color: #000000;
	}

	.dx-data-row,
	.dx-column-lines>td:nth-child(2) {
		cursor: pointer;
	}

	.dx-datagrid-rowsview tbody tr td {
		padding: 0 !important;
	}
</style>

<body>
	<div class="index_content_chanpin">
		<div class="layui-tab">
			<div class="inputs">
				<div class="layui-inline" style="margin-right: 20px;margin-top: 9px;width:344px">
					<label class="layui-form-label" style="margin-right: 12px;">选择厂家</label>
					<div>
						<input autocomplete="off" class="layui-input manufacturer" id="manufacturerId" type="text" style="width: 260px;height: 28px;line-height: 28px;">
					</div>

				</div>
				<div class="layui-inline">
					<div class="layui-input-inline">
						<input onkeyup="value=value.replace(/(^\s*)|(\s*$)/g,'')" autocomplete="off" class="layui-input seachContent"
						 type="text" placeholder="请输入关键字" style="margin-left: 0;width: 240px;">
					</div>
				</div>

				<div class="layui-inline">
					<button class="layui-btn find" style="margin-left: 5px;">查询</button>
				</div>
				<div class="btns" style="margin-top: 10px;">
					<button class="layui-btn newAdd">新增</button>
					<button class="layui-btn moreAction">更多操作</button>
					<ul class="action">
						<li>
							<a class="registrationExport">导出全部</a>
						</li>
						<li>
							<a class="del" data-type="getCheckDel" lay-event='del'>批量删除</a>
						</li>
					</ul>
				</div>


			</div>
			<div class="companyInfo" style="width: 100%">

				<div class="tab_qk" style="font-size: 14px;">
					<div class="zhengjian qyzj fl" style="border-right: 1px solid #ddd;" name="0">全部</div>
					<div class="yinghangzhanghu" style="border-right: 1px solid #ddd;" name="1">即将过期</div>
					<div class="lianxi" name="2">已过期</div>
				</div>

				<div id="content_chanpin">
					<table id="index_content_chanpin" lay-filter="demo">
						<div id="gridContainer1"></div>
					</table>
				</div>


			</div>
		</div>
	</div>
</body>
<script src="../../../js/jquery.js" type="text/javascript"></script>
<!-- DevExtreme library -->
<script src="../../../devexpresslibrary/js/dx.all.js"></script>
<script src="../../../plugins/layui/layui.js"></script>
<script type="text/javascript" src="../../../js/comboselect.js"></script>
<script type="text/javascript" src="../../../js/b.comboselect.js"></script>
<script src="../../../js/public.js"></script>
<script>
	var limit = 50;
	var curpage = 1;
	var count;

	layui.use(['table', 'jquery', 'laydate', 'laypage', 'layer', 'tree', 'element'], function () {
		var table = layui.table;
		var $ = layui.jquery;
		var laypage = layui.laypage;
		var laydate = layui.laydate;
		$('.moreAction').hover(function () {
			$(".action").show();
		}, function () {
			$(".action").hide();
		});
		$('.action').hover(function () {
			$(".action").show();
		}, function () {
			$(".action").hide();
		});






		var flagType = "0";
		if (sessionStorage.myAllProductType == "YGQ") {
			$(".tab_qk div").removeClass("qyzj");
			$(".lianxi").addClass("qyzj");
			flagType = 2;
			sessionStorage.removeItem("myAllProductType");
		}


		chanpin(true)

		//切换
		$(".tab_qk div").click(function () {

			$(".tab_qk div").removeClass("qyzj");

			$(this).addClass("qyzj");

			var name = $(this).attr("name");

			switch (name) {

				case "0":

					flagType = "0";
					break;

				case "1":

					flagType = "1";
					break;

				case "2":

					flagType = "2";

					break;
			}

			chanpin(true)

		})


		$(function () {
			function getManu() {
				$.ajax({
					type: "get",
					url: localStorage.serIp + "/WebGetManufactorInfo?jsoncallback=?",
					async: true,
					dataType: 'jsonp',
					data: {
						"userId": localStorage.userId,
						"userPw": localStorage.userPw,
						'database': localStorage.database,
						'groupCompanyId': localStorage.groupcompanyid
					},
					success: function (res) {
						var data = JSON.parse(res);
						$('#manufacturerId').bComboSelect({
							showField: 'manufacturename',
							keyField: 'manufacturename',
							data: data
						});

					}
				});
			}
			getManu();
		});



		$("#manufacturerId").change(function () {
			chanpin(true)
		})

		//添加
		$(".newAdd").click(function () {
			if (!checkPermissionStatus("我的产品注册证-保存1")) {

				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return;
			}
			parent.layer.open({
				type: 2 //此处以iframe举例
				,
				title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">新增产品</span>',
				area: ['85%', '90%'],
				offset: "rb",
				content: 'views/MyProduct/MyAllProduct/xinzengchanpin.html',
				zIndex: parent.layer.zIndex //重点1
				,
				success: function (layero) {
					parent.layer.setTop(layero); //重点2
				},
				end: function () {
					chanpin(true);
				}
			});
		});



		//数据请求
		function chanpin(jumpFlag) {
			var chanpin_content = $(".seachContent").val();
			var manufacturerId = $("#manufacturerId").val();
			var jiazaiIndex;
			parent.layer.open({
				type: 3,
				zIndex: parent.layer.zIndex, //重点1
				success: function (layero, index) {
					jiazaiIndex = index;
				}
			});

			$.ajax({
				type: "get",
				url: localStorage.serIp + "/WebGetregistrationCertificate?jsoncallback=?",
				async: true,
				dataType: 'jsonp',
				data: {
					"userId": localStorage.userId,
					"userPw": localStorage.userPw,
					'database': localStorage.database,
					'txtCondition': chanpin_content,
					'num': limit,
					'page': curpage,
					'flagType': flagType,
					'manufacturerId': manufacturerId
				},
				success: function (res) {
					parent.layer.close(jiazaiIndex);

					var data = JSON.parse(res);

					count = data.count;

					var chanpin_datas = JSON.parse(data.data);

					chanpin_data(chanpin_datas, limit);


					$("#content_chanpin .layui-table-box .layui-table  thead tr:eq(0) th:eq(2) div span").attr("id", "referencenumStyle");

					if (jumpFlag) {
						chanpin_pages();
					}
				}
				,
				error: function (res) {
					parent.layer.close(jiazaiIndex);

					parent.layer.open({
						title: "提示",
						content: '服务器异常!',
						zIndex: parent.layer.zIndex //重点1

					});


				}
			});
		}



		//查询
		$(".find").click(function () {

			chanpin(true);
		})

		//查询回车事件
		$(".seachContent").bind("keydown", function (e) {
			var theEvent = e || window.event;
			var code = theEvent.keyCode || theEvent.which || theEvent.charCode;
			if (code == 13) {
				chanpin(true);
			}
		});


		// 根据可视区的高度判断
		var viewHeight = $(window).height();
		$('#gridContainer1').css('height', viewHeight * 0.8 + 'px');

		//展示已知数据
		function chanpin_data(data, limit) {
			var dataGrid = $("#gridContainer1").dxDataGrid({
				dataSource: data,
				//allowColumnReordering: true,
				showBorders: false,
				keyExpr: "id",
				columnChooser: {
					enabled: false,
					mode: "dragAndDrop",
				},
				headerFilter: {
					visible: false
				},
				sorting: {
					mode: "none"//none
				},
				filterRow: {
					visible: false,
				},
				selection: {
					mode: "multiple",
				},
				paging: {
					pageSize: 20000000,
				},
				allowColumnResizing: true,
				columnFixing: {
					enabled: false
				},
				grouping: {
					contextMenuEnabled: false,
					expandMode: "rowClick"
				},
				groupPanel: {
					visible: false
				},
				columns: [{
					dataField: "producename",
					caption: "注册证产品名称",
					//width: 200,
					fixed: true,
					
					cellTemplate: function (container, options) {
						$("<div>")
							.append($("<div style='color:#2D89DD;line-height:51px;width:200px'> " + options.value + "</div>"))
							.appendTo(container);
					}
				}
					,
				{
					dataField: "referencenum",
					caption: "注册证",
					//width:300,
					cellTemplate: function (container, options) {
						var failuredate = ""; var worning = "";

						var str = "";

						if (typeof (options.data.relation) != null) {
							var relation = options.data.relation;

							if (relation != "0") {
								relation = relation.substring((relation.length - 1), relation.length);

								switch (relation) {
									case "1":
										str += "<img src = '../../../image/line1.png' width='40px' height='46px'/>";
										break;

									case "2":
										str += "<img src = '../../../image/line2.png' width='40px' height='46px'/>";
										worning = "<span style='color: #FCB322;margin-left: 0px;'>这是老证</span>";
										break;
								}

							} else {
								str += "<div style='display: inline-block;margin-left: 40px;'>"
							}

						}



						str += "<div style='display: inline-block;text-align: left;vertical-align: middle'>"
						failuredate = options.data.failuredate;
						var registrationdate = options.data.registrationdate;

						if (failuredate == "" || failuredate == null) {

							worning = "注册证日期有缺失";

							str += chanpin_datas[i].referencenum + "<br/><span style='color:red'>！" + registrationdate + " - " + failuredate + " " + worning + "</span>";
						} else {




							var myDate = new Date();

							var currentDate = myDate.getFullYear() + '-' + (myDate.getMonth() + 1) + '-' + myDate.getDate();


							var days = diffDay(failuredate, currentDate);

							if (options.data.newregid == 0) {
								if (days > 0 && days < options.data.zhucezheng) {
									worning = "<span style='color:#FFAB39'>即将到期</span>";
								}
							}

							if (options.data.newregid == 0) {
								if (days < 0) {
									worning = "<span style='color: red''>已过期</span>";
								}

							}
							str += options.data.referencenum + "<br/>" + registrationdate + " - " + failuredate + " " + worning;
						}



						$("<div>")
							.append($("<div> " + str + "</div>"))
							.appendTo(container);


					},
				},
				{
					dataField: "productcertificate",
					caption: "产品生产许可证编号",
					width: 160,
					cellTemplate: function (container, options) {
						$("<div>")
							.append($("<div style='line-height:51px'> " + options.text + "</div>"))
							.appendTo(container);
					}
				},
				{
					dataField: "brand",
					caption: "品牌",
					width: 120,
					cellTemplate: function (container, options) {
						$("<div>")
							.append($("<div style='line-height:51px'> " + options.value + "</div>"))
							.appendTo(container);
					}
				}, {
					dataField: "originplace",
					caption: "产地/产地类型",
					//width:220,
					cellTemplate: function (container, options) {
						var originplace = options.data.addressofmanufacture;
						if (originplace == null) {
							originplace = "";
						}
						var originplacetype = options.data.originplacetype;
						if (originplacetype == 0) {
							originplacetype = "进口";
						} else {
							originplacetype = "国产";
						}
						$("<div style='line-height:10px;padding-top:10px;'>")
							.append($("<div > " + originplace + "</div>" + "<br/>" + "<div > " + originplacetype + "</div>"))
							.appendTo(container);
					}
				}, {
					dataField: "manufacturename",
					caption: "厂家",
					//width: 120,
					cellTemplate: function (container, options) {
						$("<div>")
							.append($("<div style='line-height:51px'> " + options.value + "</div>"))
							.appendTo(container);
					}
				}, {
					dataField: "count",
					caption: "产品数量",
					width: 90,
					cellTemplate: function (container, options) {
						var str;
						if (options.value == 0) {
							str = "无有效规格"
						} else {
							str = options.value + "个产品"
						}
						$("<div>")
							.append($("<div style='color:#2D89DD;line-height:51px'> " + str + "</div>"))
							.appendTo(container);

					},
				}
				],
				onCellClick: function (e) {
					var data = e.data;
					if (e.columnIndex == 1 && e.rowType == "data") {
						if (!checkPermissionStatus("我的产品注册证-保存1")) {
							parent.layer.open({
								title: "提示",
								content: localStorage.jurisdictionTips,
								zIndex: parent.layer.zIndex //重点1
								,
								success: function (layero) {
									parent.layer.setTop(layero); //重点2
								}
							});
							return;
						}


						if (sessionStorage.regid) {
							sessionStorage.removeItem("regid")
						}

						sessionStorage.regid = data.id;
						parent.layer.open({
							type: 2,
							id: 'selectUser1',
							title: "编辑产品【" + data.producename + "】 ",
							content: "views/MyProduct/MyAllProduct/editChanpin.html",
							area: ['700px', '90%'],
							offset: 'rb',
							zIndex: parent.layer.zIndex, //重点1
							success: function (layero, index11) {
								var body = layer.getChildFrame('body', 'index');

								paentIfarame = layero.find("iframe")[0].contentWindow.document;

								$(".xzcp_name", paentIfarame).val(data.producename);

								$(".xzcp_regNum", paentIfarame).val(data.referencenum);
								$(".xzcp_regTime", paentIfarame).val(data.registrationdate);
								$(".xzcp_regFailtime", paentIfarame).val(data.failuredate);
								$(".xzcp_regOvernum", paentIfarame).val(data.producesort);
								$(".manufacturename", paentIfarame).val(data.manufacturename);
								$(".zhuce_address", paentIfarame).val(data.manufactureaddress);
								$(".shengchang_address", paentIfarame).val(data.addressofmanufacture);
								$(".xzcp_power", paentIfarame).val(data.performanceandstaructureandcomponents);
								$(".xzcp_range", paentIfarame).val(data.indications);
								$(".xzcp_standards", paentIfarame).val(data.productstandards);
								$(".contraindications", paentIfarame).val(data.contraindications);
								$(".xzcp_agent", paentIfarame).val(data.agent);
								$(".xzcp_service", paentIfarame).val(data.serviceagent);
								$(".xzcp_notes", paentIfarame).val(data.notes);

								$("#newregid", paentIfarame).attr('data-id', data.newregid);
								$("#oldregid", paentIfarame).attr('data-id', data.oldregid);
								$(".productcertificate", paentIfarame).val(data.productcertificate);

								if (data.newregid == 0 || data.newregid == "") {
									$("#cancel_newProduct", paentIfarame).css("display", "none");
								} else {
									$("#cancel_newProduct", paentIfarame).css("display", " inline-block");
									$("#newregid", paentIfarame).val(data.newproducename + "(" + data.newreferencenum + ")");

								}

								if (data.oldregid != 0) {
									$("#oldregid", paentIfarame).val(data.oldproducename + "(" + data.oldreferencenum + ")");
								}


								$(".delaybegintime", paentIfarame).val(data.delaybegintime);
								$(".delayendtime", paentIfarame).val(data.delayendtime);
								$(".originplacetype", paentIfarame).val(data.originplacetype);
								$(".iscoldchain", paentIfarame).val(data.iscoldchain);
								$(".brand", paentIfarame).val(data.brand);
								var productimgpath = [];
								var imgStr = "";
								if (data.productimgpath != null && data.productimgpath != "") {
									productimgpath = data.productimgpath.split(",");
								}

								if (productimgpath != "[]" && productimgpath.length != 0) {

									$('#zhucezhengPreview', paentIfarame).empty();

									for (var j = 0; j < productimgpath.length; j++) {

										imgStr += '<div style="display: inline-block;width: auto;margin-left: 15px;margin-top: 10px;position: relative;" class="zhucezhengUploadimg"> <img src="' + productimgpath[j] + '"  class="layui-upload-img uploadImg6 arrDel6" width="120px"height="100px"><span class="removeImg6">X</span></div>';

									}

									$('#zhucezhengPreview', paentIfarame).append(imgStr);

								}



								$(".editChanpin .submit", paentIfarame).click(function () {



									var xzcp_name = $(".xzcp_name", paentIfarame).val();

									if (xzcp_name == "" || xzcp_name.length == 0) {
										parent.layer.open({
											title: "提示",
											content: '产品名称不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(jiazaiIndex);
											}
										});
										return;
									}


									var xzcp_regNum = $(".xzcp_regNum", paentIfarame).val();
									if (xzcp_regNum == "" || xzcp_regNum.length == 0) {
										parent.layer.open({
											title: "提示",
											content: '注册证号不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(jiazaiIndex);
											}
										});
										return;
									}


									var xzcp_regTime = $(".xzcp_regTime", paentIfarame).val();
									if (xzcp_regTime == "" || xzcp_regTime.length == 0) {
										parent.layer.open({
											title: "提示",
											content: '注册时间不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(jiazaiIndex);
											}
										});
										return;
									}

									var xzcp_regFailtime = $(".xzcp_regFailtime", paentIfarame).val();
									if (xzcp_regFailtime == "" || xzcp_regFailtime.length == 0) {
										parent.layer.open({
											title: "提示",
											content: '失效时间不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(jiazaiIndex);
											}
										});
										return;
									}

									var xzcp_regOvernum = $(".xzcp_regOvernum", paentIfarame).val();
									var manufacturename = $(".manufacturename", paentIfarame).val();
									if (manufacturename == "" || manufacturename.length == 0) {
										parent.layer.open({
											title: "提示",
											content: '企业名称不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(jiazaiIndex);
											}
										});
										return;
									}


									var jiazaiIndex;
									parent.layer.open({
										type: 3, zIndex: parent.layer.zIndex,	//重点1
										success: function (layero, index) {
											jiazaiIndex = index;
										}
									});

									var zhuce_address = $(".zhuce_address", paentIfarame).val();
									var shengchang_address = $(".shengchang_address", paentIfarame).val();
									var xzcp_power = $(".xzcp_power", paentIfarame).val();
									var xzcp_range = $(".xzcp_range", paentIfarame).val();
									var xzcp_standards = $(".xzcp_standards", paentIfarame).val();
									var contraindications = $(".contraindications", paentIfarame).val();
									var xzcp_agent = $(".xzcp_agent", paentIfarame).val();
									var xzcp_service = $(".xzcp_service", paentIfarame).val();
									var xzcp_notes = $(".xzcp_notes", paentIfarame).val();
									var nomo = $(".productNotes", paentIfarame).val();

									var delaybegintime = $(".delaybegintime", paentIfarame).val();
									var delayendtime = $(".delayendtime", paentIfarame).val();
									var originplacetype = $(".originplacetype", paentIfarame).val();
									if (originplacetype == "" || originplacetype == null) {
										parent.layer.open({
											title: "提示",
											content: '产地类型不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
											}
										});
										parent.layer.close(jiazaiIndex);
										return;
									}
									var iscoldchain = $(".iscoldchain", paentIfarame).val();
									var brand = $(".brand", paentIfarame).val();

									var zhucezhengImgUpload = $('#zhucezhengPreview img', paentIfarame);

									var productimgpath = "";

									var newregid = $("#newregid", paentIfarame).attr('data-id');
									var oldregid = $("#oldregid", paentIfarame).attr('data-id');

									if (typeof (zhucezhengImgUpload) != "undefined" && zhucezhengImgUpload != null) {

										for (var i = 0; i < zhucezhengImgUpload.length; i++) {
											productimgpath += zhucezhengImgUpload[i].src;

											if ((i + 1) != zhucezhengImgUpload.length) {
												productimgpath += ",";
											}
										}

									}
									var productcertificate = $(".productcertificate", paentIfarame).val();

									var rwgisterId = data.id;
									var master = {
										'newregid': '' + newregid + '',
										'oldregid': '' + oldregid + '',
										'producename': '' + xzcp_name + '',
										'referencenum': '' + xzcp_regNum + '',
										'registrationdate': '' + xzcp_regTime + '',
										'failuredate': '' + xzcp_regFailtime + '',
										'producesort': '' + xzcp_regOvernum + '',
										'manufacturename': '' + manufacturename + '',
										'manufactureaddress': '' + zhuce_address + '',
										'addressofmanufacture': '' + shengchang_address + '',
										'performanceandstaructureandcomponents': '' + xzcp_power + '',
										'indications': '' + xzcp_range + '',
										'productstandards': '' + xzcp_standards + '',
										'contraindications': '' + contraindications + '',
										'agent': '' + xzcp_agent + '',
										'serviceagent': '' + xzcp_service + '',
										'notes': '' + xzcp_notes + '',
										'delaybegintime': '' + delaybegintime + '',
										'delayendtime': '' + delayendtime + '',
										'originplacetype': '' + originplacetype + '',
										'iscoldchain': '' + iscoldchain + '',
										'brand': '' + brand + '',
										'productimgpath': productimgpath,
										'productcertificate':productcertificate

									};


									$.ajax({
										type: "post",
										url: localStorage.serIp + "/WebUpdateRegiCertProTable",
										async: true,
										dataType: 'json',
										contentType: 'application/json; charset=utf-8',
										crossDomain: true,
										data: JSON.stringify({
											"userId": localStorage.userId,
											"userPw": localStorage.userPw,
											'database': localStorage.database,
											'master': JSON.stringify(master),
											'id': rwgisterId
										}),
										success: function (res) {
											var data = JSON.parse(res);
											parent.layer.close(jiazaiIndex);
											switch (data.ResultValue) {
												case "1":

													parent.layer.open({
														title: "提示",
														content: '修改成功!',
														zIndex: parent.layer.zIndex //重点1
														,
														success: function (layero) {
															if (sessionStorage.zhucezhengImgUpload) {
																sessionStorage.removeItem("zhucezhengImgUpload");
															}
															parent.layer.setTop(layero); //重点2
														}


													});

													parent.layer.close(index11);
													break;
												case "2":
													parent.layer.open({
														title: "提示",
														content: '修改失败!',
														zIndex: parent.layer.zIndex //重点1
														,
														success: function (layero) {
															parent.layer.setTop(layero); //重点2
														}
													});
													break;

												case "3":
													parent.layer.open({
														title: "提示",
														content: '注册号已存在!',
														zIndex: parent.layer.zIndex //重点1
														,
														success: function (layero) {
															parent.layer.setTop(layero); //重点2
														}
													});
													break;

											}


											chanpin(true);
										},
										error: function () {
											parent.layer.close(jiazaiIndex);

										}
									});

								})
							},
							end: function (index, layero) {

								chanpin(true);
								if (sessionStorage.zhucezhengImgUpload) {
									sessionStorage.removeItem("zhucezhengImgUpload");
								}

								if (sessionStorage.regid) {
									sessionStorage.removeItem("regid")
								}

								parent.layer.close(index);
							},

						})
						parent.layer.open({
							type: 2,
							id: 'selectUser1',
							title: "编辑产品【" + data.producename + "】 ",
							content: "views/MyProduct/MyAllProduct/editChanpin.html",
							area: ['700px', '90%'],
							offset: 'rb',
							zIndex: parent.layer.zIndex, //重点1
							success: function (layero, index11) {
								var body = layer.getChildFrame('body', 'index');

								paentIfarame = layero.find("iframe")[0].contentWindow.document;

								$(".xzcp_name", paentIfarame).val(data.producename);

								$(".xzcp_regNum", paentIfarame).val(data.referencenum);
								$(".xzcp_regTime", paentIfarame).val(data.registrationdate);
								$(".xzcp_regFailtime", paentIfarame).val(data.failuredate);
								$(".xzcp_regOvernum", paentIfarame).val(data.producesort);
								$(".manufacturename", paentIfarame).val(data.manufacturename);
								$(".zhuce_address", paentIfarame).val(data.manufactureaddress);
								$(".shengchang_address", paentIfarame).val(data.addressofmanufacture);
								$(".xzcp_power", paentIfarame).val(data.performanceandstaructureandcomponents);
								$(".xzcp_range", paentIfarame).val(data.indications);
								$(".xzcp_standards", paentIfarame).val(data.productstandards);
								$(".contraindications", paentIfarame).val(data.contraindications);
								$(".xzcp_agent", paentIfarame).val(data.agent);
								$(".xzcp_service", paentIfarame).val(data.serviceagent);
								$(".xzcp_notes", paentIfarame).val(data.notes);

								$("#newregid", paentIfarame).attr('data-id', data.newregid);
								$("#oldregid", paentIfarame).attr('data-id', data.oldregid);


								if (data.newregid == 0 || data.newregid == "") {
									$("#cancel_newProduct", paentIfarame).css("display", "none");
								} else {
									$("#cancel_newProduct", paentIfarame).css("display", " inline-block");
									$("#newregid", paentIfarame).val(data.newproducename + "(" + data.newreferencenum + ")");

								}

								if (data.oldregid != 0) {
									$("#oldregid", paentIfarame).val(data.oldproducename + "(" + data.oldreferencenum + ")");
								}


								$(".delaybegintime", paentIfarame).val(data.delaybegintime);
								$(".delayendtime", paentIfarame).val(data.delayendtime);
								$(".originplacetype", paentIfarame).val(data.originplacetype);
								$(".iscoldchain", paentIfarame).val(data.iscoldchain);
								$(".brand", paentIfarame).val(data.brand);
								var productimgpath = [];
								var imgStr = "";
								if (data.productimgpath != null && data.productimgpath != "") {
									productimgpath = data.productimgpath.split(",");
								}

								if (productimgpath != "[]" && productimgpath.length != 0) {

									$('#zhucezhengPreview', paentIfarame).empty();

									for (var j = 0; j < productimgpath.length; j++) {
										imgStr += '<div style="display: inline-block;width: auto;margin-left: 15px;margin-top: 10px;position: relative;" class="zhucezhengUploadimg"> <img src="' + productimgpath[j] + '"  class="layui-upload-img uploadImg6 arrDel6" width="120px"height="100px"><span class="removeImg6">X</span></div>';

									}
									$('#zhucezhengPreview', paentIfarame).append(imgStr);

								}



								$(".editChanpin .submit", paentIfarame).click(function () {



									var xzcp_name = $(".xzcp_name", paentIfarame).val();

									if (xzcp_name == "" || xzcp_name.length == 0) {
										parent.layer.open({
											title: "提示",
											content: '产品名称不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(jiazaiIndex);
											}
										});
										return;
									}


									var xzcp_regNum = $(".xzcp_regNum", paentIfarame).val();
									if (xzcp_regNum == "" || xzcp_regNum.length == 0) {
										parent.layer.open({
											title: "提示",
											content: '注册证号不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(jiazaiIndex);
											}
										});
										return;
									}


									var xzcp_regTime = $(".xzcp_regTime", paentIfarame).val();
									if (xzcp_regTime == "" || xzcp_regTime.length == 0) {
										parent.layer.open({
											title: "提示",
											content: '注册时间不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(jiazaiIndex);
											}
										});
										return;
									}

									var xzcp_regFailtime = $(".xzcp_regFailtime", paentIfarame).val();
									if (xzcp_regFailtime == "" || xzcp_regFailtime.length == 0) {
										parent.layer.open({
											title: "提示",
											content: '失效时间不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(jiazaiIndex);
											}
										});
										return;
									}

									var xzcp_regOvernum = $(".xzcp_regOvernum", paentIfarame).val();
									var manufacturename = $(".manufacturename", paentIfarame).val();
									if (manufacturename == "" || manufacturename.length == 0) {
										parent.layer.open({
											title: "提示",
											content: '企业名称不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(jiazaiIndex);
											}
										});
										return;
									}


									var jiazaiIndex;
									parent.layer.open({
										type: 3, zIndex: parent.layer.zIndex,	//重点1
										success: function (layero, index) {
											jiazaiIndex = index;
										}
									});

									var zhuce_address = $(".zhuce_address", paentIfarame).val();
									var shengchang_address = $(".shengchang_address", paentIfarame).val();
									var xzcp_power = $(".xzcp_power", paentIfarame).val();
									var xzcp_range = $(".xzcp_range", paentIfarame).val();
									var xzcp_standards = $(".xzcp_standards", paentIfarame).val();
									var contraindications = $(".contraindications", paentIfarame).val();
									var xzcp_agent = $(".xzcp_agent", paentIfarame).val();
									var xzcp_service = $(".xzcp_service", paentIfarame).val();
									var xzcp_notes = $(".xzcp_notes", paentIfarame).val();
									var nomo = $(".productNotes", paentIfarame).val();

									var delaybegintime = $(".delaybegintime", paentIfarame).val();
									var delayendtime = $(".delayendtime", paentIfarame).val();
									var originplacetype = $(".originplacetype", paentIfarame).val();
									if (originplacetype == "" || originplacetype == null) {
										parent.layer.open({
											title: "提示",
											content: '产地类型不能为空!',
											zIndex: parent.layer.zIndex //重点1
											,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
											}
										});
										parent.layer.close(jiazaiIndex);
										return;
									}
									var iscoldchain = $(".iscoldchain", paentIfarame).val();
									var brand = $(".brand", paentIfarame).val();

									var zhucezhengImgUpload = $('#zhucezhengPreview img', paentIfarame);

									var productimgpath = "";

									var newregid = $("#newregid", paentIfarame).attr('data-id');
									var oldregid = $("#oldregid", paentIfarame).attr('data-id');

									if (typeof (zhucezhengImgUpload) != "undefined" && zhucezhengImgUpload != null) {

										for (var i = 0; i < zhucezhengImgUpload.length; i++) {
											productimgpath += zhucezhengImgUpload[i].src;

											if ((i + 1) != zhucezhengImgUpload.length) {
												productimgpath += ",";
											}
										}

									}

									var rwgisterId = data.id;
									var master = {
										'newregid': '' + newregid + '',
										'oldregid': '' + oldregid + '',
										'producename': '' + xzcp_name + '',
										'referencenum': '' + xzcp_regNum + '',
										'registrationdate': '' + xzcp_regTime + '',
										'failuredate': '' + xzcp_regFailtime + '',
										'producesort': '' + xzcp_regOvernum + '',
										'manufacturename': '' + manufacturename + '',
										'manufactureaddress': '' + zhuce_address + '',
										'addressofmanufacture': '' + shengchang_address + '',
										'performanceandstaructureandcomponents': '' + xzcp_power + '',
										'indications': '' + xzcp_range + '',
										'productstandards': '' + xzcp_standards + '',
										'contraindications': '' + contraindications + '',
										'agent': '' + xzcp_agent + '',
										'serviceagent': '' + xzcp_service + '',
										'notes': '' + xzcp_notes + '',
										'delaybegintime': '' + delaybegintime + '',
										'delayendtime': '' + delayendtime + '',
										'originplacetype': '' + originplacetype + '',
										'iscoldchain': '' + iscoldchain + '',
										'brand': '' + brand + '',
										'productimgpath': productimgpath
									};


									$.ajax({
										type: "post",
										url: localStorage.serIp + "/WebUpdateRegiCertProTable",
										async: true,
										dataType: 'json',
										contentType: 'application/json; charset=utf-8',
										crossDomain: true,
										data: JSON.stringify({
											"userId": localStorage.userId,
											"userPw": localStorage.userPw,
											'database': localStorage.database,
											'master': JSON.stringify(master),
											'id': rwgisterId
										}),
										success: function (res) {
											var data = JSON.parse(res);
											parent.layer.close(jiazaiIndex);
											switch (data.ResultValue) {
												case "1":
													parent.layer.open({
														title: "提示",
														content: '修改成功!',
														zIndex: parent.layer.zIndex //重点1
														,
														success: function (layero) {
															if (sessionStorage.zhucezhengImgUpload) {
																sessionStorage.removeItem("zhucezhengImgUpload");
															}
															parent.layer.setTop(layero); //重点2
														}


													});

													parent.layer.close(index11);
													break;
												case "2":
													parent.layer.open({
														title: "提示",
														content: '修改失败!',
														zIndex: parent.layer.zIndex //重点1
														,
														success: function (layero) {
															parent.layer.setTop(layero); //重点2
														}
													});
													break;

												case "3":
													parent.layer.open({
														title: "提示",
														content: '注册号已存在!',
														zIndex: parent.layer.zIndex //重点1
														,
														success: function (layero) {
															parent.layer.setTop(layero); //重点2
														}
													});
													break;

											}


											chanpin(true);
										},
										error: function () {
											parent.layer.close(jiazaiIndex);

										}
									});

								})
							},
							end: function (index, layero) {

								chanpin(true);
								if (sessionStorage.zhucezhengImgUpload) {
									sessionStorage.removeItem("zhucezhengImgUpload");
								}

								if (sessionStorage.regid) {
									sessionStorage.removeItem("regid")
								}

								parent.layer.close(index);
							},
						})

					}
					if (e.columnIndex == 7 && e.rowType == 'data') {
						if (!checkPermissionStatus("我的产品注册证-保存1")) {
							parent.layer.open({
								title: "提示",
								content: localStorage.jurisdictionTips,
								zIndex: parent.layer.zIndex //重点1
								,
								success: function (layero) {
									parent.layer.setTop(layero); //重点2
								}
							});
							return;
						}
						if (sessionStorage.productRegistrationId) {
							sessionStorage.removeItem("productRegistrationId");
						}

						if (sessionStorage.oldregid) {
							sessionStorage.removeItem("oldregid");
						}

						sessionStorage.productRegistrationId = data.id;
						sessionStorage.oldregid = data.oldregid;
						sessionStorage.manufacturename = data.brand;

						sessionStorage.referencenum = data.referencenum;
						sessionStorage.failuredate = data.failuredate;
						sessionStorage.registrationdate = data.registrationdate;
						sessionStorage.producename = data.producename;
						parent.layer.open({
							type: 2,
							id: "editGuige",
							title: "产品【" + data.producename + "】 ",
							content: "views/MyProduct/MyAllProduct/guigeList.html",
							area: ['85%', "90%"],
							offset: 'rb',
							zIndex: parent.layer.zIndex, //重点1
							success: function (layero, index) {
								var body = layer.getChildFrame('body', 'index');

								paentIfarame = layero.find("iframe")[0].contentWindow.document;

							},
							cancel: function (index, layero) {

								parent.layer.close(index)
							},
							end: function (index, layero) {
								chanpin(true);

								if (sessionStorage.productRegistrationId) {
									sessionStorage.removeItem("productRegistrationId");
								}

								if (sessionStorage.oldregid) {
									sessionStorage.removeItem("oldregid");
								}

								if (sessionStorage.manufacturer) {
									sessionStorage.removeItem("manufacturename");
								}

								if (sessionStorage.producename) {
									sessionStorage.removeItem("producename");
								}

								if (sessionStorage.registrationdate) {
									sessionStorage.removeItem("registrationdate");
								}

								if (sessionStorage.failuredate) {
									sessionStorage.removeItem("failuredate");
								}

								if (sessionStorage.referencenum) {
									sessionStorage.removeItem("referencenum");
								}
								parent.layer.close(index);
							},
						});

					}
				},
				onSelectionChanged: function (e) {
					selectedArray = [];
					selectedArray = e.selectedRowsData;
				},
			}).dxDataGrid('instance');

		}
		var selectedArray = [];
		//分页
		function chanpin_pages() {
			laypage.render({
				elem: 'index_content_chanpin', //注意，这里的 test1 是 ID，不用加 # 号
				layout: ['count', 'prev', 'page', 'next', 'limit', 'skip'],
				limits: [50, 200, 500],
				limit: limit,
				curr: curpage,
				group: 3,
				count: count, //数据总数，从服务端得到
				jump: function (obj, first) {
					curpage = obj.curr;
					limit = obj.limit;
					if (!first) {
						chanpin(false);
					}
				}
			})
		}







		//点击删除
		var $ = layui.$,
			active = {
				getCheckDel: function () { //获取选中数据
					//  alert()
					if (!checkPermissionStatus("我的产品注册证-保存1")) {

						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function (layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return

					}
					var checkStatus = table.checkStatus('myAllProductId'),
						data1 = checkStatus.data;
					var idstr = "";
					console.log(selectedArray);
					if (selectedArray.length == 0) {
						parent.layer.open({
							title: "提示",
							zIndex: parent.layer.zIndex, //重点1,
							content: '请选择要删除的数据!!!'
						});
						return;
					}
					for (var i = 0; i < selectedArray.length; i++) {
						idstr += "" + selectedArray[i].id + "";

						if ((i + 1) != selectedArray.length) {
							idstr += ",";
						}
					}
					parent.layer.confirm('确定删除吗？', {
						icon: 3,
						zIndex: parent.layer.zIndex,//重点1
						title: '删除'
					}, function (index) {
						$.ajax({
							type: "get",
							url: localStorage.serIp + "/WebDeleteregistrationCertificateOfProductsMasterTableByID?jsoncallback=?",
							async: true,
							dataType: 'jsonp',
							data: {
								"userId": localStorage.userId,
								"userPw": localStorage.userPw,
								'database': localStorage.database,
								'id': idstr
							},
							success: function (res) {
								var data = JSON.parse(res);
								var num1 = 0;
								var num2 = 0;
								for (var i = 0; i < data.length; i++) {
									var panduan = data[i].ResultValue;
									if (panduan == 1) {
										++num1;
									} else {
										++num2;
									}
								}
								parent.layer.open({
									title: "提示",
									content: num1 + '个成功 ，' + num2 + '个失败', zIndex: parent.layer.zIndex //重点1
								});

								chanpin(true);
								parent.layer.close(index);
							}
						});
					});
				}
			};



		$('.del').on('click', function () {
			var type = $(this).data('type');
			active[type] ? active[type].call(this) : '';
		});

		$(document).on("click", ".registrationExport", function () {

			if (!checkPermissionStatus("我的产品注册证-导出1")) {
				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return;
			}



			var seachContent = $(".seachContent").val();

			parent.layer.open({
				type: 3,
				zIndex: parent.layer.zIndex, //重点1,
				success: function (layero, index) {
					jiazaiIndex = index;
				}
			});

			var exportUrl = localStorage.serIp + "/WebExportRegistrationOfProductsInfo?jsoncallback=?&userId=" + localStorage.userId;
			exportUrl += "&userPw=" + localStorage.userPw + "&database=" + localStorage.database + "&filename=全部注册证" + "&txtCondition=" + seachContent;

			window.location.href = exportUrl;
			parent.layer.close(jiazaiIndex);




		});
	})
</script>

</html>