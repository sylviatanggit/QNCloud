<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title></title>
		<link rel="stylesheet" href="../../../plugins/layui/css/layui.css">
		<link rel="stylesheet" type="text/css" href="../../../css/same.css">
		<!-- DevExtreme themes -->
		<link rel="stylesheet" href="../../../devexpresslibrary/css/dx.common.css">
		<link rel="stylesheet" href="../../../devexpresslibrary/css/dx.light.css">
	</head>
	<style type="text/css">
		.index_guige {
			font-family: "PingFang SC" !important;
			font-size: 9pt !important;
			color: #232323 !important;
			margin: 0 20px;
			margin-top: 20px;
		}
				
		.layui-laypage {
			margin: 0;
			position: absolute;
			bottom: 0px;
			left: 25px;
		}
		.btns button,
		.find {
			margin-left: 10px;
			cursor: pointer;
			border: none;
			width: 76px;
			height: 28px;
			line-height: 28px;
			border-radius: 2px;
			background-color: #2D89DD;
			color: #FFFFFF;
			font-size: 9pt;
		}
		
		.btns {
			float: right;
		}
		
		.btns button {
			width: 90px;
		}
		
	
		.change {
			margin-left: 0px !important;
		}
		
		.inputs {
			margin-bottom: 8px;
		}
		
			.layui-table-cell {
			height: auto !important;
		}
		
	</style>

	<body>
		<div class="index_guige">
			<div class="layui-tab">
				<div class="inputs">
					<div class="layui-inline">
						<div class="layui-input-inline">
							<input autocomplete="off" onkeyup="value=value.replace(/(^\s*)|(\s*$)/g,'')" class="layui-input seachContent" type="text" placeholder="请输入关键字" style="margin-left: 0;width: 240px;">
						</div>
					</div>
					<div class="layui-inline">
						<button class="layui-btn find" style="margin-left: 5px;">查询</button>
					</div>
					<div class="btns">
						<button class="layui-btn layui-nav-item layui-btn-normal addGuige" style="margin-left: 0;">添加规格</button>
						
						<button class="layui-btn moreAction">更多操作</button>
						<ul class="action">
							
							
							
							<li>
								<a class="productImport">导入老证信息</a>
							</li>
							
								
							<li>
								<a class="relatedNoZhengProduct">关联无证信息</a>
							</li>
							
							<li>
								<a class="del"  data-type="cancelRelatedNoZhengProduct" lay-event='del'>取消关联产品</a>
							</li>
							
							<li>
								<a class="productExport" >导出全部</a>
							</li>
							
								
							<li>
								<a class="del" data-type="getCheckDel" lay-event='del'>批量删除</a>
							</li>
							
						</ul>
					</div>
				</div>

				<table id="index_content_guige" lay-filter="demo">
					<div id="gridContainer"></div>
				</table>
			</div>
		</div>
		
		<input autocomplete="off" class="layui-input productRegistrationId" type="hidden">
		<input autocomplete="off" class="layui-input registrationcertificatename" type="hidden">
		<input autocomplete="off" class="layui-input failuredate" type="hidden">
		<input autocomplete="off" class="layui-input registrationdate" type="hidden">
		<input autocomplete="off" class="layui-input regproducename" type="hidden">

	</body>
	<script src="../../../js/jquery.js" type="text/javascript"></script>
	<!-- DevExtreme library -->
	<script src="../../../devexpresslibrary/js/dx.all.js"></script>
	<script src="../../../plugins/layui/layui.js"></script>
	<script src="../../../js/public.js"></script>
	<script>

		layui.use(['table', 'jquery', 'laydate', 'laypage', 'layer','tree', 'element'], function() {
			var table = layui.table;
			var $ = layui.jquery;
			var laypage = layui.laypage;
			var laydate = layui.laydate;
			$('.moreAction').hover(function() {
				$(".action").show();
			}, function() {
				$(".action").hide();
			});
			$('.action').hover(function() {
				$(".action").show();
			}, function() {
				$(".action").hide();
			});

			var limit = 500;
			var curpage = 1;
			var count;
			var oldData =[];	
			var isSave = true;
							
			var registrationcertificatename=sessionStorage.referencenum;
			var regproducename = sessionStorage.producename;
		
			var failuredate=sessionStorage.failuredate;
			var registrationdate =sessionStorage.registrationdate;
			var regId = sessionStorage.productRegistrationId;

			allguige(true);
			
			//数据请求
			function allguige(jumpFlag) {
				var chanpin_content = $(".seachContent").val();
				var regId1 = $(".productRegistrationId").val() != null ? $(".productRegistrationId").val() : sessionStorage.productRegistrationId;

				$.ajax({
					type: "get",
					url: localStorage.serIp+"/WebGetProduceInfoByReg?jsoncallback=?",
					async: true,
					dataType: 'jsonp',
					data: {
						"userId": localStorage.userId,
						"userPw": localStorage.userPw,
						'database': localStorage.database,
						'searchName': chanpin_content,
						'produceproperty':-1,
						'producettype':-1,
						'num': limit,
						'page': curpage,
						'regId': sessionStorage.productRegistrationId
					},
					success: function(res) {
						var data = JSON.parse(res);
						count = data.count;
						
						var chanpin_datas = JSON.parse(data.data);
						
					
						oldData= chanpin_datas;
						
						edit_Chanpinguige(chanpin_datas, limit);


									
					$("[data-field=regproducename] div:gt(0)").each(function(i) {
							var str = "";
							
							var regproducename = chanpin_datas[i].regproducename;
							if(regproducename == null){
								regproducename ="";
							}
							
							var registrationcertificatename = chanpin_datas[i].registrationcertificatename;
							if(registrationcertificatename == null){
								registrationcertificatename ="";
							}
							
							
							str = regproducename + "<br/>"+registrationcertificatename;
					
							$(this).html(str);
							
					})
								
						
						$("[data-field=danwei] div:gt(0)").each(function(i) {
							 $(this).html(chanpin_datas[i].danwei + "<br />" +chanpin_datas[i].producemodel);

						});
						
						$("[data-field=package] div:gt(0)").each(function(i) {
							$(this).html(chanpin_datas[i].produceunit + "<br />" +chanpin_datas[i].package);
						})
						
						$("[data-field=storagecondition] div:gt(0)").each(function(i) {
							var storagewarehousename = chanpin_datas[i].storagewarehousename;
							if(storagewarehousename == null){
								storagewarehousename ="";
							}
							
							$(this).html(chanpin_datas[i].storagecondition + "<br />" +storagewarehousename);
						})
						
						$("[data-field=conservationcategory] div:gt(0)").each(function(i) {
							var conservationcategory = chanpin_datas[i].conservationcategory;
							if(conservationcategory == null){
								conservationcategory ="";
							}
							
							$(this).html(chanpin_datas[i].conservationcategoryname + "<br />" +chanpin_datas[i].transportationname);
						})
						
						
						$("[data-field=manufacturer] div:gt(0)").each(function(i) {
							var manufacturer = chanpin_datas[i].manufacturer;
							if(manufacturer == null){
								manufacturer = "";
							}
							
							
							var manufacturename = chanpin_datas[i].manufacturename;
							if(manufacturename == null){
								manufacturename = "";
							}
								
							 $(this).html(manufacturer+ "<br />" +manufacturename);

						});
						
					
					
						if(jumpFlag) {
							guige_pages();
						}
					}
				});
			}
			
			
			//查询
			$(".find").click(function() {
			
				allguige(true);
			})
			
			//查询回车事件
			$(".seachContent").bind("keydown",function(e){
			　　  var theEvent = e || window.event;
			　　  var code = theEvent.keyCode || theEvent.which || theEvent.charCode;
			　　   if (code == 13) {
					allguige(true);
			　　  }
			});
			
	
				
				
			
			//导入老证信息
			$(".productImport").click(function() {
								if(!checkPermissionStatus("我的产品注册证-保存1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return;
					}
					var jiazaiIndex;
					if(oldData.length >0){
						parent.layer.open({
							title: "提示",
							content: '已有产品信息，不能导入老证信息！' ,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
					}
					
				
					parent.layer.open({
						type: 2,
						title: "老证产品信息 ",
						content: "views/MyProduct/MyAllProduct/drlz.html", 
						area: ['85%', "90%"],
						offset: 'rb',
						zIndex: parent.layer.zIndex, //重点1
						success: function(layero, index) {
							var body = layer.getChildFrame('body', 'index');

							paentIfarame = layero.find("iframe")[0].contentWindow.document;

							
						},
					
						end: function(index, layero) {
							allguige(true) 
							parent.layer.close(index)

						},
					});	
			})
			
			
			//关联无证信息
			$(".relatedNoZhengProduct").click(function() {
				
				if(!checkPermissionStatus("我的产品注册证-保存1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
						
					}
				parent.layer.open({
					type: 2,
					title: "无证产品信息 ",
					content: "views/MyProduct/MyAllProduct/glxzp.html", 
					area: ['85%', "90%"],
					offset: 'rb',
					zIndex: parent.layer.zIndex, //重点1
					success: function(layero, index) {
						var body = layer.getChildFrame('body', 'index');

						paentIfarame = layero.find("iframe")[0].contentWindow.document;

						
					},
				
					end: function(index, layero) {
						if(sessionStorage.oldregid){
							sessionStorage.removeItem('oldregid')
						}
						
					
						allguige(true) 
						parent.layer.close(index)

					},
				});	
			})
			
			// 根据可视区的高度判断
		var viewHeight = $(window).height();
		$('#gridContainer').css('height', viewHeight * 0.87 + 'px');
	
			edit_Chanpinguige(null, 1000)
			//展示已知数据
			function edit_Chanpinguige(data, limit) {
				$(function () {
			var dataGrid = $("#gridContainer").dxDataGrid({
				dataSource: data,
				columnAutoWidth: true,
				showBorders: true,
				paging: {
					pageSize: 200,
				},
				sorting: {
					mode: "none"//none
				},
				selection: {
					mode: "multiple"
				},
				filterRow: {
					visible: false,
					applyFilter: "auto"
				},
				headerFilter: {
					visible: false
				},
				allowColumnResizing: true,
				columnFixing: {
					enabled: false
				},
				columns: [{
					dataField: "producename",
					width: 160,
					caption: "产品名称",
					allowEditing: false,
					cellTemplate:function(container,options){
						$("<div>")
							.append($("<div style='color:#2D89DD'> " + options.value + "</div>"))
							.appendTo(container);
					}
				}
				,
				{
						dataField: "danwei",
						caption: "规格/型号",
						allowEditing: false,
						cellTemplate: function (container, options) {
							$("<div>")
								.append($("<div>" + options.value + "</div>" + "</br>" + "<div>" + options.data.producemodel + "</div>"))
								.appendTo(container);
						}
					},
				{
					dataField: 'producenum',
					caption: '产品编号',
					allowEditing: false,
				},
				{
					dataField: 'producecode',
					caption: '主条码',
					allowEditing: false,
				},{
						dataField: "package",
						width: 80,
						caption: "单位/包装",
						cellTemplate: function (container, options) {
							$("<div>")
								.append($("<div>" + options.data.produceunit + "</div>" + "</br>" + "<div>" + options.data.package + "</div>"))
								.appendTo(container);
						},
						allowEditing: false,
					},
					{
						dataField: "producepropertyname",
						width: 70,
						caption: "产品种类",
						allowEditing: false,
						cellTemplate: function (container, options) {
							$("<div>")
								.append($("<div>" + options.value + "</div>"))
								.appendTo(container);

						}
					}, {
						dataField: "produceseries",
						width: 120,
						caption: "系列",
						allowEditing: false,
						cellTemplate: function (container, options) {
							$("<div>")
								.append($("<div>" + options.value + "</div>"))
								.appendTo(container);
						}
					}, {
						dataField: "produceusename",
						width: 120,
						caption: "通俗名称",
						allowEditing: false,
						cellTemplate: function (container, options) {
							if (options.value == '' && options.value == null) {
								$("<div>")
									.append($("<div></div>"))
									.appendTo(container);
							} else {
								$("<div>")
									.append($("<div> " + options.text + "</div>"))
									.appendTo(container);
							}

						}
					}
					, {
						dataField: "producematerial",
						width: 60,
						caption: "材质",
						allowEditing: false,
						cellTemplate: function (container, options) {
							if (options.value == '' && options.value == null) {
								$("<div>")
									.append($("<div></div>"))
									.appendTo(container);
							} else {
								$("<div>")
									.append($("<div> " + options.text + "</div>"))
									.appendTo(container);
							}

						}
					}, {
						dataField: "producettypename",
						width: 70,
						caption: "产品属性",
						allowEditing: false,
					}, {
						dataField: "manufacturer",
						width: 180,
						caption: "品牌/厂家",
						allowEditing: false,
						cellTemplate: function (container, options) {
							var manufacturer = options.data.manufacturer;
							var manufacturename = options.data.manufacturename;
							if (manufacturer && manufacturename) {
								$("<div>")
									.append($("<div>" + manufacturer + "</div>" + "</br>" + "<div>" + manufacturename + "</div>"))
									.appendTo(container);
							} else if (!manufacturer && manufacturename) {
								$("<div>")
									.append($("<div>" + "</div>" + "</br>" + "<div>" + manufacturename + "</div>"))
									.appendTo(container);
							} else if (!manufacturename && manufacturer) {
								$("<div>")
									.append($("<div>" + manufacturer + "</div>" + "</br>" + "<div>" + "</div>"))
									.appendTo(container);
							} else {
								$("<div>")
									.append($("<div>" + "</div>" + "</br>" + "<div>" + "</div>"))
									.appendTo(container);
							}

						}
					}
						, {
						dataField: "regproducename",
						width: 220,
						caption: "注册证产品名称/注册证号",
						allowEditing: false,
						cellTemplate: function (container, options) {
							var producename = options.data.regproducename;
							var certificate = options.data.registrationcertificatename
                            if(producename == null){
								producename = '';
							}
							if(certificate == null){
                               certificate = '';
							}
							var str = certificate + producename;

								$("<div>")
									.append($("<div> " + str + "</div>"))
									.appendTo(container);

						}
					}, {
						dataField: "storagecondition",
						width: 130,
						caption: "存储方式／仓库类型",
						allowEditing: false,
						cellTemplate: function (container, options) {
							$("<div>")
								.append($("<div>" + options.data.storagecondition + "</div>" + "</br>" + "<div>" + options.data.storagewarehousename + "</div>"))
								.appendTo(container);
						}
					}
						, {
						dataField: "conservationcategory",
						width: 120,
						caption: "养护要求/运输要求",
						allowEditing: false,
						cellTemplate: function (container, options) {
							$("<div>")
								.append($("<div>" + options.data.conservationcategoryname + "</div>" + "</br>" + "<div>" + options.data.transportationname + "</div>"))
								.appendTo(container);
						}
					}, {
						dataField: "safecount",
						width: 80,
						caption: "安全库存",
						allowEditing: false,
						cellTemplate: function (container, options) {
							if (options.value == '' && options.value == null) {
								$("<div>")
									.append($("<div></div>"))
									.appendTo(container);
							} else {
								$("<div>")
									.append($("<div> " + options.text + "</div>"))
									.appendTo(container);
							}

						}
					}, {
						dataField: "lowerlimit",
						width: 90,
						caption: "安全库存下限",
						allowEditing: false,
						cellTemplate: function (container, options) {
							if (options.value == '' && options.value == null) {
								$("<div>")
									.append($("<div></div>"))
									.appendTo(container);
							} else {
								$("<div>")
									.append($("<div> " + options.text + "</div>"))
									.appendTo(container);
							}

						}
					},
					{
						dataField: "upperlimit",
						width: 90,
						caption: "安全库存上限",
						allowEditing: false,
						cellTemplate: function (container, options) {
							if (options.value == '' && options.value == null) {
								$("<div>")
									.append($("<div></div>"))
									.appendTo(container);
							} else {
								$("<div>")
									.append($("<div> " + options.text + "</div>"))
									.appendTo(container);
							}
						}
					}
				]
				,
				onSelectionChanged:function(e){
				selectedArray = [];
				selectedArray = e.selectedRowsData;
				},
				onCellClick:function(e){
					var data = e.data;
					if (e.columnIndex == 1 && e.rowType == "data") {
                        if(!checkPermissionStatus("我的产品注册证-保存1")){
					
					parent.layer.open({
						title: "提示",
						content: localStorage.jurisdictionTips,
						zIndex: parent.layer.zIndex //重点1
						,
						success: function(layero) {
							parent.layer.setTop(layero); //重点2
						}
					});
					return
					
				};
				if(!isSave){
						parent.layer.open({
							title: "提示",
							content: '导入老证信息后必须先保存才能编辑!' ,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return;
					}

                     	if(sessionStorage.productGuiGeImgUpload){
						sessionStorage.removeItem("productGuiGeImgUpload")
					}
					var regId = data.registrationcertificateid != null ? data.registrationcertificateid :"";

					parent.layer.open({
						type: 2,
						id: 'selectUser1',
						title: "编辑规格【" + data.producename + "】 ",
						content: "views/MyProduct/MyAllGuiGe/editGuige_edit.html", 
						area: ['700px', '90%'],
						offset: 'rb',zIndex: parent.layer.zIndex, //重点1
						success: function(layero, index11) {
							var body = layer.getChildFrame('body', 'index');

							var paentIfarame = layero.find("iframe")[0].contentWindow.document;
							
							var zhengjianInfo = data.registrationcertificatename;
							
							if(typeof(data.registrationdate) != "undefined"  && data.registrationdate != null){
								zhengjianInfo += "   " + data.registrationdate.substring(0,10);
							}
							
									
							if(regId == 0){
								$(".manufacturer", paentIfarame).removeAttr("disabled");
							}else{
									$(".manufacturer", paentIfarame).attr("disabled","disabled");
							}
							
							if(typeof(data.failuredate) != "undefined"  && data.failuredate != null){
								zhengjianInfo += " — " +data.failuredate.substring(0,10);
							}
							$(".editGuige_edit_reginfo", paentIfarame).val(zhengjianInfo);

							$(".editGuige_edit_regname", paentIfarame).val(data.regproducename);

//							$(".registrationCertificateID", paentIfarame).val(data.registrationcertificateid);
							$(".productId", paentIfarame).val(data.id);

							$(".produceName", paentIfarame).val(data.producename);
							$(".manufacturer", paentIfarame).val(data.manufacturer);
							

							
							$(".produceusename", paentIfarame).val(data.produceusename);
							$(".produceseries", paentIfarame).val(data.produceseries);
							$(".danwei", paentIfarame).val(data.danwei);
							$(".producenum", paentIfarame).val(data.producenum);
							$(".producemodel", paentIfarame).val(data.producemodel);
							$(".produceCode", paentIfarame).val(data.producecode);
							$(".produceunit", paentIfarame).val(data.produceunit);
							$(".package", paentIfarame).val(data.package);
							$(".producematerial", paentIfarame).val(data.producematerial);
							$(".safecount", paentIfarame).val(data.safecount);
							$(".upperlimit", paentIfarame).val(data.upperlimit);
							$(".lowerlimit", paentIfarame).val(data.lowerlimit);
							$(".nomo", paentIfarame).val(data.nomo);

							$(".storagewarehouse",paentIfarame).find("option[value="+data.storagewarehouse+"]").attr("selected",true) //仓库类型
							$(".conservationcategory",paentIfarame).find("option[value="+data.conservationcategory+"]").attr("selected",true) //一般养护
							$(".transportation",paentIfarame).find("option[value="+data.transportation+"]").attr("selected",true) //运输要求
//							$(".storagecondition",paentIfarame).find("option[value="+data.storagecondition+"]").attr("selected",true) //存储方式
							$(".produceproperty",paentIfarame).find("option[value="+data.produceproperty+"]").attr("selected",true) //产品种类
							$(".storagecondition",paentIfarame).val(data.storagecondition) //存储方式

							var productimgpath =[];	var imgStr = "";

							if(data.photoaddress != null && data.photoaddress !=""){
								productimgpath = data.photoaddress.split(",");
							}
						
							if(productimgpath != "[]" && productimgpath.length !=0){
								$('#productGuiGeimgPreview',paentIfarame).empty();
								var zhucezhengImg =[];
								for(var j=0;j< productimgpath.length;j++){
									 imgStr += '<div style="display: inline-block;width: auto;margin-left: 15px;margin-top: 10px;position: relative;" class="zhucezhengUploadimg"> <img src="' + productimgpath[j] + '"  class="layui-upload-img uploadImg6 arrDel6" width="120px"height="100px"><span class="removeImg6">X</span></div>';

							
								}
						
								$('.editGuige_edit #productGuiGeimgPreview',paentIfarame).append(imgStr);

							}
							
							
							$(".editGuige_edit .editGuige_edit_submit", paentIfarame).click(function() {
								
								var productId =	$(".productId", paentIfarame).val();

							
								var produceName = $(".produceName", paentIfarame).val();
								if(produceName == "" || produceName.length ==0){
									parent.layer.open({
										title: "提示",
										content: '名称不能为空!' ,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function(layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return;
								}
								//注册证产品名称
								if($(".editGuige_edit_regname").val() == "" || produceName.length ==0){
									parent.layer.open({
										title: "提示",
										content: '注册证产品名称不能为空!' ,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function(layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return;
								}	
								//证件信息
								if($(".editGuige_edit_reginfo").val() == "" || produceName.length ==0){
									parent.layer.open({
										title: "提示",
										content: '证件信息不能为空!' ,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function(layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return;
								}		
								var manufacturer = $(".manufacturer", paentIfarame).val();
								if(manufacturer == "" || manufacturer.length ==0){
									parent.layer.open({
										title: "提示",
										content: '品牌不能为空!' ,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function(layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return;
								}
								
					
								var produceseries = $(".produceseries", paentIfarame).val();
								if(produceseries == "" || produceseries.length ==0){
									parent.layer.open({
										title: "提示",
										content: '系列不能为空!' ,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function(layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return;
								}
								
								var produceunit = $(".produceunit", paentIfarame).val();
								if(produceseries == "" || produceseries.length ==0){
									parent.layer.open({
										title: "提示",
										content: '单位不能为空!' ,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function(layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return;
								}
								
												
								var  jiazaiIndex;
								parent.layer.open({
								  type: 3, zIndex: parent.layer.zIndex ,	//重点1
								  success: function(layero, index){
								  	jiazaiIndex = index;
						  			}
								});
								
								
								var danwei = $(".danwei", paentIfarame).val();
								var producettype = $(".producettype", paentIfarame).val();
								var producemodel = $(".producemodel", paentIfarame).val();
								var producematerial = $(".producematerial", paentIfarame).val();
						
									
								var producenum = $(".producenum", paentIfarame).val();
								var produceCode = $(".produceCode", paentIfarame).val();
								var registrationCertificateID = $(".registrationCertificateID", paentIfarame).val();
					
								
								var safecount = $(".safecount", paentIfarame).val();
								var upperlimit = $(".upperlimit", paentIfarame).val();
								var lowerlimit = $(".lowerlimit", paentIfarame).val();
								var nomo = $(".nomo", paentIfarame).val();
								
								var package1 = $(".package", paentIfarame).val();
								var produceusename = $(".produceusename", paentIfarame).val();

								var productGuiGeImgUpload = $('.editGuige_edit #productGuiGeimgPreview img',paentIfarame);
								var photoaddress = "";

								if(typeof(productGuiGeImgUpload) != "undefined" && productGuiGeImgUpload !=null){
	
									for(var i=0;i<productGuiGeImgUpload.length;i++){
										photoaddress += productGuiGeImgUpload[i].src;
										
										if((i+1) != productGuiGeImgUpload.length){
											photoaddress += ",";
										}
									}
								}
								
								var storagewarehouse=$(".storagewarehouse",paentIfarame).find("option:checked").attr("value") //仓库类型
								var conservationcategory=$(".conservationcategory",paentIfarame).find("option:checked").attr("value") //一般养护
								var transportation=$(".transportation",paentIfarame).find("option:checked").attr("value") //运输要求
								var storagecondition=$(".storagecondition",paentIfarame).val() //存储方式
								var produceproperty=$(".produceproperty",paentIfarame).find("option:checked").attr("value") //产品种类
								
								
								var master = {
									'produceName': '' + produceName + '',
									'manufacturer': '' + manufacturer + '',
									'produceunit': '' + produceunit + '',
									'danwei': '' + danwei + '',
									'producettype': '' + producettype + '',
									'producemodel': '' + producemodel + '',
									'producematerial': '' + producematerial + '',
									'produceusename': '' + produceusename + '',
									'produceseries': '' + produceseries + '',
									'producenum': '' + producenum + '',
									'produceCode': '' + produceCode + '',
									'registrationCertificateID': '' + regId + '',
//									'father': '' + father + '',
									'safecount': '' + safecount + '',
									'upperlimit': '' + upperlimit + '',
									'lowerlimit': '' + lowerlimit + '',
									'nomo': '' + nomo + '',
									'storagecondition': '' + storagecondition + '',
									'package': '' + package1 + '',
									'photoaddress': '' + photoaddress + '',
									'produceproperty': ''+produceproperty+'',
									'transportation': '' + transportation + '',
									'conservationcategory': '' + conservationcategory + '',
									'storagewarehouse': '' + storagewarehouse + ''

								};
								
								
								$.ajax({
									type: "post",
									url: localStorage.serIp  +"/WebUpdateProduceTable",
									async: true,
									dataType: 'json',
									contentType:'application/json; charset=utf-8',
									crossDomain:true,
									data:  JSON.stringify({
										"userId": localStorage.userId,
										"userPw": localStorage.userPw,
										'database': localStorage.database,
//										'groupCompanyId': localStorage.groupcompanyid,
										'produce': JSON.stringify(master),
										'produceid': productId
									}),
									success: function(res) {
										var data = JSON.parse(res);
											parent.layer.close(jiazaiIndex); 
										if(data.ResultValue == "1"){
											parent.layer.open({
												title: "提示",
												content: '修改成功',
												zIndex: parent.layer.zIndex //重点1
												,
												success: function(layero) {
													parent.layer.setTop(layero); //重点2
												}
											});
			
											allguige(true);
											
												parent.layer.close(index11); 

										}else{
											parent.layer.open({
												title: "提示",
												content: '修改失败：' + data.ResultValue,
												zIndex: parent.layer.zIndex //重点1
												,
												success: function(layero) {
													parent.layer.setTop(layero); //重点2
												}
											});
										}
										
									},
									error: function() {
										parent.layer.close(jiazaiIndex); 		
										
									}
								});
								
							})
						}

					})


					}
				},
				onContentReady: function (e) {
					var visibleRows = e.component.getVisibleRows()
					visibleRowsArr = [];
					$.each(visibleRows,function(v,i,arr){
						visibleRowsArr.push(i.data);
					})
				}
			}).dxDataGrid('instance');
		});
			}

			var selectedArray = [];
			//分页
			function guige_pages() {
				laypage.render({
					elem: 'index_content_guige', //注意，这里的 test1 是 ID，不用加 # 号
					layout: ['count', 'prev', 'page', 'next', 'limit', 'skip'],
					limits: [500,1000],
					limit: limit,
					curr: curpage,
					group: 2,
					count: count, //数据总数，从服务端得到
					jump: function(obj,first) {
						curpage = obj.curr;
						limit = obj.limit;
						 //首次不执行
					    if(!first){
					    	allguige(false);
					    }
				
					}
				})
			}

		   	//点击删除
			var $ = layui.$,
				active = {
					getCheckDel: function() { //获取选中数据
						if(!checkPermissionStatus("我的产品注册证-保存1")){
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
						
					}
						var checkStatus = table.checkStatus('editGuige'),
						data1 = checkStatus.data;
						
						if(selectedArray.length ==0){
							parent.layer.open({
								title: "提示",
								content: '请选择要删除的产品信息!' ,
								zIndex: parent.layer.zIndex //重点1
								,
								success: function(layero) {
									parent.layer.setTop(layero); //重点2
								}
							});
							return;
						}
							
						if(!isSave){
							parent.layer.open({
								title: "提示",
								content: '导入老证信息后必须先保存才能删除!' ,
								zIndex: parent.layer.zIndex //重点1
								,
								success: function(layero) {
									parent.layer.setTop(layero); //重点2
								}
							});
							return;
						}
						
					
						var idstr = "";
					    for(var i=0;i<selectedArray.length;i++) { 
				      		idstr += ""+selectedArray[i].id + "";
		
				      		if((i+1)!=selectedArray.length){
				      			idstr += ",";
				      		}
						}
						parent.layer.confirm('确定删除吗？', {
							icon: 3,
							title: '删除',
							zIndex: parent.layer.zIndex //重点1
						}, function(index) {
							
							var jiazaiIndex;
							parent.layer.open({
								  type: 3, 
								  zIndex: parent.layer.zIndex, //重点1,
								  success: function(layero, index){
								  		jiazaiIndex = index;
						  			}
								});
				
							$.ajax({
								type: "get",
								url: localStorage.serIp+"/WebDeleteProduceByID?jsoncallback=?",
								async: true,
								dataType: 'jsonp',
								data: {
									"userId": localStorage.userId,
									"userPw": localStorage.userPw,
									'database': localStorage.database,
									'id': idstr
								},
								success: function(res) {
									var data = JSON.parse(res);
									var num1=0;
									var num2=0;
									for(var i=0;i<data.length;i++){
										var panduan=data[i].ResultValue;
										if(panduan == 1){
											++num1;
										}else{
											++num2;
										}
									}
									parent.layer.open({
										title: "提示",
										content: num1+'个成功 ，'+num2+'个失败',zIndex: parent.layer.zIndex //重点1
									});
										allguige(true);
									parent.layer.close(jiazaiIndex);

								}
							});
						
							
						});
					},
					
					cancelRelatedNoZhengProduct: function(){
										if(!checkPermissionStatus("我的产品注册证-保存1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
						
					}
										
						var checkStatus = table.checkStatus('editGuige'),
						data1 = checkStatus.data;
						
						if(selectedArray.length ==0){
							parent.layer.open({
								title: "提示",
								content: '请选择产品!' ,
								zIndex: parent.layer.zIndex //重点1
								,
								success: function(layero) {
									parent.layer.setTop(layero); //重点2
								}
							});
							return;
						}
						
						var jiazaiIndex;
						parent.layer.open({
							  type: 3, 
							  zIndex: parent.layer.zIndex, //重点1,
							  success: function(layero, index){
							  		jiazaiIndex = index;
					  			}
							});
								
						var idstr = "";
					    for(var i=0;i<selectedArray.length;i++) { 
				      		idstr += ""+selectedArray[i].id + "";
		
				      		if((i+1)!=selectedArray.length){
				      			idstr += ",";
				      		}
						}
					    
					    
						  $.ajax({
							type: "post",
							url:  localStorage.serIp  +"/WebCorrelationNoRegProduct",
							async: true,
							contentType:'application/json; charset=utf-8',
							crossDomain:true,
							dataType: 'json',
							data: JSON.stringify({
								'userId': localStorage.userId,
								'userPw': localStorage.userPw,
								'database': localStorage.database,
								'productList': idstr,
								'regid' :"0"
							}),
							success: function(res) {
								var data = JSON.parse(res);
	
								parent.layer.close(jiazaiIndex); //再执行关闭     	
								if(data.ResultValue == 1) {
									
		
									parent.layer.open({
										title: "提示",
										content: '取消成功',zIndex: parent.layer.zIndex, //重点1
		
									});
									
									allguige(true);
									
								} else {
									parent.layer.open({
										title: "提示",
										content: '取消失败',								
										zIndex: parent.layer.zIndex, //重点1
		
									});
								}
		
								
							},
							error: function() {
							
								parent.layer.close(jiazaiIndex); 		
								
							}
						}) 
						
					}
				};


			$('.del').on('click', function() {
				var type = $(this).data('type');
				active[type] ? active[type].call(this) : '';
			});
		   
		   
		   	//添加规格
			$(".index_guige .addGuige").click(function() {
								if(!checkPermissionStatus("我的产品注册证-保存1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return;
					}
								
					if(!isSave){
						parent.layer.open({
							title: "提示",
							content: '导入老证信息后必须先保存才能添加!' ,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return;
					}
					
			
					if(sessionStorage.productGuiGeImgUpload){
						sessionStorage.removeItem("productGuiGeImgUpload")
					}
					
						var zhengjianInfo = registrationcertificatename;

						if(typeof(registrationdate) != ""  && registrationdate != null){
							zhengjianInfo += "   " + registrationdate.substring(0,10);
						}
						
						if(typeof(failuredate) != ""  && failuredate != null){
							zhengjianInfo += " — " +failuredate.substring(0,10);
						}
					
					parent.layer.open({
						type: 2,
						id: 'addProductGuiGeId',
						title: "添加规格 ",
						content: "views/MyProduct/MyAllGuiGe/add_GuiGe.html", 
						area: ['700px', '90%'],
						offset: 'rb',
						zIndex: parent.layer.zIndex, //重点1
						success: function(layero, index11) {
							var body = layer.getChildFrame('body', 'index');

							var paentIfarame = layero.find("iframe")[0].contentWindow.document;
							
					
							$(".editGuige_edit_reginfo", paentIfarame).val(zhengjianInfo);


							$(".editGuige_edit_regname", paentIfarame).val(regproducename);
							
							//品牌
							$(".manufacturer", paentIfarame).val(sessionStorage.manufacturename);
							
							$(".add_guige .submit", paentIfarame).click(function() {
								var produceName = $(".produceName", paentIfarame).val();
								if(produceName == "" || produceName.length ==0){
									parent.layer.open({
										title: "提示",
										content: '名称不能为空!' ,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function(layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return;
								}
											
								var manufacturer = $(".manufacturer", paentIfarame).val();
								if(manufacturer == "" || manufacturer.length ==0){
									parent.layer.open({
										title: "提示",
										content: '品牌不能为空!' ,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function(layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return;
								}
																
								var produceseries = $(".produceseries", paentIfarame).val();
								if(produceseries == "" || produceseries.length ==0){
									parent.layer.open({
										title: "提示",
										content: '系列不能为空!' ,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function(layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return;
								}
								
								var produceunit = $(".produceunit", paentIfarame).val();
								if(produceseries == "" || produceseries.length ==0){
									parent.layer.open({
										title: "提示",
										content: '单位不能为空!' ,
										zIndex: parent.layer.zIndex //重点1
										,
										success: function(layero) {
											parent.layer.setTop(layero); //重点2
										}
									});
									return;
								}
								
												
				
								var  jiazaiIndex;
								parent.layer.open({
								  type: 3, zIndex: parent.layer.zIndex ,	//重点1
								  success: function(layero, index){
								  	jiazaiIndex = index;
						  			}
								});
					
					
					
								var danwei = $(".danwei", paentIfarame).val();
								var producettype = $(".producettype", paentIfarame).val();
								var producemodel = $(".producemodel", paentIfarame).val();
								var producematerial = $(".producematerial", paentIfarame).val();
						
									
								var producenum = $(".producenum", paentIfarame).val();
								var produceCode = $(".produceCode", paentIfarame).val();
								var registrationCertificateID = $(".registrationCertificateID", paentIfarame).val();
					
								
								var safecount = $(".safecount", paentIfarame).val();
								var upperlimit = $(".upperlimit", paentIfarame).val();
								var lowerlimit = $(".lowerlimit", paentIfarame).val();
								var nomo = $(".nomo", paentIfarame).val();
								var storagecondition = $(".storagecondition", paentIfarame).val();
								
								var package1 = $(".package", paentIfarame).val();
								var produceusename = $(".produceusename", paentIfarame).val();

								var productGuiGeImgUpload = $('.add_guige #productGuiGeimgPreview img',paentIfarame);
								var photoaddress = "";
								
								if(typeof(productGuiGeImgUpload) != "undefined" && productGuiGeImgUpload !=null){
									for(var i=0;i<productGuiGeImgUpload.length;i++){
									photoaddress += productGuiGeImgUpload[i].src;
									if((i+1) != productGuiGeImgUpload.length){
										photoaddress += ",";
									}
									}
								}
								//后来加的
								var storagewarehouse=$(".storagewarehouse",paentIfarame).find("option:checked").attr("value") //仓库类型
								var conservationcategory=$(".conservationcategory",paentIfarame).find("option:checked").attr("value") //一般养护
								var transportation=$(".transportation",paentIfarame).find("option:checked").attr("value") //运输要求
								var storagecondition=$(".storagecondition",paentIfarame).val() //存储方式
								var produceproperty=$(".produceproperty",paentIfarame).find("option:checked").attr("value") //产品种类
								
								var master = {
									'produceName': '' + produceName + '',
									'manufacturer': '' + manufacturer + '',
									'produceunit': '' + produceunit + '',
									'danwei': '' + danwei + '',
									'producettype': '' + producettype + '',
									'producemodel': '' + producemodel + '',
									'producematerial': '' + producematerial + '',
									'produceusename': '' + produceusename + '',
									'produceseries': '' + produceseries + '',
									'producenum': '' + producenum + '',
									'produceCode': '' + produceCode + '',
									'registrationCertificateID': '' + regId + '',
									'safecount': '' + safecount + '',
									'upperlimit': '' + upperlimit + '',
									'lowerlimit': '' + lowerlimit + '',
									'nomo': '' + nomo + '',
									'storagecondition': '' + storagecondition + '',
									'package': '' + package1 + '',
									'photoaddress': '' + photoaddress + '',
									'storagewarehouse': '' + storagewarehouse + '',
									'conservationcategory': '' + conservationcategory + '',
									'transportation': '' + transportation + '',
									'produceproperty': '' + produceproperty + ''
								};
								
								
								$.ajax({
									type: "post",
									url: localStorage.serIp  +"/WebAddProduceTable",
									async: true,
									dataType: 'json',
									contentType:'application/json; charset=utf-8',
									crossDomain:true,
									data:  JSON.stringify({
										"userId": localStorage.userId,
										"userPw": localStorage.userPw,
										'database': localStorage.database,
										'produce': JSON.stringify(master)
									}),
									success: function(res) {
										var data = JSON.parse(res);
										parent.layer.close(jiazaiIndex); 
										if(data.ResultValue == "1"){
											parent.layer.open({
												title: "提示",
												content: '添加成功',
												zIndex: parent.layer.zIndex //重点1
												,
												success: function(layero) {
													parent.layer.setTop(layero); //重点2
												}
											});
			
											allguige(true);
											parent.layer.close(index11); //再执行关闭     

										}else{
											parent.layer.open({
												title: "提示",
												content: '添加失败：' + data.ResultValue,
												zIndex: parent.layer.zIndex //重点1
												,
												success: function(layero) {
													parent.layer.setTop(layero); //重点2
												}
											});
										}
										
									},
									error: function() {
										parent.layer.close(jiazaiIndex); 		
										
									}
								});
								
							})
						
							
						}

					})
			})
			
		 var jiazaiIndex;
		 $(document).on("click", ".productExport", function() {
		 	
		 					if(!checkPermissionStatus("我的产品注册证-导出1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
						
					}
		 					
			
			var seachContent = $(".seachContent").val();

			parent.layer.open({
			  type: 3, 
			  zIndex: parent.layer.zIndex, //重点1,
			  success: function(layero, index){
			  		jiazaiIndex = index;
	  			}
			});
		
			var  exportUrl =  localStorage.serIp +"/WebExprotProduce?jsoncallback=?&type=-1&fatherId=1&userId="+localStorage.userId;
			exportUrl += "&userPw="+localStorage.userPw+"&database="+localStorage.database+"&filename="+regproducename+"产品"+"&txtCondition="+seachContent+"&res_id=" +regId;
			
			window.location.href =exportUrl;
			parent.layer.close(jiazaiIndex); 


		})

		});
		
		
	</script>

</html>