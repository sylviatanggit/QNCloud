<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>发票迁入调产品</title>
		<link rel="stylesheet" href="../../../plugins/layui/css/layui.css">
		<link rel="stylesheet" type="text/css" href="../../../css/qk/custom_style.css">

		<link rel="stylesheet" href="../../../devexpresslibrary/css/dx.common.css">
		<link rel="stylesheet" href="../../../devexpresslibrary/css/dx.light.css">
		
        
	</head>
		<style type="text/css">
			 footer{
	  margin-top: 23px;
  }
			.leftStock .layui-laypage{
				margin: 0px;
				position: absolute;
				bottom: 5px !important;
				left: 25px;
			}
			
			.rightStock .layui-laypage{
				margin: 0px;
				position: absolute;
				bottom: 5px !important;
				left: 52%;
			}
			
			.layui-table-fixed .layui-table-body tbody .layui-table-cell {
			    height: auto !important;
			}

            .totalInfo{
	  width: 100px;
	  height: 20px;
	  float: left;
	  margin-top: 20px;
}
.layui-laypage-limits {
	  font-size: 12px;
	  display: none;
	  float: left;
	  margin-top: 20px;
  }
  #lay-ignore {
	height: 25px;
    width: 60px;
  }

  	div.cs_result_area div.pagination li {
		margin: 0 5px !important;
	}
	.M-box2 {
    display: inline-block;
    padding: 0 15px;
    height: 28px;
    line-height: 56px;
    color: #333;
	font-size: 12px;
	}

	.M-box2 a{
		margin-left: 15px;
		padding: 0 15px;
		text-decoration: none;
		background-color: #ffffff;
		color: #000000;
	}

	.M-box2 .active {
		margin-left: 5px;
		padding: 0 15px;
		color: #ffffff;
		width: 100%;
		height: 100%;
		background-color: #2D89DD;
		border: 1px solid #e2e2e2;
	}

	.jump-ipt {
		float: none;
		margin-left: 5px;
		margin-left: 11px;
		width: 60px;
		border: 1px solid #e6e6e6;
		height: 20px!important;
	}
    
	.dx-datagrid-rowsview .dx-selection.dx-row>td {
		background-color: yellow!important;
	}
    
	 .leftStock>#gridContainer1> .dx-datagrid > .dx-datagrid-rowsview > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(10) {
		background-color: rgb(211, 236, 198)!important;
	}
	.leftStock>#gridContainer1> .dx-datagrid > .dx-datagrid-rowsview > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(9) {
		background-color: rgb(211, 236, 198)!important;
	}
	.leftStock>#gridContainer1> .dx-datagrid > .dx-datagrid-rowsview > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(11) {
		background-color: rgb(211, 236, 198)!important;
	}
	.leftStock>#gridContainer1> .dx-datagrid > .dx-datagrid-rowsview > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(12) {
		background-color: rgb(211, 236, 198)!important;
	}
	.leftStock>#gridContainer1> .dx-datagrid > .dx-datagrid-headers > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(10) {
		background-color: rgb(211, 236, 198)!important;
	}
	.leftStock>#gridContainer1> .dx-datagrid > .dx-datagrid-headers > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(9) {
		background-color: rgb(211, 236, 198)!important;
	}
	.leftStock>#gridContainer1> .dx-datagrid > .dx-datagrid-headers > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(11) {
		background-color: rgb(211, 236, 198)!important;
	}
	.leftStock>#gridContainer1> .dx-datagrid > .dx-datagrid-headers > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(12) {
		background-color: rgb(211, 236, 198)!important;
	}


		 .rightStock>#gridContainer2> .dx-datagrid > .dx-datagrid-rowsview > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(10) {
		background-color: rgb(255, 200, 200) !important; 
	}
	.rightStock>#gridContainer2> .dx-datagrid > .dx-datagrid-rowsview > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(9) {
		background-color: rgb(255, 200, 200) !important; 
	}
	.rightStock>#gridContainer2> .dx-datagrid > .dx-datagrid-rowsview > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(11) {
		background-color: rgb(255, 200, 200) !important; 
	}
	.rightStock>#gridContainer2> .dx-datagrid > .dx-datagrid-rowsview > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(12) {
		background-color: rgb(255, 200, 200) !important; 
	}
	.rightStock>#gridContainer2> .dx-datagrid > .dx-datagrid-headers > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(10) {
		background-color: rgb(255, 200, 200) !important; 
	}
	.rightStock>#gridContainer2> .dx-datagrid > .dx-datagrid-headers > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(9) {
		background-color: rgb(255, 200, 200) !important; 
	}
	.rightStock>#gridContainer2> .dx-datagrid > .dx-datagrid-headers > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(11) {
		background-color: rgb(255, 200, 200) !important; 
	}
	.rightStock>#gridContainer2> .dx-datagrid > .dx-datagrid-headers > .dx-datagrid-content > table > colgroup >.dx-col-fixed:nth-child(12) {
		background-color: rgb(255, 200, 200) !important; 
	}

	
		</style>
	

	<body>
		<div class="panel-content">
			<div class="layui-tab">
				
				<div class="panel_header">
					<div class="inputs">
						<div class="layui-inline">
							<div class="layui-input-inline">
								<input autocomplete="off" placeholder="单号、产品名称" class="layui-input seachContent" type="text" style="margin-left: 0;width: 240px;">
							</div>
						</div>
						
						<div class="layui-inline">
							<button class="layui-btn find" style="margin-left: 5px;">查询</button>
						</div>
						
						
						<div class="btns">
							<button class="layui-btn finishCheck" style="width: 80px;">选择</button>
	
						</div>
						
					</div>

				</div>
				
				
				<div style="width: 100%;height: 100%;margin-bottom: 10px;">
					<div style="width: 49%;float: left;" class="leftStock">
						<table id="leftStockId" lay-filter="leftStock">
							<div id="gridContainer1"></div>
						</table>
					</div>
					
					<div style="width: 49%;float: right;" class="rightStock">
						<table id="rightStockId" lay-filter="rightStock">
							<div id="gridContainer2"></div>
						</table>
					</div>
				</div>
				<!-- 分页 -->
				<div class="footer .clearfix">
					<!-- <div class="totalInfo fl"></div> -->
					<div class="M-box2 fl"></div>
					<span class="layui-laypage-limits">
						<select id="lay-ignore">
							<option value="50" selected>50</option>
							<option value="100">100</option>
							<option value="200">200</option>
						</select>
						<span>条/页</span>
					</span>
				</div>
				<!-- 分页 -->
			</div>
		</div>
	</body>
			<script src="../../../plugins/layui/layui.js"></script>
			<script src="../../../js/public.js"></script>
			<script src="../../../js/jquery.js" type="text/javascript"></script>
			<!-- DevExtreme library -->
			 <script src="../../../devexpresslibrary/js/dx.all.js"></script>
			<script type="text/javascript" src="../../../js/comboselect.js"></script>
			<script type="text/javascript" src="../../../js/b.comboselect.js"></script>


			<!-- 分页插件 -->
	<script src="../../../devexpresslibrary/js/pagination/jquery.pagination.js"></script>
	<script src="../../../devexpresslibrary/js/pagination/highlight.min.js"></script>
	   <script>
		var jiazaiIndex;
		layui.use(['table', 'jquery', 'laydate', 'laypage'], function() {
			var table = layui.table;
			var $ = layui.jquery;
			var laypage = layui.laypage;

			$('.moreAction').hover(function() {
				$(".action").show();
			}, function() {
				$(".action").hide();
			});
			$('.action').hover(function() {
				$(".action").show();
			}, function() {
				$(".action").hide();
			});
			
			var limit1 = 50;
			var targetstockid = "";
			var orderNum = "";
			var currentPage = 1;
			var totalInfo = '';
			var curpage1 = 1;
			var limit = 50;
			var count1 = 0;
			
			var productData =[];
			var selectData=[];
			
			table.on('checkbox(leftStock)', function(obj){
				
				if(obj.type =="all"){ //如果触发的是全选，则为：all，如果触发的是单选，则为：one
					
					if(obj.checked){
					
						 var checkStatus = table.checkStatus('leftStockId') ,
						 productData = checkStatus.data;
						 
						 
						for(var j = 0; j < productData.length; j++) {
							 delete productData[j]["LAY_CHECKED"];
							 
				
							productData[j].hxproducecount = productData[j].leavecount;
							productData[j].hxprice = productData[j].unitprice;
							productData[j].hxtotalprice = productData[j].totalprice;

							selectData.push(productData[j]);
							
							selectData = selectProductUniqueArrayByziDuan(selectData)
						}	
						
					}else{
						
						var productData= [];
						
						var tabeData = $(".leftStock .layui-form .layui-table-body table tbody tr");
						
						for(var i=0;i<tabeData.length;i++){
							var productInfo = {};
							var  targetstockid= $(".leftStock .layui-table-box tbody tr:eq("+i+")").attr("targetstockid");
							var  stockarea= $(".leftStock .layui-table-box tbody tr:eq("+i+")").attr("stockarea");
							var  produceid =$(".leftStock .layui-table-box tbody tr:eq("+i+")").attr("produceid");
							var  jsnum =$(".leftStock .layui-table-box tbody tr:eq("+i+")").attr("jsnum");

							
							productInfo.targetstockid = targetstockid;
							productInfo.stockarea = stockarea;
							productInfo.produceid = produceid;
							productInfo.jsnum = jsnum;

							
							productData.push(productInfo)
							
						}
	
						
						selectData = deleteProductUniqueArray(selectData,productData);
							
					
					}
					
				}else{
					var data = obj.data;
				
					 delete data["LAY_CHECKED"];
					 
					 
					if(obj.checked){
 						
 						data.hxproducecount = data.leavecount;
 						data.hxprice = data.unitprice;
 						data.hxtotalprice = data.totalprice;
 						data.id = data.id;
						selectData.push(data)
				
					}else{
						selectData = deleteProductjosnobjectByKeyFPQR(selectData,data)
					}
				}
				
				rightStockData(selectData);
				
				
			});
	
         
			function leftStock(curpage1, limit1,count1) {
			
				var seachContent = $(".seachContent").val();

				$.ajax({
					type: "get",
					url: localStorage.serIp+"/WebGetNotInvoiceInSettleMentProInfo",
					async: true,
					dataType: 'json',
					data: {
						'userId': localStorage.userId,
						'userPw': localStorage.userPw,
						// 'num': limit,
						'num': 1000000000,
						// 'page': curpage1,
						'page': 1,
						'areaid':$('.areaid').val(),
						'database': localStorage.database,
						'txtCondition': seachContent,
						'companyId': sessionStorage.unit_id
					},
					success: function(res) {
						$('.totalInfo').children().remove();
						var desData = JSON.parse(res);
						// console.log(desData.count);
						count1 = desData.count;
						var data = JSON.parse(desData.data);
						// console.log(data);
						var totalInfoTag = '<span>' + '共' + count1 + '条' + '</span>';
                        $('.totalInfo').append(totalInfoTag);
						for(var j = 0;j < data.length;j++){
							data[j].hxproducecount = data[j].leavecount;
							data[j].hxprice = data[j].unitprice;
							data[j].hxtotalprice = data[j].totalprice;
							data[j].id = data[j].id;
						}
				
						leftStockData(data,limit1);
						// pagination(curpage1, limit1, count1);
				        
						
						var saveProductData =[];	
						for(var i=0;i<data.length;i++){
							$(".leftStock .layui-table-box tbody tr:eq("+i+")").attr("stockarea",data[i].stockarea);
							$(".leftStock .layui-table-box tbody tr:eq("+i+")").attr("targetstockid",data[i].targetstockid);
							$(".leftStock .layui-table-box tbody tr:eq("+i+")").attr("produceid",data[i].produceid);
							$(".leftStock .layui-table-box .layui-table-body tbody tr:eq("+i+")").attr("jsnum",data[i].jsnum);
							if(sessionStorage.saveProductData && sessionStorage.saveProductData!= "[]" && typeof(sessionStorage.saveProductData) != "undefined") {
								saveProductData = JSON.parse(sessionStorage.saveProductData);
								for(var j=0;j<saveProductData.length;j++){
									
									if((data[i].produceid == saveProductData[j].produceid) && (data[i].jsnum == saveProductData[j].jsnum)){
										$(".leftStock .layui-table-box tbody tr:eq("+i+") td:eq(0) .layui-table-cell div").attr("class","layui-unselect layui-form-checkbox layui-form-checked");
										$(".leftStock .layui-table-box tbody tr:eq("+i+") td:eq(0) .layui-table-cell input").attr("checked","cheked");
										
									}
									
								}
							}
									
						}	
						selectData = saveProductData;
						
						rightStockData(saveProductData);
						
					}
				});

			}

							

			
			
			leftStock(curpage1, limit,count1);

			 // 根据可视区的高度判断
			 var viewHeight = $(window).height();
			if (viewHeight == 855) {
				$('#gridContainer1,#gridContainer2').css('height', 694 + 'px'); //855*0.81
			} else {
				$('#gridContainer2').css('height', viewHeight * 0.85 + 'px');
				 $('#gridContainer1').css('height', viewHeight * 0.91 + 'px');
			}
			
            var currentDeselectedRowKeys;
			function leftStockData(data,count1) {
			    $(function () {
		var dataGrid = $("#gridContainer1").dxDataGrid({
			dataSource: data,
			allowColumnReordering: true,
			showBorders: true,
            keyExpr: "id",
            columnChooser: {
	            enabled: false,
				mode: "dragAndDrop",
			},
			cacheEnabled:true,
            headerFilter: {
                visible: false
            },
            sorting: {
                mode: "none"//none
            },
            filterRow: {
                visible: false,
            },
			paging: {
				pageSize: count1,
            },
			pager: {
            showPageSizeSelector: true,
            allowedPageSizes: [50,100, 200],
            showInfo: true
        },
			selection: {
                mode: "multiple",
            },
			allowColumnResizing: true,
			columnFixing: {
				enabled: false
			},
			grouping: {
	            contextMenuEnabled: false,
	            expandMode: "rowClick"
	        },   
	        groupPanel: {
	            visible: false
			},
			columns: [{
				dataField: "jsnum",
                caption: "结算单号",
				width: 170,
                
			}
			,{
				dataField: "producename",
                caption: "产品名称",
				width: 150,
                
			},
			{
                dataField: "danwei",
                width: 100,
				caption: "规格",
             
			},
			{
                dataField: "producemodel",
                width: 100,
				caption: "型号",
			}
			,
			{
                dataField: 'manufacturer',
                width: 80,
				caption: "品牌",
			},
			{
                dataField: "warehousename",
                width: 150,
				caption: "仓库",
			},
			{
                dataField: "areaname",
                width: 150,
				caption: "货区",
			},
			{
                dataField: "instocount",
				fixed: true,
				fixedPosition: 'right',
                width: 78,
				caption: "入库数量",
			},{
                dataField: "billingcount",
				fixed: true,
				fixedPosition: 'right',
                width: 78,
				caption: "已销数量",
			},{
                dataField: "unitprice",
				fixed: true,
				fixedPosition: 'right',
                width: 78,
				caption: "暂估单价",
			},{
                dataField: "totalprice",
				fixed: true,
				fixedPosition: 'right',
                width: 78,
				caption: "暂估金额",
			},
			],
			summary: {
            totalItems: [{
                    column: "instocount",
					summaryType: "sum",
					customizeText: function(data) {
						
						var data = data.value;
					
                        return data;
                }
                },{
                    column: "billingcount",
					summaryType: "sum",
					customizeText: function(data) {
						var data = data.value;
                        return data;
                }
                },
				{
                    column: "totalprice",
					summaryType: "sum",
					customizeText: function(data) {
						var data = data.value;
                        return data;
                }
                }
			]
		},
			onSelectionChanged:function(e){
				// console.log(e);
		        // 原来页面的 + 选择的 + 取消选择的 渲染;
                  
				 leftSelectedRowsData = e.selectedRowsData;
				 currentDeselectedRowKeys = e.currentDeselectedRowKeys;
			
				  rightStockData(leftSelectedRowsData);
				  
            },
			onContentReady:function(e){
				// console.log(e);
			  var key = e.component.getKeyByRowIndex();
		      
			  var selectArr = [];	
			  $.each(selectData,function(i,v,arr){
				selectArr.push(v.jsnum + v.produceid);
			  });
		
             
			    
				// console.log(selectArr);

			    e.component.selectRows(selectArr, true);
				
			    // rightStockData(selectData);
				// jumpForSaving =false;
			    
			}
		}).dxDataGrid('instance');
	    });
			}
			
			
			var leftSelectedRowsData;
		    var jumpForSaving = false;
			//分页
			// function pagination(currentPage, limit, count1) {
			// 	$('.M-box2').empty();
			// 	if (Math.floor(count1 / limit1) == 0) {
			// 		return;
			// 	}
			// 	$('.M-box2').pagination({
			// 		current: curpage1,
			// 		totalData: count1,
			// 		showData: limit1,
			// 		pageCount: Math.floor(count1 / limit1),
			// 		mode: 'fixed',
			// 		isHide: true,
			// 		jump: true,
			// 		callback: function (api) {
			// 			curpage1 = api.getCurrent();
			// 		     jumpForSaving = true;
			// 			  console.log(jumpForSaving);
                          
			// 			leftStock(curpage1, limit1, count1);
			// 		}
			// 	});
			// 	// jumpForSaving = true;
			// }
					
			var limit2 = 100;
			var curpage2 = 1;
			var count2 = 0;
			// rightStockData(null);
			
			
			function rightStockData(data) {
			
				
				$(function () {
		var dataGrid = $("#gridContainer2").dxDataGrid({
			dataSource: data,
			allowColumnReordering: true,
			showBorders: true,
            keyExpr: "produceid",
		// 	paging: {
		// 		pageSize: count1,
        //     },
		// 	pager: {
        //     showPageSizeSelector: true,
        //     allowedPageSizes: [ 100, 200],
        //     showInfo: true
        // },
           columnChooser: {
	            enabled: false,
				mode: "dragAndDrop",
			},
			cacheEnabled:true,
            headerFilter: {
                visible: false
            },
            sorting: {
                mode: "none"//none
            },
            filterRow: {
                visible: false,
            },
			paging: {
				pageSize: 200,
            },
			selection: {
                mode: "multiple",
            },
			allowColumnResizing: true,
			columnFixing: {
				enabled: false
			},
			grouping: {
	            contextMenuEnabled: false,
	            expandMode: "rowClick"
	        },   
	        groupPanel: {
	            visible: false
			},
			columns: [{
				dataField: "jsnum",
                caption: "结算单号",
				width: 170,
                
			}
			,{
				dataField: "producename",
                caption: "产品名称",
				width: 150,
                
			},
			{
                dataField: "danwei",
                width: 150,
				caption: "规格",
             
			},
			{
                dataField: "producemodel",
                width: 120,
				caption: "型号",
			}
			,
			{
                dataField: 'manufacturer',
                width: 100,
				caption: "品牌",
			},
			{
                dataField: "warehousename",
                width: 150,
				caption: "仓库",
			},
			{
                dataField: "areaname",
                width: 150,
				caption: "货区",
			},{
                dataField: "hxproducecount",
				fixed: true,
				fixedPosition: 'right',
                width: 78,
				caption: "核销数量",
			},{
                dataField: "hxprice",
				fixed: true,
				fixedPosition: 'right',
                width: 78,
				caption: "核销单价",
			},{
                dataField: "hxtotalprice",
				fixed: true,
				fixedPosition: 'right',
                width: 78,
				caption: "核销金额",
			}
			],
			summary: {
            totalItems: [{
                    column: "hxproducecount",
					summaryType: "sum",
					customizeText: function(data) {
						
						var data = data.value;
					
                        return data;
                }
                },{
                    column: "hxtotalprice",
					summaryType: "sum",
					customizeText: function(data) {
						var data = data.value;
						data = data.toFixed(2);
                        return data;
                }
                }
			]
		},
	    //  onContentReady:function(){
		// 	jumpForSaving = false;
		//  }

		}).dxDataGrid('instance');

        
	});
			}
			
			
	
			
			$(".find").click(function(){leftSelectedRowsData


				leftStock(curpage1, limit1,count1);
			})
			
			
								
			$("body").keydown(function(event) {
					if(event.keyCode == "13") { //keyCode=13是回车键
						$('.find').click();
					}
			});
	

			$('.jianjishijian').on('click', function() {
				var type = $(this).data('type');
				active[type] ? active[type].call(this) : '';
			});
			
						
			$(".finishCheck").click(function(){
					if(leftSelectedRowsData.length ==0){
						parent.layer.open({
							title: "提示",
							content: '请选择产品!' ,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return;
					}

					if(sessionStorage.FPHXdata){
							sessionStorage.removeItem('FPHXdata');
					}
					if( sessionStorage.selectkeys){
						sessionStorage.removeItem('selectkeys');
					}
					sessionStorage.FPHXdata = JSON.stringify(leftSelectedRowsData);
					
					parent.layer.open({
						title: "提示",
						content: '选择成功',
						zIndex: parent.layer.zIndex, //重点1,
						success: function(layero) {
						parent.layer.setTop(layero); //重点2
						var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
						parent.layer.close(index); //再执行关闭     
						},
					});
				
				  
	
				})
			
	
	});
	</script>

</html>

	