<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>收款单</title>
		<link rel="stylesheet" type="text/css" href="../../../css/comboselect.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/demo.css" />
		<link rel="stylesheet" href="../../../plugins/layui/css/layui.css">
		<link href="../../../css/font-awesome.min.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="../../../css/public_style.css" />
	</head>
	<style type="text/css">
		input,
		section,
		button,
		select {
			border-radius: 2px;
		}
		
		.addPayment {
			font-family: "PingFang SC" !important;
			/*font-size: 12px !important;*/
			font-size: 9pt !important;
			color: #232323 !important;
			margin: 0 20px;
			margin-top: 20px;
		}
		
		.layui-input-block,
		.layui-input-block input,
		.layui-input-block label,
		.layui-input-block select {
			line-height: 28px !important;
			height: 28px !important;
			min-height: 28px !important;
			padding-left: 10px !important;
		}
		
	
		
		.addPayment .layui-table td,
		.layui-table th {
			/*font-size: 12px !important;*/
			font-size: 9pt !important;
		}
		
		.btns {
			margin-bottom: 12px;
			position: absolute;
			right: 20px;
			top: 114px;
		}
		

		.find,
		.btns button {
			cursor: pointer;
			border: none;
			width: 90px;
			height: 28px;
			line-height: 28px;
			border-radius: 2px;
			background-color: #2D89DD;
			color: #FFFFFF;
		}

		
		.layui-input-block {
			min-height: 22px;
		}
		
		.two_inputs {
			padding-top: 12px;
			background-color: #EFF5FF;
			margin-top: 50px;
			padding-bottom: 5px;
		}
		
		.moreAction {
			width: 90px !important;
		}
		
		.action {
			width: 88px !important;
			right: 0;
		}
		
		.show,
		.hide {
			padding: 1px 10px;
			background-color: #1E9FFF;
			text-align: center;
			position: absolute;
			top: 138px;
			right: 50%;
			cursor: pointer;
		}
		
		.hide {
			display: none;
		}
		
		.title {
			margin-top: 12px;
		}
		

		
		.detail {
			position: absolute;
			top: 150px;
			float: right;
			width: 20px;
			text-align: center;
			padding: 5px 10px;
			line-height: 20px;
			right: 0px;
			font-size: 9pt;
			border-top-left-radius: 5px;
			border-bottom-left-radius: 5px;
			background-color: #2D89DD;
			color: white;
			cursor: pointer;
			z-index: 9;
		}
		
		.order {
			/*width: 80%;*/
			height: auto;
			border: 1px solid #CCCCCC;
			position: absolute;
			bottom: 50px;
			right: 0px;
			z-index: 99999999999;
			background-color: white;
		}
		
		.order .layui-table-tool {
			bottom: 25px;
		}
		
		.cs_container,
		.cs_container_open .cs_input,
		.cs_result_area {
			width: 250px !important;
		}
		
		.cs_container input{
			font-size: 9pt !important;
		}
		
		div.cs_result_area div.pagination li {
			margin: 0 4px !important;
		}
		
			.fixStyle ul li{
			float: left;
			padding-left: 6px;
		}
		
				
		.fixStyle ul{
			border: 1px solid #ccc;
		}
		
		input{
			font-size: 9pt;
		}
		.fixStyle ul li{
			float: left;
			padding-left: 6px;
		}
	
	
	
	</style>

	<body>
		<div class="addPayment">
			<div class="layui-tab">
				<div class="header1">
					<p style="color: #232323 !important;font-size: 24px !important;margin-top: 30px;">
						<span class="orderLeiXing">采购付款单</span> <img class="dsh" src="../../../image/dsh.png" alt="" /><img class="yzf" src="../../../image/yzf.png" alt="" /> <img class="ysh" src="../../../image/ysh.png" alt="" /></p>
					<ul>
						<li>
							<label class="layui-form-label">付款日期</label>
							<div class="layui-input-block">
								<input name="title" lay-verify="title" placeholder="请选择日期" autocomplete="off" id="addPaymentDate" class="layui-input" type="text">
							</div>
						</li>
						<li>
							<label class="layui-form-label">付款单号</label>
							<div class="layui-input-block">
								<input name="title" lay-verify="title" autocomplete="off" placeholder="" class="layui-input ordernum" type="text" readonly="readonly">
							</div>
						</li>
						<li>
							<label class="layui-form-label">自定义单号</label>
							<div class="layui-input-block">
								<input name="title" lay-verify="title" autocomplete="off" placeholder="" class="layui-input mynum" type="text">
							</div>
						</li>
					</ul>
				</div>
				<div class="header2">
					<div class="btns">
					
						<button class="layui-btn addDianJiEvent preserve" data-type="preserve"  lay-event='preserve'>保存</button>
							<button id="examine" class="layui-btn addDianJiEvent examine" data-type="examine" lay-event='examine' style="display: none;">审核</button>
						<button id="noExamine" class="layui-btn addDianJiEvent noExamine" data-type="noExamine" lay-event='noExamine' style="display: none;">反审核</button>

						<button class="layui-btn moreAction">更多操作</button>
						<ul class="action">
							<li id="del">
								<a class="addDianJiEvent del" data-type="del" lay-event='del'>批量删除</a>
							</li>
					
							
							<li id="print" style="display: none;">
								<a class="print" data-type="printData" lay-event='printData'>打印单据</a>
							</li>
							
								<li id="printSetting" style="display: none;">
								<a class="printSetting" data-type="printData" lay-event='printData'>打印设置</a>
							</li>
							<li id="updateNomeId" style="display: none;">
								<a class="updateNomeId" data-type="printData" lay-event='printData'>修改备注</a>
							</li>
							
							
							<li id="yijianShouKuanId">
								<a class="addDianJiEvent yijianShouKuan">一键付款</a>
							</li>
						</ul>
					</div>
					<div class="two_inputs">
						<div style="width: 100%;height: auto;">	
							<div  class="layui-inline selectKung" style="width: 328px !important;">
								<label class="layui-form-label">往来单位</label>
								<div>
									<input name="title" data-id='' readonly="readonly" lay-verify="title" value="" autocomplete="off" id="unit" class="layui-input unit" type="text" style="width: 250px;height: 28px;line-height: 28px;">
								</div>
							</div>
							
						
							<div  class="layui-inline selectKung" style="width: 328px !important;">
								<label class="layui-form-label">付款账户</label>
								<div id="accountID">
									<input name="title" data-id='' lay-verify="title" value="" autocomplete="off" id="account" class="layui-input account" type="text" style="width: 250px;height: 28px;line-height: 28px;margin: 0px;">
								</div>
							</div>
							

						
						<div class="layui-inline" style="margin-left: 0px;">
							<label class="layui-form-label" >支付方式</label>
							<div class="layui-input-inline">
								<select name="" class="layui-input type">
									<option value="0">现金</option>
									<option value="1">支票</option>
									<option value="2">电汇</option>
								</select>
							</div>
						</div>
						</div>
						
					<div style="width: 100%;height: auto;">	
							<div  class="layui-inline selectKung" style="width: 328px !important;">
								<label class="layui-form-label">业务人员</label>
								<div>
									<input name="title" data-id='' lay-verify="title" value="" autocomplete="off" id="salesman" class="layui-input salesman" type="text" style="width: 250px;height: 28px;line-height: 28px;">
								</div>
							</div>
							
				
						<div class="layui-inline">
							<label class="layui-form-label">制单人员</label>
							<div class="layui-input-inline">
								<input value="" class="layui-input operatorsidname" type="text" style="width: 250px;margin: 0px;" readonly="readonly">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label">备　　注</label>
							<div class="layui-input-inline">
								<input class="layui-input notes ordeNotes" type="text" style="width: 345px;" value="">
							</div>
						</div>
					</div>
					
				</div>
				<p class="title">付款详情</p>
				<table id="addPayment" lay-filter="demo"></table>
			</div>
		</div>
		
				
			<div style="position: absolute;bottom: 0px;right: 22px;" class="fixStyle">
				
				 <ul style="height: 24px;text-align: left;vertical-align: middle;line-height: 24px;">
				 	<li style="width: 92px;height: 22px;border-right:1px solid #ccc ;"  id="totalpriceId"></li>
				 	<li style="width: 92px;height: 22px;border-right:1px solid #ccc ;"  id="nomoneyId"></li>
			 		<li style="width: 92px;height: 22px;" id="paymoneyId"></li>
			 		 
				 </ul>		
				 
			</div>	
				<iframe src="" frameborder="0" id="pdfContainer" name="pdfContainer" style="display: none;"></iframe>
	
	</body>
	<script src="../../../plugins/layui/layui.js"></script>
	<script src="../../../js/public.js"></script>

	<script>
		layui.use(['table', 'jquery', 'laydate'], function() {
			var table = layui.table;
			var $ = layui.jquery;
			var laydate = layui.laydate;
			var eventFlag = false;
			var oldData = [];  //收款数据
			
			$('.moreAction').hover(function() {
				$(".action").show();
			}, function() {
				$(".action").hide();
			});
			$('.action').hover(function() {
				$(".action").show();
			}, function() {
				$(".action").hide();
			});
			$(".show").click(function() {
				$(".show").hide();
				$(".hide").show();
				$(".two_inputs").hide();
				$(".title").css("margin-top", "54px");
			});
			$(".hide").click(function() {
				$(".hide").hide();
				$(".show").show();
				$(".two_inputs").show();
				$(".title").css("margin-top", "12px");
			});

		
		
		
			
			$(".print").click(function(){
							if(!checkPermissionStatus("采购付款单-打印1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
						
					}
					
					
					var ordertype = 6;  //付款单
					checkPrintIsSetting("CGFKD",$('.ordernum').val(),ordertype);
		
				
			})
			
			
			$(".printSetting").click(function() {
				
				sessionStorage.ordertype = 6;  //付款单
				sessionStorage.orderLeiXing = $(".orderLeiXing").text();

				
			
				var  jsonArray= getTableHeadByPrintTemplate(0);
			
				sessionStorage.headjsonArrayData = JSON.stringify(jsonArray);
			
				

				parent.layer.open({
					type: 2 //此处以iframe举例
						,
					title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">打印设置</span>',
					area: ['600px', '90%'],
					offset: "rb",
					content: 'views/public/PrintTemplate/PrintTemplate.html',
					zIndex: parent.layer.zIndex, //重点1
					success: function(layero) {
						parent.layer.setTop(layero); //重点2
					},
					end: function() {
						if(sessionStorage.ordertype){
							sessionStorage.removeItem("ordertype")
						}
						if(sessionStorage.headjsonArrayData){
							sessionStorage.removeItem("headjsonArrayData")
						}
						
						if(sessionStorage.orderLeiXing){
							sessionStorage.removeItem("orderLeiXing")
						}
						
					}
				});
			});
			
			

				
			var cleckFlag = false;
							 	


			
			
			//一键全额收款
			$(".yijianShouKuan").click(function() {
				
						if(!checkPermissionStatus("采购付款单-保存1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
						
					}
						
						
				if(oldData.length==0){
					parent.layer.open({
						title: "提示",
						content: '付款详情为空,不能一键全额付款!',
						zIndex: layer.zIndex //重点1
						,
						success: function(layero) {
							parent.layer.setTop(layero); //重点2
						}
					});
				
					return;
				}
		
				for(var i=0;i<oldData.length;i++){

					var nomoney = oldData[i].nomoney;
				
					$(".addPayment  .layui-table-view  .layui-table-body .layui-table tbody  tr:eq("+i+")  [data-field=paymoney] div").text(nomoney);

					oldData[i].paymoney = nomoney;
				}
				
				everyFun();
				
			});
			
			
			
			laydate.render({
				elem: "#addPaymentDate",
				value: new Date()
			})
			
			
		$(".addDianJiEvent").click(function() {
			var type = $(this).data('type');
			active[type] ? active[type].call(this) : '';
		}) 

			function staffList() {
				$.ajax({
					type: "get",
					url:localStorage.serIp  + "/WebGetEmployeeDropDownList?jsoncallback=?",
					async: true,
					dataType: 'jsonp',
					data: {
						"userId": localStorage.userId,
						"userPw": localStorage.userPw,
						'database': localStorage.database,
						'groupCompanyId': localStorage.groupcompanyid
					},
					success: function(res) {
						var data = JSON.parse(res);
						$('#salesman').bComboSelect({
							showField: 'employeename',
							keyField: 'employeesid',
							data: data
						});
					}
				});
			}
			staffList()
			
			
			
			
			//收款账户
//			$(".account").click(function() {
//				
//					eventFlag = true;
//			
//					if (sessionStorage.bankAccountData) {
//						sessionStorage.removeItem('bankAccountData')
//					}
//					
//			
//			
//				parent.layer.open({
//					type: 2 //此处以iframe举例
//						,
//					title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">银行账户</span>',
//					area: ['85%', '90%'],
//					offset: "rb",
//					content: 'views/public/bankAccount/bankAccountPublicList.html',
//					zIndex: layer.zIndex //重点1
//						,
//					success: function(layero, index) {
//						parent.layer.setTop(layero); //重点2
//						var body = layer.getChildFrame('body', 'index');
//
//						paentIfarame = layero.find("iframe")[0].contentWindow.document;
//
//					},
//					cancel: function() {
//		
//					},
//					end: function(){  
//		         	  	if(sessionStorage.bankAccountData) {
//							if(sessionStorage.bankAccountData.length>0 && sessionStorage.bankAccountData!= "[]"){
//		
//							var bankAccountData = JSON.parse(sessionStorage.bankAccountData);
//						
//							$(".account").val(bankAccountData.bankName);
//							$(".account").attr('data-id',bankAccountData.bankId);
//								
//							} else {
//								layer.closeAll();
//							}
//						}
//							
//						}
//				});
//			});

		
		
			
			var receiptordernum=$(".layui-show", parent.document).attr("lay-item-id");

 			if(receiptordernum.indexOf("xindan")){
 				
		 		initData(receiptordernum.substring(6,receiptordernum.length));		
		 	}else{
		 	
				$(".operatorsidname").val(localStorage.employeeName);
				$(".operatorsidname").attr('data-id',localStorage.userId);
				
					
				if(localStorage.groupcompanyid ==0){
						getAccountDropDownByConfident(localStorage.groupcompanyid,0);
	
				}else{
						getAccountDropDownByConfident(localStorage.groupcompanyid,1);
				}
			
		 	}

		
		
			//初始化页面数据
			function initData(ordernum){
				
				$.ajax({
					type: "get",
					url: localStorage.serIp +"/WebGetMbPayMoneyMasterInfo?jsoncallback=?",
					dataType: "jsonp",
					async: true,
					data: {
						'userId': localStorage.userId,
						'userPw': localStorage.userPw,
						'num': 1,
						'page': 1,
						'orderNum': ordernum,
						'agentId': "",
						'beginTime': "",
						'endTime': "",
						'database': localStorage.database,
						'groupCompanyId': localStorage.groupcompanyid,
						'checkState': "-1",
					},
					success: function(res) {
						var initData = JSON.parse(res);
						var data = JSON.parse(initData.data);
				
				
						if(data[0].paydate != undefined){
							$(".addPayment #addPaymentDate").val(data[0].paydate);
						}else{
							var myDate = new Date();
							var currentDate =  myDate.getFullYear() + '-' +(myDate.getMonth() + 1)  + '-'+  myDate.getDate();
				
							$(".addPayment #addPaymentDate").val(currentDate);
						}
						
						$(".addPayment .unit").val(data[0].companyname);				
						$(".addPayment .unit").attr('data-id',data[0].companyid);
						
						
							if(localStorage.groupcompanyid ==0){
								getAccountDropDownByConfident(localStorage.groupcompanyid,0);
	
							}else{
									getAccountDropDownByConfident(localStorage.groupcompanyid,1);
							}
						
						$(".addPayment .ordernum").val(data[0].ordernum);	
						
						$(".addPayment .account").val(data[0].accountforprint);				
						$(".addPayment .account").attr('data-id',data[0].accountforprint);
						
						$(".addPayment .salesman").val(data[0].agentname);
						$(".addPayment .salesman").attr('data-id',data[0].agent);
					
						$(".addPayment .notes").val(data[0].nomo);
						$(".addPayment .type").val(data[0].settlestate);
							
						$(".operatorsidname").val(data[0].operatorsidname);
						$(".operatorsidname").attr('data-id',data[0].operatorsid);
						oprateStatus(data[0].checkstate);
						
						receiptData(ordernum);
					}
					
				
					
				});
				
			}
		
			function receiptData(ordernum) {
				
				
				$.ajax({
					type: "get",
					url:  localStorage.serIp +"/WebGetMbpaymoneySlaveTableByOrderNum?jsoncallback=?",
					dataType: "jsonp",
					async: true,
					data: {
						'userId': localStorage.userId,
						'userPw': localStorage.userPw,
						'database': localStorage.database,
						'orderNum': ordernum,
					},
					success: function(res) {
						
						var resultData = JSON.parse(res);
						oldData= resultData;
						detail(resultData);
						
						
					}
				});

			}
			
			function oprateStatus(checkstate){
				switch(checkstate)
				{
				case 1:				
					$(".dsh").css("display", 'none');
					$(".ysh").css("display", 'inline-block');
					$(".yzf").css("display", 'none');
					$("#yijianShouKuanId").css("display", 'none');

					$("input").attr('disabled', 'disabled')	
					
					$(".preserve").css("display", "none");
					$(".adjustOrder").css("display", 'none');
					
					$("#print,#printSetting").css("display", "inline-block");
					$("#noExamine").css("display", "inline-block");					
					$("#examine").css("display", "none");
					$("#del").css("display", "none");
					$('#updateNomeId').css('display','inline-block');
				  break;
	
				case 0:  //待审核
					$(".dsh").css("display", 'inline-block');
					$(".ysh").css("display", 'none');
					$(".yzf").css("display", 'none');
					
					$("#yijianShouKuanId").css("display", 'inline-block');
					$("input").removeAttr('disabled');
					
					$(".preserve").css("display", "inline-block");
					$(".adjustOrder").css("display", 'inline-block');
					
					$("#print,#printSetting").css("display", "none");
					$("#noExamine").css("display", "none");					
					$("#examine").css("display", "inline-block");
					$("#del").css("display", "inline-block");
					
		
				
				
				  break;

				}
			}
			
	
		
			//展示已知数据
			function detail(data) {
				table.render({
					elem: '#addPayment',
					data: data,
					id: 'orderTest',
					height: "full-310",
					cols: [
						[ //标题栏
							{
								checkbox: true,
								LAY_CHECKED: false,
								align: "center",
								width: 40,
							},
							{
								field: 'jsnum',
								title: '核价单号',
								event: "detail",
								style: "color:#2D89DD;cursor:pointer",
								minWidth: 200,
							}, {
								field: 'lasttypename',
								title: '单据类型',
								minWidth: 100
							}, {
								field: 'lastnum',
								title: '关联单号',
								minWidth: 200
							},
							{
								field: 'totalprice',
								title: '总金额',
								width: 100,fixed: 'right'
							}, {
								field: 'nomoney',
								title: '待付金额',
								width: 100,fixed: 'right'
							}, {
								field: 'paymoney',
								title: '实付金额',
								edit: 'text',
								width: 100,fixed: 'right'
							}
						]
					],
					skin: 'row' //表格风格
						,
					even: true,
					page: false //是否显示分页
						,
					limits: [100,1000],
					limit: 100000 //每页默认显示的数量
					
				});
				
				
				$("[data-field=totalprice]").css("background-color","#d3ecc6");
				$("[data-field=nomoney]").css("background-color","#d3ecc6");
				$("[data-field=paymoney]").css("background-color","#d3ecc6");	
				

				
				everyFun();
						
			}
			
			//根据单据类型跳不同页面
			table.on('tool(demo)', function(obj) {
				var data = obj.data;
			
			
			
				if(obj.event === 'detail') {
					
					
						sessionStorage.paymentordernum = data.jsnum;

						parent.layer.open({
							type: 2 //此处以iframe举例
								,
							title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">【'+data.jsnum+'】单据详情</span>',
							area: ['85%', '90%'],
							offset: "rb",
							content: 'views/financiaManagement/payment/dinhuoHeYueDedatil.html',
							zIndex: layer.zIndex //重点1
								,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							},
							end: function(layero) {
								if(sessionStorage.paymentordernum){
									sessionStorage.removeItem("paymentordernum")
								}
							}
						});


				}
				
				
				
			});


			
			//实收金额计算
			table.on('edit(demo)', function(obj){ //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
			 		eventFlag = true;
			 	 	var value = obj.value //得到修改后的值
					,
					data = obj.data //得到所在行所有键值
					,
					field = obj.field; //得到字段
					
					if(field == "paymoney"){
						var re = /^[0-9]+.?[0-9]*/;
						
						if (!re.test(value)) {
							layer.tips('输入非法!',this);
							value="0.00";						
						}else{
							var nomoney = data.nomoney;
						
							if(value > nomoney){
								value = nomoney;
	
							}
						}
			
						$(this).val(value);
						for (var i=0;i< oldData.length;i++) {
							if(oldData[i].jsnum == data.jsnum){
								
								oldData[i].paymoney = value;
							}
					
						}
						everyFun()
						
					}
			 	 
			});	
	
			//调单
			$(".adjustOrder").click(function() {
					if(!checkPermissionStatus("采购付款单-保存1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
						
					}
				eventFlag = true;
	
			 	if(sessionStorage.paymentDiaoDanData || sessionStorage.paymentDiaoDanData!= "[]") {
					sessionStorage.removeItem('paymentDiaoDanData');
				}
			
			
				var company = $(".unit").attr('data-id');
		
				if (company === undefined || company == ""){
						parent.layer.open({
							title: "提示",
							content: '请选择往来单位!',
							zIndex: layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
					
						return;
				}
								
				sessionStorage.receiptUnit =company;
				
				
				parent.layer.open({
					type: 2 //此处以iframe举例
						,
					title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">入库核价单</span>',
					area: ['85%', '90%'],
					offset: "rb",
					content: 'views/financiaManagement/payment/order.html',
					zIndex: layer.zIndex //重点1
						,
					success: function(layero) {
						parent.layer.setTop(layero); //重点2
						var body = layer.getChildFrame('body', 'index');
						paentIfarame = layero.find("iframe")[0].contentWindow.document;
					},
					cancel: function() {
						
					},
					end: function() { 
						if(sessionStorage.receiptUnit){
							sessionStorage.removeItem("receiptUnit")
						}
						if(sessionStorage.paymentDiaoDanData) {
							if(sessionStorage.paymentDiaoDanData.length>0 && sessionStorage.paymentDiaoDanData!= "[]"){
		
								var diaoDanData = JSON.parse(sessionStorage.paymentDiaoDanData);
								
								var getData = oldData;
								for(var j = 0; j < diaoDanData.length; j++) {
									 var repeat = false;
									for(var i = 0; i < getData.length; i++){
										
										if(diaoDanData[j].ordernum == getData[i].jsnum){
												repeat = true;
												break;

										}
										
									}
									
									  if (!repeat) {
									  		diaoDanData[j].jsnum = diaoDanData[j].ordernum;
									  		diaoDanData[j].paymoney ="0.00";
											oldData.push(diaoDanData[j]);
									   }
							}	
			
								detail(oldData);
								
								
							} else {
								layer.closeAll();
							}
					}}
				});
			});
			
			
			
			
			
		//  修改备注
		$('#updateNomeId').click(function () {
			var checkNum = $(".ordernum").val() + '';
			editComment("采购付款单-保存1", '15', checkNum);
		})
	
	var active = {
		preserve: function() {
					if(!checkPermissionStatus("采购付款单-保存1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
						
					}
				examineData(oldData,0,0)
			
		},
		//审核
		examine: function() { 
					if(!checkPermissionStatus("采购付款单-审核1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
						
					}
			if(eventFlag){
	
				parent.layer.open({
					title: "提示",
					content: '内容发生变化，请保存后再审核',
					zIndex: layer.zIndex //重点1
				,
					success: function(layero) {
						parent.layer.setTop(layero); //重点2
	
					}
				});	
				
			
				return;
			}
			
			
				examineData(oldData,1,0)
			
		},
		//删除
		del: function() { 
					if(!checkPermissionStatus("采购付款单-保存1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
						
					}
			var checkStatus = table.checkStatus('orderTest'),
			data = checkStatus.data;
			
			eventFlag = true;
			
			if (data.length ==0){
				parent.layer.open({
					title: "提示",
					content: '请选择删除数据!',
					zIndex: layer.zIndex //重点1
					,
					success: function(layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
			
				return;
			}
			
			
			oldData =  deleteTwoArrayByKey(oldData,data,"jsnum");


			detail(oldData);
			
		}
	
	
	}
	
	
		//计算合计	
		function everyFun(){
		
			var totalpriceId=0;
			var nomoneyId =0; 
			var paymoneyId =0;
	
					
			for(var i=0;i<oldData.length;i++){
				var totalprice =oldData[i].totalprice;
				var nomoney = oldData[i].nomoney;
				var paymoney = oldData[i].paymoney;
		
				
				if( totalprice != ""&& totalprice !=0){
					totalpriceId= totalpriceId  + Number(totalprice);
				}
				
				if( nomoney != ""&& nomoney !=0){
					nomoneyId= nomoneyId  + Number(nomoney);
				}
				
				if( paymoney != ""&& paymoney !=0){
					paymoneyId= paymoneyId  + Number(paymoney);
				}
		
	
				
				
			}
			
			
			$(".fixStyle #totalpriceId").text(totalpriceId);
			$(".fixStyle #nomoneyId").text(nomoneyId);
			$(".fixStyle #paymoneyId").text(paymoneyId);
	
		
			
		}
		
			
	
	function examineData(data,check,mark){
		
		
			if(data.length==0){
				parent.layer.open({
					title: "提示",
					content: '付款详情不能为空!',
					zIndex: layer.zIndex //重点1
					,
					success: function(layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
			
				return;
			}
		
			var bankid = $("#account").val() ? $("#account").val() : $(".account").attr('data-id');

			if (bankid === undefined || bankid == ""){
				parent.layer.open({
					title: "提示",
					content: '请选择付款账户!',
					zIndex: layer.zIndex //重点1
					,
					success: function(layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
			
				return;
			}
				
				
			
			var agent = $("#salesman").val() ? $("#salesman").val() : $(".salesman").attr('data-id');
			
			if (agent === undefined || agent == ""){
				parent.layer.open({
					title: "提示",
					content: '请选择业务员!',
					zIndex: layer.zIndex //重点1
					,
					success: function(layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
			
				return;
			}
			
			

			var slave = [],totalmoney=0;
			var ispaymoney = false;
			for(var i = 0; i < data.length; i++) {
				
				if(!data[i].paymoney  || data[i].paymoney ==""){
				
					ispaymoney =true;
					break;
		
				}
				
				totalmoney += eval(data[i].paymoney);
			
				slave.push({
					"jsnum": '' + data[i].jsnum + '',
					"lastnum": '' + data[i].lastnum + '',
					"paymoney": '' + data[i].paymoney + '',
					"lasttype": '' + data[i].lasttype + ''
				});
			}
		
		
			if(ispaymoney){
					parent.layer.open({
						title: "提示",
						content: '实付金额不能为空!',
						zIndex: layer.zIndex //重点1
						,
						success: function(layero) {
							parent.layer.setTop(layero); //重点2
						}
					});
					
					return false;
			}

			
			var mynum = $(".mynum").val();
			
			var paydate = $('#addPaymentDate').val();
			
			var company = $(".unit").attr('data-id');
							
			var settlestate = $(".type").val();
			
			var operatorsid = $(".operatorsidname").attr('data-id');
			
			var nomo = $('.notes').val();
			
			var master = {
				'ordernum': $(".ordernum").val(),
				'mynum': '' + mynum + '',
				'paydate': '' + paydate + '',
				'companyid': '' + company + '',
				'bankid': "",
				'accountforprint': bankid,
				'agent': '' + agent + '',
				'operatorSID': '' + operatorsid + '',
				'settlestate': settlestate,
				'totalmoney': totalmoney,
				'nomo': '' + nomo + ''
			};
			
		
		saveAndExamine(master,slave,check,mark)
	}
	
	
			
			
	$(".noExamine").click(function() {
					if(!checkPermissionStatus("采购付款单-审核1")){
					
						parent.layer.open({
							title: "提示",
							content: localStorage.jurisdictionTips,
							zIndex: parent.layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return
						
					}						
		parent.layer.confirm('警告：反审核是高级别操作，确定进行反审核操作？', {
			icon: 3,
			title: '提示'
		}, function(index) {
			$.ajax({
				type: "get",
				url:  localStorage.serIp  +"/WebCheckReturnSaveState?jsoncallback=?",
				dataType: "jsonp",
				async: true,
				data: {
					'userId': localStorage.userId,
					'userPw': localStorage.userPw,
					'database': localStorage.database,
					'orderNum': $(".ordernum").val()
				},
				success: function(res) {
					var data = JSON.parse(res);
					switch(data.type)
					{
						case 1:
							parent.layer.open({
							title: "提示",
							content: '反审核成功',
							zIndex: layer.zIndex, //重点1
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
								initData($(".ordernum").val());
							}
						});
						
//							oprateStatus(0);

					  break;
						case 0:
							parent.layer.open({
								title: "提示",
								content: data.data,
								zIndex: layer.zIndex, //重点1
								success: function(layero) {
									parent.layer.setTop(layero); //重点2
								}
							});
					  break;
					  case 2:
					  		var infoData = JSON.parse(data.data);
							var  info = infoData[0].info;			  		
							parent.layer.open({
							title: "提示",
							content: info,
							zIndex: layer.zIndex, //重点1
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
					  break;
					}
					parent.layer.close(index);
					return;
				
				}
			});
							
		});
	
			
	})
			
		
		
		
			
	/*
	 * 审核和保存公用方法
	 * @param: master 基本数据
	 * @param: slave 产品数据
	 * @param: check 0保存或更新，1审核
	 * @param: mark 首次保存传0，继续保存1
	 */
	function saveAndExamine(master,slave,check,mark){
	
		var uploadData = {
				"userId": localStorage.userId,
				"userPw": localStorage.userPw,
				'database': localStorage.database,
				'groupCompanyId': localStorage.groupcompanyid,
//				'returnMaster': master,
//				'returnSlave': slave,
//				'instockMaster': instockMaster,
//				'instockSlave': instockSlave,
				'check': check,// 0保存或更新，1审核
				"mark": mark //首次保存传0，继续保存1
		}
		
		if(master != ""){
			master =JSON.stringify(master);
			uploadData.master = master;
		}
		
		if(slave != ""){
			slave = JSON.stringify(slave);
			uploadData.slave = slave;

		}
		
				var jiazaiIndex;
						parent.layer.open({
						  	type: 3, 
						  	zIndex: parent.layer.zIndex, //重点1
						  	success: function(layero, index){
						  		jiazaiIndex = index;
				  			}
						});
						


		$.ajax({
			type: "post",
			url:  localStorage.serIp  +"/WebOperateMbPayMoneyTable",
			async: true,
			dataType: 'json',
			contentType:'application/json; charset=utf-8',
			crossDomain:true,
			data: JSON.stringify(uploadData),
			success: function(res) {
														parent.layer.close(jiazaiIndex);

				var data = JSON.parse(res);
				switch(data.SaveState.state)
				{
				case 0:
					parent.layer.open({
						title: "提示",
						content: data.SaveState.result,
						zIndex: layer.zIndex ,//重点1,
						success: function(layero) {
							parent.layer.setTop(layero); //重点2
						
						}
					});
	
					return;
					 break;
				case 1:								
					
					if(data.CheckState.state == 2) {  //保存
						eventFlag = false;

						parent.layer.open({
							title: "提示",
							content: '保存成功',
							zIndex: layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2

//								initData(data.SaveState.result);			

							}
						});
						$(".layui-show", parent.document).attr("lay-item-id","FKHJDH"+data.SaveState.result);

							oprateStatus(0);
						return;
					} 
					
					if(data.CheckState.state == 1) {
						
						
						
						parent.layer.open({
								title: "提示",
								content: '审核成功',
								zIndex: layer.zIndex //重点1
								,
				
							});	
//							initData(data.SaveState.result);
							oprateStatus(1);
								
						return;
					} 
					
					if(data.CheckState.state == 0) {
						parent.layer.open({
							title: "提示",
							content: '审核失败',
							zIndex: layer.zIndex //重点1
							,
							success: function(layero) {
								parent.layer.setTop(layero); //重点2
							}
						});
						return;
					} 
					
					if(data.CheckState.state == 3) {
						
						if(sessionStorage.shengheErrorData) {
							if(sessionStorage.shengheErrorData.length>0 && sessionStorage.shengheErrorData!= "[]"){
								sessionStorage.removeItem("shengheErrorData")
							}
						}
		
						sessionStorage.shengheErrorData = data.CheckState.result;
						
						parent.layer.open({
							type: 2 
								,
							title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">信息</span>',
							area: ['60%', '65%'],
		
							content: 'views/public/shengheerror.html',	
		
							zIndex: layer.zIndex //重点1
								,
							success: function(layero,index) {
								parent.layer.setTop(layero); //重点2
								var body = layer.getChildFrame('body', 'index');
								paentIfarame = layero.find("iframe")[0].contentWindow.document;
											
							},
							end: function(layero,index) {
								if(sessionStorage.shengheErrorData) {
										if(sessionStorage.shengheErrorData.length>0 && sessionStorage.shengheErrorData!= "[]"){
											sessionStorage.removeItem("shengheErrorData")
										}
									}
									parent.layer.close(index);
								}
						});
						

						return;
					
					
						
					}
					
				  break;
				case 9:
			
							if(sessionStorage.shouyingzizhiData) {
								if(sessionStorage.shouyingzizhiData.length>0 && sessionStorage.shouyingzizhiData!= "[]"){
									sessionStorage.removeItem("shouyingzizhiData")
								}
							}
				
							sessionStorage.shouyingzizhiData = data.SaveState.result;
							
							parent.layer.open({
								type: 2 
									,
								title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">首营资质</span>',
								area: ['60%', '65%'],
			
								content: 'views/public/shouYingZiZhi.html',	
			
								zIndex: layer.zIndex //重点1
									,
								success: function(layero,index) {
									parent.layer.setTop(layero); //重点2
									var body = layer.getChildFrame('body', 'index');
									paentIfarame = layero.find("iframe")[0].contentWindow.document;
								
									
									
									$(".save", paentIfarame).click(function() {
										parent.layer.close(index); //再执行关闭     
										saveAndExamine(master,slave,check,1);
										
									})
									
								},
								end: function(layero,index) {
									if(sessionStorage.shouyingzizhiData) {
										if(sessionStorage.shouyingzizhiData.length>0 && sessionStorage.shouyingzizhiData!= "[]"){
											sessionStorage.removeItem("shouyingzizhiData")
										}
									}
									parent.layer.close(index);
								}
							});
				  break;
				}
								
			}
			,
			error: function(res) {
				parent.layer.close(jiazaiIndex);
					
					parent.layer.open({
						title: "提示",
						content: '服务器异常!',
							zIndex: parent.layer.zIndex //重点1
			
					});
				
		
			}
		});
		
	}	
			
		});
	</script>
	<script src="../../../js/jquery.js" type="text/javascript"></script>
	<script type="text/javascript" src="../../../js/comboselect.js"></script>
	<script type="text/javascript" src="../../../js/b.comboselect.js"></script>

</html>