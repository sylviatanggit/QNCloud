<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>发票申请中详情</title>
	<link rel="stylesheet" type="text/css" href="../../../css/comboselect.css" />
	<link rel="stylesheet" type="text/css" href="../../../css/demo.css" />
	<link rel="stylesheet" href="../../../plugins/layui/css/layui.css">
	<link href="../../../css/font-awesome.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="../../../css/qk/danju_pulic.css" />
	<!-- DevExtreme themes -->
	<link rel="stylesheet" href="../../../devexpresslibrary/css/dx.common.css">
	<link rel="stylesheet" href="../../../devexpresslibrary/css/dx.light.css">
	<!-- confirm -->
	<link rel="stylesheet" href="../../../devexpresslibrary/css/jquery.my-modal.1.1.winStyle.css">

</head>
<style type="text/css">
	input,
	section,
	button,
	select {
		border-radius: 2px;
	}

	.addAllocation {
		font-family: "PingFang SC" !important;
		font-size: 9pt !important;
		color: #232323 !important;
		margin: 0 20px;
		margin-top: 20px;
	}

	.layui-input-block,
	.layui-input-block input,
	.layui-input-block label,
	.layui-input-block select {
		line-height: 28px !important;
		height: 28px !important;
		min-height: 28px !important;
	}

	.layui-form-label {
		line-height: 28px !important;
	}


	.layui-input-block select {
		cursor: pointer;
	}

	.layui-input-block option {
		cursor: pointer;
	}

	.addAllocation .layui-table td,
	.layui-table th {
		font-size: 9pt !important;
	}

	.btns {
		margin-bottom: 12px;
		position: absolute;
		right: 20px;
		top: 114px;
	}


	.btns button {
		cursor: pointer;
		border: none;
		width: 90px;
		height: 28px;
		line-height: 28px;
		border-radius: 2px;
		background-color: #2D89DD;
		color: #FFFFFF;
	}

	.layui-input-block {
		min-height: 22px;
	}

	.two_inputs {
		padding-top: 12px;
		background-color: #EFF5FF;
		margin-top: 50px;
		padding-bottom: 5px;
	}

	.moreAction {
		width: 90px !important;
	}

	.action {
		width: 88px !important;
		right: 0;
	}

	.show,
	.hide {
		padding: 1px 10px;
		background-color: #1E9FFF;
		text-align: center;
		position: absolute;
		top: 138px;
		right: 50%;
		cursor: pointer;
	}

	.hide {
		display: none;
	}

	.title {
		margin-top: 12px;
	}


	.cs_container,
	.cs_container_open .cs_input,
	.cs_result_area {
		width: 250px !important;
	}

	div.cs_result_area div.pagination li {
		margin: 0 4px !important;
	}

	.layui-table-cell select {
		display: block;
	}

	.laytable-cell-1-producename {
		width: 200px !important;
	}

	.layui-table-cell select {
		display: block;
	}

	.layui-table-edit {
		line-height: 22px !important;
		height: 22px !important;
	}

	.fixStyle ul {
		border: 1px solid #ccc;
	}

	input {
		font-size: 9pt;
	}

	.fixStyle ul li {
		float: left;
		padding-left: 6px;
	}

	.yibohui,
	.yitongyi {
		display: none;
		position: absolute;
		height: 50px;
		top: 20px;
		left: 150px;
	}

	table thead td {
		padding: 0;
		border-left: 1px solid #CAD3DA;
		background: #DFEBFB;
	}

	table tbody tr:nth-child(even) {
		background: #E7EFF9;
	}

	.clearfix:after {
		content: '.';
		height: 0;
		display: block;
		clear: both;
	}

	#lay-ignore {
		height: 25px;
		width: 60px;

	}

	#lay-ignore {
		height: 25px;
		width: 60px;

	}

	tbody tr:not(:last-child):hover {
		background-color: rgba(137, 207, 240, .6) !important;
	}

	.dx-datagrid-rowsview .dx-selection.dx-row>td {
		background-color: yellow !important;
	}

	.changetotalprice {
		background-color: rgb(255, 200, 200);
	}

	.changeproducecount {
		background-color: rgb(211, 236, 198);
	}

	.changestate {
		background-color: rgb(201, 242, 241);
	}

	.dx-datagrid-header-panel {
		display: none;
	}
	table{
		font-size: 9pt;
	}
	table thead td {
    padding: 0;
    border-left: 1px solid #CAD3DA;
    background: #DFEBFB;
	
}
table tbody tr:nth-child(even) {
    background: #E7EFF9;
}

	#lay-ignore {
      height: 25px;
      width: 60px;
    
    }
     #lay-ignore {
      height: 25px;
      width: 60px;
     
	}
	tbody tr:not(:last-child):hover{
	background-color: rgba(137, 207, 240,.6)!important;
}

.dx-datagrid-rowsview .dx-selection.dx-row > td{
	background-color: yellow!important;
}
	 .m-modal {
		z-index: 9999;
	}
   .background{
	   width: 800px;
	   height: 600px;
	   background-color: grey;
   }

	div#gridModalContainer {
		 height: 500px;
		position: absolute;
		top: 30%;
		left: 30%;
		width: 800px!important;
		z-index: 9999;
	} 
</style>

<body>
	<div class="addAllocation">
		<div class="layui-tab">
			<div class="header1">
				<p style="color: #232323 !important;font-size: 24px !important;margin-top: 30px;">发票申请<img class="yibohui" src="/QNCloud/image/已驳回.png"
					 alt="" /><img class="yitongyi" src="/QNCloud/image/已同意.png" alt="" /></p>
				<ul>
					<li>
						<label class="layui-form-label">申请日期</label>
						<div class="layui-input-block">
							<input name="title" lay-verify="title" placeholder="" readonly="readonly" autocomplete="off" id="applydate"
							 class="layui-input applydate" type="text">
						</div>
					</li>
					<li>
						<label class="layui-form-label">发票申请单号</label>
						<div class="layui-input-block">
							<input name="title" lay-verify="title" autocomplete="off" readonly="readonly" class="layui-input ordernum" type="text"
							 disabled="disabled" value="">
						</div>
					</li>
				</ul>
			</div>
			<div class="header2">
				<div class="btns">
					<button class="layui-btn getAllProduct">产品详情</button>
					<button class="layui-btn qianshou">同意</button>
					<button class="layui-btn bohui">驳回</button>
					<button class="layui-btn moreAction">更多操作</button>
					<ul class="action">
						<li id="print">
							<a class="print" data-type="printData" lay-event='printData'>打印单据</a>
						</li>
					</ul>
				</div>

				<div class="two_inputs">
					<div style="width: 100%;height: auto;">
						<div class="layui-inline selectKung">
							<label class="layui-form-label">往来单位</label>
							<div>
								<input name="title" lay-verify="title" autocomplete="off" disabled="disabled" class="layui-input unit" type="text"
								 value="" style="width: 250px;height: 28px;line-height: 28px;">
							</div>
						</div>


						<div class="layui-inline">
							<label class="layui-form-label">申请人</label>
							<div class="layui-input-inline" style="width: 160px;">
								<input name="title" lay-verify="title" autocomplete="off" 　disabled="disabled" style="padding-left: 5px;margin-left: 0px;"
								 class="layui-input applyname" type="text" value="" readonly="readonly">
							</div>
						</div>

						<div class="layui-inline">
							<label class="layui-form-label">备　　注</label>
							<div class="layui-input-inline">
								<input name="title" lay-verify="title" autocomplete="off" class="layui-input notes" type="text" style="width: 345px;"
								 style="margin-left: 0px;" placeholder="给总公司财务留言">
							</div>
						</div>
					</div>
				</div>
			</div>
			<p class="title">申请详情</p>
			<table id="addAllocation" lay-filter="demo">
				<div id="gridContainer"></div>
			</table>
		</div>
	</div>
	<input type="hidden" value="linkordernumId" />

	<div class="m-modal">
         <div class="background"></div>
			<div id="gridModalContainer"></div>
		</div>
</body>
<script src="../../../js/jquery.js" type="text/javascript"></script>
<!-- DevExtreme library -->
<script src="../../../devexpresslibrary/js/dx.all.js"></script>
<script src="../../../plugins/layui/layui.js"></script>
<script src="../../../js/public.js"></script>

<!-- 弹框插件 -->
<script src="../../../devexpresslibrary/js/jquery.my-modal.1.1.js"></script>
<script>
	var scanCodeOutStore;
	var applymodel; var applystate;
	layui.use(['table', 'jquery', 'laydate'], function () {
		var table = layui.table;
		var $ = layui.jquery;
		var laydate = layui.laydate;
		var oldData = [];
		var eventFlag = false;

		$('.moreAction').hover(function () {
			$(".action").show();
		}, function () {
			$(".action").hide();
		});
		$('.action').hover(function () {
			$(".action").show();
		}, function () {
			$(".action").hide();
		});
		$(".show").click(function () {
			$(".show").hide();
			$(".hide").show();
			$(".two_inputs").hide();
			$(".title").css("margin-top", "54px");
		});


		$(".hide").click(function () {
			$(".hide").hide();
			$(".show").show();
			$(".two_inputs").show();
			$(".title").css("margin-top", "12px");
		});


         var index11;


		$("body").delegate(".qianshou ", "click", function () {
			if (!checkPermissionStatus("直销发票签出单-初审1")) {

				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return

			}


			if (localStorage.groupcompanyid == "0" && localStorage.allowCompanyCount != 0) {
				parent.layer.open({
					title: "提示",
					content: "总公司账号，不能同意直销申请单！",
					zIndex: parent.layer.zIndex,//重点1,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
						parent.layer.close(index11); //再执行关闭   
					}
				});

				return;
			}

			parent.layer.confirm('确认同意吗？', {
				icon: 3, zIndex: parent.layer.zIndex, //重点1
				title: '提示'
			}, function (index) {

				var master = [];
				for (var i = 0; i < oldData.length; i++) {
					var ordernum = oldData[i].ordernum;
					var recheckstatenomo = oldData[i].recheckstatenomo;
					master.push({
						"ordernum": '' + ordernum + '',
						"recheckstatenomo": '' + recheckstatenomo + ''
					});

				}
				var notes = $(".notes").val();

				var jiazaiIndex;
				parent.layer.open({
					type: 3,
					zIndex: parent.layer.zIndex, //重点1
					success: function (layero, index) {
						jiazaiIndex = index;
					}
				});


				$.ajax({
					type: "post",
					url: localStorage.serIp + "/WebAgreeInvoiceApplyStatus",
					crossDomain: true,
					contentType: 'application/json; charset=utf-8',
					data: JSON.stringify({
						'userId': localStorage.userId,
						'userPw': localStorage.userPw,
						'database': localStorage.database,
						'ordernum': $(".ordernum").val(),
						'master': JSON.stringify(master),
						'type': applystate,
						'mono': notes,
						'applymodel': applymodel,
						'groupCompanyId': localStorage.groupcompanyid

					}),
					success: function (res) {
						parent.layer.close(jiazaiIndex);
						var data = JSON.parse(res);
						if (data.ResultValue == "1") {
							parent.layer.open({
								title: "提示",
								content: "成功!",
								zIndex: parent.layer.zIndex,//重点1,
								success: function (layero) {
									parent.layer.setTop(layero); //重点2										
								}
							});

							initData($(".ordernum").val());
						} else {

							parent.layer.open({
								title: "提示",
								content: data.ResultValue,
								zIndex: parent.layer.zIndex,//重点1,
								success: function (layero) {
									parent.layer.setTop(layero); //重点2

								}
							});

						}


					}
					,
					error: function (res) {
						parent.layer.close(jiazaiIndex);
						parent.layer.open({
							title: "提示",
							content: '服务器异常!',
							zIndex: parent.layer.zIndex //重点1

						});


					}
				});

			}

			);


		})

		$("body").delegate(".bohui ", "click", function () {

			if (!checkPermissionStatus("直销发票签出单-初审1")) {

				parent.layer.open({
					title: "提示",
					content: localStorage.jurisdictionTips,
					zIndex: parent.layer.zIndex //重点1
					,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
					}
				});
				return

			}


			if (localStorage.groupcompanyid == "0" && localStorage.allowCompanyCount != 0) {
				parent.layer.open({
					title: "提示",
					content: "总公司账号，不能驳回直销申请单！",
					zIndex: parent.layer.zIndex,//重点1,
					success: function (layero) {
						parent.layer.setTop(layero); //重点2
						parent.layer.close(index11); //再执行关闭   
					}
				});

				return;
			}

			parent.layer.open({
				type: 2 //此处以iframe举例
				,
				title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px">驳回原因</span>',
				area: ['450px', '300px'],
				content: 'views/stockManagement/allocation/rejectnomo.html',
				zIndex: parent.layer.zIndex, //重点1
				success: function (layero, index11) {
					index11 = index11;
					parent.layer.setTop(layero); //重点2
					var body = layer.getChildFrame('body', 'index');
					paentIfarame = layero.find("iframe")[0].contentWindow.document;

					$(".bohui", paentIfarame).click(function () {

						var rejectnomo = $(".rejectnomo", paentIfarame).val();


						parent.layer.confirm('确认驳回吗？', {
							icon: 3, zIndex: parent.layer.zIndex, //重点1
							title: '提示'
						}, function (index) {

							var master = [];
							for (var i = 0; i < oldData.length; i++) {
								var ordernum = oldData[i].ordernum;
								var recheckstatenomo = oldData[i].recheckstatenomo;
								master.push({
									"ordernum": '' + ordernum + '',
									"recheckstatenomo": '' + recheckstatenomo + ''
								});

							}



							var jiazaiIndex;
							parent.layer.open({
								type: 3,
								zIndex: parent.layer.zIndex, //重点1
								success: function (layero, index) {
									jiazaiIndex = index;
								}
							});



							$.ajax({
								type: "post",
								url: localStorage.serIp + "/WebRefundInvoiceApplyStatus",
								crossDomain: true,
								contentType: 'application/json; charset=utf-8',
								data: JSON.stringify({
									'userId': localStorage.userId,
									'userPw': localStorage.userPw,
									'database': localStorage.database,
									'ordernum': $(".ordernum").val(),
									'mono': rejectnomo,
									'master': JSON.stringify(master),
									'applymodel': applymodel,
									'type': applystate,
									'groupCompanyId': localStorage.groupcompanyid

								}),
								success: function (res) {
									parent.layer.close(jiazaiIndex);

									var data = JSON.parse(res);
									if (data.ResultValue == "1") {

										parent.layer.open({
											title: "提示",
											content: "驳回成功!",
											zIndex: parent.layer.zIndex,//重点1,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2
												parent.layer.close(index11); //再执行关闭   
											}
										});

										initData($(".ordernum").val());

									} else {

										parent.layer.open({
											title: "提示",
											content: data.ResultValue,
											zIndex: parent.layer.zIndex,//重点1,
											success: function (layero) {
												parent.layer.setTop(layero); //重点2

											}
										});

									}


								}
								,
								error: function (res) {
									parent.layer.close(jiazaiIndex);

									parent.layer.open({
										title: "提示",
										content: '服务器异常!',
										zIndex: parent.layer.zIndex //重点1

									});


								}
							});

						}

						);




					})
				}
			});




		})






		var ordernum = $(".layui-show", parent.document).attr("lay-item-id");
		ordernum = ordernum.substring(6, ordernum.length);
		initData(ordernum);


		//事件监听
		$("input").change(function () {
			eventFlag = true;
		});
		$("select").change(function () {
			eventFlag = true;
		});




		//初始化页面数据
		function initData(ordernum) {

			$.ajax({
				type: "get",
				url: localStorage.serIp + "/WebGetInvoiceApplyInfoByOrder?jsoncallback=?",
				dataType: "jsonp",
				async: true,
				data: {
					'userId': localStorage.userId,
					'userPw': localStorage.userPw,
					'groupCompanyId': localStorage.groupcompanyid,
					'database': localStorage.database,
					'orderNum': ordernum

				},
				success: function (res) {
					var data = JSON.parse(res);
					$("#applydate").val(data[0].applydate.substring(0, 10));
					$(".ordernum").val(data[0].ordernum);
					$(".purchaseMynum").val(data[0].mynum);

					$("#linkordernumId").val(data[0].linkordernum);


					$(".unit").val(data[0].companyname);
					$(".applyname").val(data[0].applyname);
					$(".notes").val(data[0].mono);

					applymodel = data[0].applymodel;	//1联动仓，0自营仓				
					applystate = data[0].applystate;

					if (applymodel == 0 && (data[0].mono == "" || data[0].mono == null)) {
						$(".notes").attr("placeholder", "");
					}

					if (applystate != 0) {  //申请中
						$(".qianshou").css("display", "none");
						$(".bohui").css("display", "none");
					}
					oprateStatus(applystate);
					purshaseData(ordernum);

				}
			});

		}


		function oprateStatus(applystate) {

			switch (applystate) {
				case 1: //待复核
					$(".qianshou").css("display", "none");
					$(".bohui").css("display", "none");
					$(".yitongyi").css("display", 'inline-block');
					$('.getAllProduct').css('display','none');
					break;

				case 2: //已完结
					$(".qianshou").css("display", "none");
					$(".bohui").css("display", "none");
					$(".yitongyi").css("display", 'inline-block');
					break;
				case 3: //已驳回
					$(".qianshou").css("display", "none");
					$(".bohui").css("display", "none");
					$(".yibohui").css("display", 'inline-block');
					break;
			}

		}

     
        
		function purshaseData(ordernum) {
		

			$.ajax({
				type: "get",
				url: localStorage.serIp + "/WebGetOutsettleInfoByInvoiceApplyOrder?jsoncallback=?",
				dataType: "jsonp",
				async: true,
				data: {
					'userId': localStorage.userId,
					'userPw': localStorage.userPw,
					'database': localStorage.database,
					'orderNum': ordernum
				},
				success: function (res) {
					var purshaseData = JSON.parse(res);
					oldData = purshaseData;
					purshaseDetail(purshaseData);
				}
			});

		}

		//产品数据展示
		function purshaseDetail(data) {
			//展示已知数据
			$(function () {
				var dataGrid = $("#gridContainer").dxDataGrid({
					dataSource: data,
					keyExpr: "ordernum",
					showBorders: true,
					paging: {
						pageSize: 200,
					},
					editing: {
						mode: 'batch',
						allowUpdating: true,
					},
					sorting: {
						mode: "none"//none
					},
					selection: {
						mode: "multiple"
					},
					filterRow: {
						visible: false,
						applyFilter: "auto"
					},
					headerFilter: {
						visible: false
					},
					columnAutoWidth: true,
					allowColumnResizing: true,
					columnFixing: {
						enabled: false
					},
					columns: [{
						dataField: "ordernum",
						caption: "备库结算单号",
						allowEditing: false,
						cellTemplate: function (container, options){
							$("<div>")
								.append($("<div style='color: #2D89DD'> " + options.value + "</div>"))
								.appendTo(container);
						}
					},
					{
						dataField: "totalprice",
						caption: "含税金额",
						fixed: true,
						fixedPosition: 'right',
						width: 150,
						allowEditing: false,
						cssClass: 'changetotalprice'
					}, {
						dataField: "producecount",
						caption: "产品数量",
						fixed: true,
						fixedPosition: 'right',
						width: 150,
						allowEditing: false,
						cssClass: 'changeproducecount'
					}, {
						dataField: "recheckstatenomo",
						caption: "复核备注",
						fixed: true,
						fixedPosition: 'right',
						width: 150,
						cssClass: 'changestate',
						cellTemplate: function (container, options) {
							$("<div>")
								.append($("<div> " + options.value + "</div>"))
								.appendTo(container);
						}
					}
					],
					summary: {
						totalItems: [{
							column: "totalprice",
							summaryType: "sum",
							customizeText: function (data) {
								var data = data.value;
								data = data.toFixed(2);
								return data;
							}
						}, {
							column: "producecount",
							summaryType: "sum",
							customizeText: function (data) {
								var data = data.value;
								data = data.toFixed(2);
								return data;
							}
						}
						]
					},
					onContentReady:function(e){
						var updatedData = [];
					   var visibleRows = e.component.getVisibleRows();
					   $.each(visibleRows,function(v,i,arr){
						 updatedData.push(i.data)
					   })
					   oldData = updatedData;
					},
					onCellClick: function (e) {
						var data = e.data;
						if (e.columnIndex == 1 && e.rowType != "header") {
							if (data.lasttype == "0") {
								parent.tab.tabAdd({
									icon: '',
									id: "ZXFPQC" + data.ordernum,
									title: data.ordernum + '直销核价详情',
									url: 'views/financiaManagement/checkOutZX/detailZhiXiaoJs.html'
								});
							}


							if (data.lasttype == "6") {
								parent.tab.tabAdd({
									icon: '',
									id: "BKFPQC" + data.ordernum,
									title: data.ordernum + '直销备库详情',
									url: 'views/financiaManagement/checkOutZX/detailZhiXiaoBeiKuJs.html'
								});
							}


							if (data.lasttype == "7") {
								parent.tab.tabAdd({
									icon: '',
									id: "BKFPQC" + data.ordernum,
									title: data.ordernum + '直销产品详情',
									url: 'views/financiaManagement/checkOutZX/detailZhiXiaoProductOprate.html'
								});
							}
						}
					}
				}).dxDataGrid('instance');
			});
		}



		var viewHeight = $(window).height();
		$('#gridContainer').css('height', viewHeight * 0.67 + 'px');

		$('.addDianJiEvent').on('click', function () {
			var type = $(this).data('type');
			active[type] ? active[type].call(this) : '';
		});
           
      
	//   获取所有数据
	$('.getAllProduct').on('click',function(){
		if (!checkPermissionStatus("直销发票签出单-初审1")) {
			parent.layer.open({
				title: "提示",
				content: localStorage.jurisdictionTips,
				zIndex: parent.layer.zIndex //重点1
				,
				success: function (layero) {
					parent.layer.setTop(layero); //重点2
				}
			});
			return;
		}

		if (ordernum) {
			sessionStorage.ordernum = JSON.stringify(ordernum);
		}


	       parent.layer.open({
						type: 2 //此处以iframe举例
							,
						title: '<img width="20px" src="image/logo.png" alt="" /><span style="margin-left:10px" ' + 'data-ordernum=' + ordernum + ' >【'+ordernum+'】详情</span>',
						area: ['85%', '90%'],
						 offset: "rb",
						content: 'views/financiaManagement/checkOutZX/productList.html',
						zIndex: parent.layer.zIndex, //重点1,
						success: function(layero) {
							parent.layer.setTop(layero); //重点2
							var body = layer.getChildFrame('body', 'index');
							paentIfarame = layero.find("iframe")[0].contentWindow.document;
							
							$(".editGuige_seach_btn",paentIfarame).attr("name",1)
						},
						end: function() {
							if(sessionStorage.ordernum){
								sessionStorage.removeItem("ordernum");
							}
							// getList();
						}
					});
	  });

		

	});


	
</script>

</html>